(()=>{var e=3553,n=36160,t=e=>[...new Array(e)].map(((e,n)=>n)),r=2*Math.PI;function o(e,n){let t={};for(let r in e)t[r]=n(e[r],r,e);return t}var a=(e,n)=>[e[0]*n,e[1]*n,e[2]*n],i=(e,n=1)=>a(e,n/(e=>Math.hypot(e[0],e[1],e[2]))(e)),f=(e,n)=>[e[0]-n[0],e[1]-n[1],e[2]-n[2]],c=(e,n)=>[e[1]*n[2]-e[2]*n[1],e[2]*n[0]-e[0]*n[2],e[0]*n[1]-e[1]*n[0]],l=[0,1,0],u=(e,n)=>e.map(((r,o)=>t(4).reduce(((t,r)=>t+n[o-o%4+r]*e[o%4+4*r]),0))),s=(e,n)=>e.map((e=>n*e)),v=e=>e[0]+e[5]+e[10]+e[15],m=(e,n,...t)=>{const r=s(n,e);return t.length?((e,n)=>e.map(((e,t)=>e+n[t])))(r,m(...t)):r};var h=t(16).map((e=>e%5?0:1));function g(e,n){let[t,r,o]=e;const a=Math.sqrt(t*t+r*r+o*o);t/=a,r/=a,o/=a;const i=Math.cos(n),f=Math.sin(n),c=1-i;return[t*t+(1-t*t)*i,t*r*c+o*f,t*o*c-r*f,0,t*r*c-o*f,r*r+(1-r*r)*i,r*o*c+t*f,0,t*o*c+r*f,r*o*c-t*f,o*o+(1-o*o)*i,0,0,0,0,1]}function d(e,n){const[t,r,o]=n,a=t*e[3]+r*e[7]+o*e[11]+e[15];return[(t*e[0]+r*e[4]+o*e[8]+e[12])/a,(t*e[1]+r*e[5]+o*e[9]+e[13])/a,(t*e[2]+r*e[6]+o*e[10]+e[14])/a]}var p={at:3,norm:3,uv:3};var b=(e,n)=>{for(let t of n.verts)t.at=d(e,t.at)};function x(e){let n=0;return[0,...e.map((e=>n+=e.length))]}function F(e,n,t){let r=new Array(e*n*2),o=new Array((e+1)*(n+1)),a=e+1;for(let r=0;r<=e;r++)for(let e=0;e<=n;e++)o[e*a+r]={at:t(r,e),uv:[r,e,0,0],ind:e*a+r};for(let t=0;t<e;t++)for(let i=0;i<n;i++){const n=2*(i*e+t),f=i*a+t;r[n]=[o[f+1+a],o[f+a],o[f]],r[n+1]=[o[f+1],o[f+1+a],o[f]]}return{faces:r,verts:o}}var y,M=(e,n)=>(t,o)=>{let a=(e=>[Math.cos(e),Math.sin(e)])(r/n*t);return[a[0]*e[o][0],a[1]*e[o][0],e[o][1]]},w=e=>{let[n,t]=[2*e(),0],r=[[0,0]],o=1;for(;e(5)||0==r.length;)r.push([n,t]),1==o&&(n*=.9-.4*e()),0!=o&&(t+=e()**2*2*n),o=e(4);return r.push([0,t]),r};function D(e,n){let t=`#version 300 es\nprecision highp float;\nprecision highp int;\n\n${n}`;const r=y.createShader(e);y.shaderSource(r,t),y.compileShader(r);{const e=y.getShaderInfoLog(r);e&&(console.log("shader:",e),console.log(t.split("\n").map(((e,n)=>`${n+1}. ${e}`)).join("\n")))}return r}function T(e,n){var t=y.createProgram();return y.attachShader(t,D(35633,e)),y.attachShader(t,D(35632,n)),y.linkProgram(t),t}var E=[5121,6408],A=[5123,6402,33189];var P={5124:"i",5125:"ui",5126:"f",35676:"Matrix4fv"};function S(e){const n={};for(let t=0;t<y.getProgramParameter(e,y.ACTIVE_UNIFORMS);++t){const r=y.getActiveUniform(e,t);console.log(r.name,r.type.toString(16));let o=P[r.type]||"i";const a=y.getUniformLocation(e,r.name);o.indexOf("Matrix")>=0?n[r.name]=(...e)=>y[`uniform${o}`](a,!1,...e):n[r.name]=(...e)=>y[`uniform${e.length}${o}`](a,...e)}return console.log(n),n}function I(e,n,t,r=3){let o=y.getAttribLocation(e,n);y.enableVertexAttribArray(o),y.bindBuffer(34962,t),y.vertexAttribPointer(o,r,5126,!1,0,0)}function $(){return y.createBuffer()}function _(e,n,t=34962){y.bindBuffer(t,e),y.bufferData(t,n,35044)}var B={fMain:"uniform float t;\n\nflat in vec3 normal;\nin vec4 fuv;\n\nlayout(location = 0) out vec4 c0;\nlayout(location = 1) out vec4 c1;\n\nvoid main() {\n  float light = dot(normal, normalize(vec3(-1.,-2.,3.))) + 0.5;\n  light += fract(fuv.y)>0.1 && fract(fuv.y)<0.9 && fract(fuv.x)>0.1 && fract(fuv.x)<0.9 && fract(fuv.y*10.)>0.3 && fract(fuv.x*10.)>0.3?-1.:.0;\n  /*if(mod(uv.x,0.2)<0.1 != mod(uv.y,0.2)<0.1)\n    light /= 2.;*/\n  c0 = vec4(vec3(light), 1.);\n  c1 = vec4(gl_FrontFacing?0.:1.,0.,0.,0.);\n}\n",vMain:"uniform mat4 camera;\r\n\r\nin vec3 at;\r\nin vec3 norm;\r\nin vec4 uv;\r\n\r\nout vec4 fuv;\r\nflat out vec3 normal;\r\n\r\nvoid main() {\r\n  vec4 glpos = camera * vec4(at, 1.);\r\n  glpos.y = -glpos.y;\r\n  gl_Position = glpos / glpos.w;\r\n  //int i = gl_VertexID % 6;\r\n  //uv = vec2(foo[i * 2], foo[i * 2 + 1]);\r\n  fuv = uv;\r\n  normal = norm;\r\n}",fScreen:"uniform sampler2D T0;\nuniform sampler2D T1;\nuniform sampler2D Depth;\n\nout vec4 c;\n\nint b16[16] = int[] (1, 9, 3, 11, 13, 5, 15, 7, 4, 12, 2, 10, 16, 8, 14, 6);\nint b64[64] = int[] (1, 33, 9, 41, 3, 35, 11, 43, 49, 17, 57, 25, 51, 19, 59, 27, 13, 45, 5, 37, 15, 47, 7, 39, 61, 29, 53, 21, 63, 31, 55, 23, 4, 36, 12, 44, 2, 34, 10, 42, 52, 20, 60, 28, 50, 18, 58, 26, 16, 48, 8, 40, 14, 46, 6, 38, 64, 32, 56, 24, 62, 30, 54, 22);\n\nvoid main() {\n  ivec2 F = ivec2(gl_FragCoord.xy);\n  c = vec4(0.);\n  float depth = texelFetch(Depth, F, 0).r;\n  float lut;\n\n  if(depth == 1.) {\n    lut = 1.;\n  } else {\n    float lit = texelFetch(T0, F, 0).r;\n\n    float diff = 0.;\n    for(int i = 0; i < 8; i++) {\n      int step = i/4;\n      float edge = texelFetch(Depth, F + ivec2(i % 2, i % 4 / 2)*step, 0).r + texelFetch(Depth, F - ivec2(i % 2, i % 4 / 2)*step, 0).r - depth * 2.;\n      diff += abs(edge);\n    }\n\n    if(diff > .00007) {\n      //lut = lit>0.1?0.:1.;\n      lut = 0.;\n    } else {\n      lut = lit * 65. > float(b64[F.y % 8 * 8 + F.x % 8]) ? 1. : 0.;\n      //lut = lit * 15. > float(b16[F.y % 4 * 4 + F.x % 4]) ? 1. : 0.;\n      //lut = lit;\n    }\n  }\n\n  c.rgb = vec3(lut);\n\n  //c.rgb = texelFetch(T0, F, 0).rgb;\n\n  /*if(texelFetch(T1, F, 0).r == 1.)\n    c.rgb = vec3(0., 0., 1.);*/\n  c.a = 1.;\n}",vScreenQuad:"void main() {\n  int i = gl_VertexID;\n  gl_Position = vec4(i%2*2-1, 1-(i+1)%4/2*2, 0., 1.);\n}"},R=1600,U=document.getElementById("C");U.width=R,U.height=800,(y=U.getContext("webgl2")).enable(2929);var C=Date.now(),L=T(B.vMain,B.fMain),V=S(L),k=T(B.vScreenQuad,B.fScreen),N=S(k),{bufs:O,elements:Q}=function(){let e=[],n=function(e){0<e&&e<1&&(e=~~(1e9*e));let n=n=>~~(Math.sin(++e)**2*1e9%n)*(n<0?-1:1);return t=>-1==t?e:null==t?n(1e9)/1e9:n(t)}(1);(function(){for(let t=0;t<1e4;t++){let t=w(n),r=3+~~n(10);e.push(F(r,t.length-1,M(t,r)))}})(),function(){for(let r of e){let e=u([1,0,0,0,0,1,0,0,0,0,1,0,(t=[n(200)-100,n(100),0])[0],t[1],t[2],1],g([0,0,1],6*n()));b(e,r)}var t}(),e.forEach((e=>function(e){for(let n of e.faces)n[2].norm=n[2].norm||i(c(f(n[1].at,n[0].at),f(n[2].at,n[0].at)))}(e)));let t=p,r=function(e,n){let t=e.length,r=x(e.map((e=>e.faces))),a=x(e.map((e=>e.verts))),i=new Uint32Array(3*r[t]),f=o(n,((e,r)=>new Float32Array(a[t]*n[r])));e.forEach(((e,n)=>e.faces.forEach((e=>i.set(e.map((e=>e.ind+r[n])),3)))));for(let t in f){let r=n[t],o=f[t];1==r?e.forEach(((e,n)=>e.verts.forEach((e=>o[e.ind+a[n]]=e[t])))):e.forEach(((e,n)=>{for(let r of e.verts)r[t]&&o.set(r[t],r.ind+a[n])}))}return{faces:i,verts:f}}(e,t),a=function(e=p){return{faces:$(),verts:o(e,(e=>$())),attrs:e}}(t);return function(e,n){_(e.faces,n.faces,34963);for(let t in n.verts)_(e.verts[t],n.verts[t])}(a,r),console.log(`${Date.now()-C} ms ${r.faces.length} faces`),{shapes:e,elements:r,bufs:a}}(),j=[E,E,A].map((n=>function(n,t,r,o){const a=y.createTexture();return y.bindTexture(e,a),y.texImage2D(e,0,r[2]||r[1],n,t,0,r[1],r[0],o),y.texParameteri(e,10241,9728),y.texParameteri(e,10240,9728),y.bindTexture(e,null),{texture:a,format:r}}(R,800,n))),q=function(t){const r=y.createFramebuffer();y.bindFramebuffer(n,r);for(let r=0;r<t.length;r++){let o=t[r].format[1],a=34041==o?33306:6402==o?36096:36064+r;y.framebufferTexture2D(n,a,e,t[r].texture,0)}return y.bindFramebuffer(n,null),r}(j),z=50*Math.PI/180,X=((e,n,t=l)=>((e,n,t=l)=>{const r=i(a(n,-1)),o=i(c(t,r)),f=c(o,r);return[o[0],o[1],o[2],0,f[0],f[1],f[2],0,r[0],r[1],r[2],0,e[0],e[1],e[2],1]})(e,f(n,e),t))([0,-20,20],[0,30,0],[0,0,1]),Y=((e,n,t,r)=>{const o=1/Math.tan(.5*e),a=1/(t-r);return[o/n,0,0,0,0,o,0,0,0,0,(t+r)*a,-1,0,0,t*r*a*2,0]})(z,2,2,200),G=u(Y,function(e){const n=u(e,e),t=u(e,n),r=u(n,n),o=v(e),a=v(n),i=v(t),f=(o**4-6*a*o*o+3*a*a+8*i*o-6*v(r))/24;let c=m((o*o*o-3*o*a+2*i)/6,h,-(o*o-a)/2,e,o,n,-1,t);return s(c,1/f)}(X));function H(){C=Date.now(),y.useProgram(L),V.camera(G),y.bindFramebuffer(n,q),y.drawBuffers([36064,36065]),y.clear(256),y.bindBuffer(y.ELEMENT_ARRAY_BUFFER,O.faces),y.drawElements(4,Q.faces.length/3,5125,0),y.useProgram(k),function(n,t){for(let r=0;r<n.length;r++)y.activeTexture(y.TEXTURE0+r),t[r]&&t[r](r),y.bindTexture(e,n[r].texture)}(j,[N.T0,N.T1,N.Depth]),y.bindFramebuffer(n,null),y.drawArrays(4,0,6),y.flush(),console.log(`Rendered in ${Date.now()-C} ms`)}!function(e,n){for(let t in e.verts)I(n,t,e.verts[t],e.attrs[t])}(O,L),window.onclick=H,H()})();