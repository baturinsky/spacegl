(()=>{var n,e=3553,t=36160;function r(e,t){let r=`#version 300 es\nprecision highp float;\nprecision highp int;\n\n${t}`;const a=n.createShader(e);n.shaderSource(a,r),n.compileShader(a);{const e=n.getShaderInfoLog(a);e&&(console.log("shader:",e),console.log(r.split("\n").map(((n,e)=>`${e+1}. ${n}`)).join("\n")))}return a}function a(e,t){var a=n.createProgram();return n.attachShader(a,r(35633,e)),n.attachShader(a,r(35632,t)),n.linkProgram(a),a}var o=[5121,6408],i=[5123,6402,33189];function c(e){const t={},r={5124:"i",5125:"ui",5126:"f",35676:"Matrix4fv"};for(let a=0;a<n.getProgramParameter(e,n.ACTIVE_UNIFORMS);++a){const o=n.getActiveUniform(e,a);console.log(o.name,o.type.toString(16));let i=r[o.type]||"i";const c=n.getUniformLocation(e,o.name);i.indexOf("Matrix")>=0?t[o.name]=(...e)=>n[`uniform${i}`](c,!1,...e):t[o.name]=(...e)=>n[`uniform${e.length}${i}`](c,...e)}return console.log(t),t}function l(e,t,r=34962){n.bindBuffer(r,e),n.bufferData(r,t,35044)}function f(e,t,r,a=3){let o=n.getAttribLocation(e,t);n.enableVertexAttribArray(o),n.bindBuffer(34962,r),n.vertexAttribPointer(o,a,5126,!1,0,0)}var u=n=>[...new Array(n)].map(((n,e)=>e)),m=2*Math.PI,v=Math.random;function h(n,e,t){let r=[],a=[],o=[],i=n+1;for(let c=0;c<=n;c++)for(let l=0;l<=e;l++){let f=l*i+c;if(a[f]=t(c,l),o[f]=[c,l,0,0],c<n&&l<e){const e=2*(l*n+c);r[e]=[f+1+i,f+i,f],r[e+1]=[f+1,f+1+i,f]}}return[r,a,null,o]}var s=(n,e)=>(t,r)=>{let a=y(m/e*t);return[a[0]*n[r][0],a[1]*n[r][0],n[r][1]]},g=()=>{let[n,e]=[2*v(),0],t=[[0,0]],r=0;for(;v()>.2||0==t.length;)t.push([n,e]),0!=r&&(n*=.9-v()/2),1!=r&&(e+=3*v()*n),r=~~(3*v());return t.push([0,e]),t};for(let n of u(10))console.log(g());var d=(n,e)=>[n[0]*e,n[1]*e,n[2]*e],p=(n,e=1)=>d(n,e/(n=>Math.hypot(n[0],n[1],n[2]))(n)),x=(n,e)=>[n[0]+e,n[1]+e,n[2]+e],F=(n,e)=>[n[0]-e[0],n[1]-e[1],n[2]-e[2]],b=(n,e)=>[n[1]*e[2]-n[2]*e[1],n[2]*e[0]-n[0]*e[2],n[0]*e[1]-n[1]*e[0]],y=n=>[Math.cos(n),Math.sin(n)],M=[0,1,0],w=(n,e)=>n.map(((t,r)=>u(4).reduce(((t,a)=>t+e[r-r%4+a]*n[r%4+4*a]),0))),D=(n,e)=>n.map((n=>e*n)),T=n=>n[0]+n[5]+n[10]+n[15],A=(n,e,...t)=>{const r=D(e,n);return t.length?((n,e)=>n.map(((n,t)=>n+e[t])))(r,A(...t)):r};var P=u(16).map((n=>n%5?0:1));var E={fMain:"uniform float t;\n\nflat in vec3 normal;\nin vec4 uv;\n\nlayout(location = 0) out vec4 c0;\nlayout(location = 1) out vec4 c1;\n\nvoid main() {\n  //c0 = vec4(normal*0.5+0.5, 1.);  \n  float light = dot(normal, normalize(vec3(-1.,-2.,3.)));\n  c0 = vec4(vec3(light), 1.);\n  //x = fract(uvw.x);\n  float x;\n  /*if(uv.y>1.)\n    x = fract(uv.x / (2.-uv.y));\n  else\n    x = fract(uv.x);*/\n  //c0 = vec4(fract(uv.x), fract(uv.y), uv.z, 1.);\n  //c1 = vec4(sin(gl_FragCoord.y*.5)+.5, 0., 0., 1.);\n  c1 = vec4(gl_FrontFacing?0.:1.,0.,0.,0.);\n  //c1 = vec4(gl_FrontFacing?0.:1.,0.,0.,0.);\n}\n",vMain:"uniform mat4 camera;\r\n\r\nin vec3 vert;\r\nin vec3 norm;\r\nin vec4 etc;\r\n\r\nout vec4 uv;\r\nflat out vec3 normal;\r\n\r\nvoid main() {\r\n  vec4 glpos = camera * vec4(vert, 1.);\r\n  glpos.y = -glpos.y;\r\n  gl_Position = glpos / glpos.w;\r\n  //int i = gl_VertexID % 6;\r\n  //uv = vec2(foo[i * 2], foo[i * 2 + 1]);\r\n  uv = etc;\r\n  normal = norm;\r\n}",fScreen:"uniform sampler2D T0;\nuniform sampler2D T1;\nuniform sampler2D Depth;\n\nout vec4 c;\n\nint bayer[16] = int[] (1, 9, 3, 11, 13, 5, 15, 7, 4, 12, 2, 10, 16, 8, 14, 6);\nint b64[64] = int[] (1, 33, 9, 41, 3, 35, 11, 43, 49, 17, 57, 25, 51, 19, 59, 27, 13, 45, 5, 37, 15, 47, 7, 39, 61, 29, 53, 21, 63, 31, 55, 23, 4, 36, 12, 44, 2, 34, 10, 42, 52, 20, 60, 28, 50, 18, 58, 26, 16, 48, 8, 40, 14, 46, 6, 38, 64, 32, 56, 24, 62, 30, 54, 22);\n\nvoid main() {\n  ivec2 F = ivec2(gl_FragCoord.xy);\n  c = vec4(0.);\n  float depth = texelFetch(Depth, F, 0).r;\n  float lut;\n\n  if(depth == 1.) {\n    lut = 1.;\n  } else {\n    float lit = texelFetch(T0, F, 0).r;\n\n    float diff = 0.;\n    for(int i = 0; i < 8; i++) {\n      int step = i/4;\n      float edge = texelFetch(Depth, F + ivec2(i % 2, i % 4 / 2)*step, 0).r + texelFetch(Depth, F - ivec2(i % 2, i % 4 / 2)*step, 0).r - depth * 2.;\n      diff += abs(edge);\n    }\n\n    if(diff > .00007) {\n      //lut = lit>0.1?0.:1.;\n      lut = 0.;\n    } else {\n      lut = lit * 65. > float(b64[F.y % 8 * 8 + F.x % 8]) ? 1. : 0.;\n      //lut = lit;\n    }\n  }\n\n  c.rgb = vec3(lut);\n\n  //c.rgb = texelFetch(T0, F, 0).rgb;\n\n  /*if(texelFetch(T1, F, 0).r == 1.)\n    c.rgb = vec3(0., 0., 1.);*/\n  c.a = 1.;\n}",vScreenQuad:"void main() {\n  int i = gl_VertexID;\n  gl_Position = vec4(i%2*2-1, 1-(i+1)%4/2*2, 0., 1.);\n}"},S=1600,_=document.getElementById("C");_.width=S,_.height=800,(n=_.getContext("webgl2")).enable(2929);var I=Date.now(),$=[];!function(){for(let n=0;n<1e4;n++){let n=g(),e=3+~~(10*Math.random());$.push(h(e,n.length-1,s(n,e)))}}();var B=function(n){let e=n.length,t=new Array(e+1);t[0]=[0,0];for(let r=0;r<e;r++)t[r+1]=t[r].map(((e,t)=>e+n[r][t].length));let r=[new Uint32Array(3*t[e][0]),new Float32Array(3*t[e][1]),new Float32Array(3*t[e][1]),new Float32Array(4*t[e][1])];return n.forEach(((n,e)=>{for(let a in n){let o=~~a;n[o].forEach(((n,a)=>{0==o&&(n=x(n,t[e][1])),r[o].set(n,(t[e][0==o?0:1]+a)*(3==o?4:3))}))}})),r}($=$.map((n=>{let e=w([1,0,0,0,0,1,0,0,0,0,1,0,(t=[200*Math.random()-100,100*Math.random(),0])[0],t[1],t[2],1],function(n,e){let[t,r,a]=n;const o=Math.sqrt(t*t+r*r+a*a);t/=o,r/=o,a/=o;const i=Math.cos(e),c=Math.sin(e),l=1-i;return[t*t+(1-t*t)*i,t*r*l+a*c,t*a*l-r*c,0,t*r*l-a*c,r*r+(1-r*r)*i,r*a*l+t*c,0,t*a*l+r*c,r*a*l-t*c,a*a+(1-a*a)*i,0,0,0,0,1]}([0,0,1],6*Math.random()));var t,r;return function(n){n[2]=new Array(n[1].length);for(let e=0;e<n[0].length;e++){let t=n[0][e].map((e=>n[1][e]));n[2][n[0][e][2]]=p(b(F(t[1],t[0]),F(t[2],t[0])))}}(n),r=e,n.map(((n,e)=>1==e?n.map((n=>function(n,e){const[t,r,a]=e,o=t*n[3]+r*n[7]+a*n[11]+n[15];return[(t*n[0]+r*n[4]+a*n[8]+n[12])/o,(t*n[1]+r*n[5]+a*n[9]+n[13])/o,(t*n[2]+r*n[6]+a*n[10]+n[14])/o]}(r,n))):2==e?n.map((n=>function(n,e){const[t,r,a]=e;return[t*n[0]+r*n[4]+a*n[8],t*n[1]+r*n[5]+a*n[9],t*n[2]+r*n[6]+a*n[10]]}(r,n))):n))}))),R=[0,1,2,3].map((e=>n.createBuffer()));l(R[0],B[0],34963),R.forEach(((n,e)=>{0!=e&&l(n,B[e])})),console.log(`${Date.now()-I} ms ${B[1].length/3} faces`);var U=[o,o,i].map((t=>function(t,r,a,o){const i=n.createTexture();return n.bindTexture(e,i),n.texImage2D(e,0,a[2]||a[1],t,r,0,a[1],a[0],o),i.fmt=a,n.texParameteri(e,10241,9728),n.texParameteri(e,10240,9728),n.bindTexture(e,null),i}(S,800,t))),C=function(r){const a=n.createFramebuffer();n.bindFramebuffer(t,a);for(let a=0;a<r.length;a++){let o=r[a].fmt&&r[a].fmt[1],i=34041==o?33306:6402==o?36096:36064+a;n.framebufferTexture2D(t,i,e,r[a],0)}return n.bindFramebuffer(t,null),a}(U),L=50*Math.PI/180,V=((n,e,t=M)=>((n,e,t=M)=>{const r=p(d(e,-1)),a=p(b(t,r)),o=b(a,r);return[a[0],a[1],a[2],0,o[0],o[1],o[2],0,r[0],r[1],r[2],0,n[0],n[1],n[2],1]})(n,F(e,n),t))([0,-20,20],[0,30,0],[0,0,1]),k=((n,e,t,r)=>{const a=1/Math.tan(.5*n),o=1/(t-r);return[a/e,0,0,0,0,a,0,0,0,0,(t+r)*o,-1,0,0,t*r*o*2,0]})(L,2,2,200),z=w(k,function(n){const e=w(n,n),t=w(n,e),r=w(e,e),a=T(n),o=T(e),i=T(t),c=(a**4-6*o*a*a+3*o*o+8*i*a-6*T(r))/24;let l=A((a*a*a-3*a*o+2*i)/6,P,-(a*a-o)/2,n,a,e,-1,t);return D(l,1/c)}(V)),N=a(E.vMain,E.fMain),O=c(N),Q=a(E.vScreenQuad,E.fScreen),j=c(Q);function q(){I=Date.now(),n.useProgram(N),O.camera(z),f(N,"vert",R[1],3),f(N,"norm",R[2],3),f(N,"etc",R[3],4),n.bindFramebuffer(t,C),n.drawBuffers([36064,36065]),n.clear(256),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,R[0]),n.drawElements(4,B[0].length,5125,0),n.useProgram(Q),function(t,r){for(let a=0;a<t.length;a++)n.activeTexture(n.TEXTURE0+a),r[a]&&r[a](a),n.bindTexture(e,t[a])}(U,[j.T0,j.T1,j.Depth]),n.bindFramebuffer(t,null),n.drawArrays(4,0,6),n.flush(),console.log(`Rendered in ${Date.now()-I} ms`)}window.onclick=q,q()})();