(()=>{var n=3553,t=36160,e=n=>[...new Array(n)].map(((n,t)=>t)),r=2*Math.PI;function o(n,t){let e={};for(let r in n)e[r]=t(n[r],r,n);return e}var a=(n,t)=>[n[0]*t,n[1]*t,n[2]*t],f=(n,t=1)=>a(n,t/(n=>(n[0]*n[0]+n[1]*n[1]+n[2]*n[2])**.5)(n)),i=(n,t)=>[n[0]-t[0],n[1]-t[1],n[2]-t[2]],l=(n,t)=>[n[1]*t[2]-n[2]*t[1],n[2]*t[0]-n[0]*t[2],n[0]*t[1]-n[1]*t[0]],c=n=>[Math.cos(n),Math.sin(n)],u=(n,t,e)=>n.map(((n,r)=>n*(1-e)+t[r]*e)),s=[0,1,0],v=(n,t)=>n.map(((e,r)=>{let o=r%4,a=r-o;return t[a]*n[o]+t[a+1]*n[o+4]+t[a+2]*n[o+8]+t[a+3]*n[o+12]})),m=(n,t)=>n.map((n=>t*n)),h=n=>n[0]+n[5]+n[10]+n[15],g=(n,t,...e)=>{const r=m(t,n);return e.length?((n,t)=>n.map(((n,e)=>n+t[e])))(r,g(...e)):r};var d=e(16).map((n=>n%5?0:1));function p(n,t){let[e,r,o]=n;const a=Math.sqrt(e*e+r*r+o*o);e/=a,r/=a,o/=a;const f=Math.cos(t),i=Math.sin(t),l=1-f;return[e*e+(1-e*e)*f,e*r*l+o*i,e*o*l-r*i,0,e*r*l-o*i,r*r+(1-r*r)*f,r*o*l+e*i,0,e*o*l+r*i,r*o*l-e*i,o*o+(1-o*o)*f,0,0,0,0,1]}function b(n,t){const[e,r,o]=t,a=e*n[3]+r*n[7]+o*n[11]+n[15];return[(e*n[0]+r*n[4]+o*n[8]+n[12])/a,(e*n[1]+r*n[5]+o*n[9]+n[13])/a,(e*n[2]+r*n[6]+o*n[10]+n[14])/a]}var x=n=>[1,0,0,0,0,1,0,0,0,0,1,0,n[0],n[1],n[2],1],F={at:3,norm:3,uv:3};function y(n){for(let t of n.faces)(null==t[2].norm||Number.isNaN(t[2].norm[0]))&&(t[2].norm=f(l(i(t[1].at,t[2].at),i(t[0].at,t[2].at))))}var M=(n,t)=>{for(let e of t.verts)e.at=b(n,e.at)};function w(n){let t=0;return[0,...n.map((n=>t+=n.length))]}function D(n,t=(n=>new Array(n))){const e=w(n);let r,o=t(e[n.length]);for(let t=n.length-1;t>=0;t--){r=0==t?0:e[t];for(let e=n[t].length-1;e>=0;e--)o[r+e]=n[t][e]}return o}function T(n,t,e){let r=new Array(n*t*2),o=new Array((n+1)*(t+1)),a=n+1;for(let r=0;r<=n;r++)for(let n=0;n<=t;n++)o[n*a+r]={at:e(r,n),uv:[r,n,0],ind:n*a+r};for(let e=0;e<n;e++)for(let f=0;f<t;f++){const t=2*(f*n+e),i=f*a+e;r[t]=[o[i+1+a],o[i+a],o[i]],r[t+1]=[o[i+1],o[i+1+a],o[i]]}return{faces:r,verts:o}}var A,P=(n,t,o)=>E(e(t).map((n=>c(r/t*(n+(n%2?o:0))))),n),E=(n,t)=>(e,r)=>[n[e%n.length][0]*t[r][0],n[e%n.length][1]*t[r][0],t[r][1]],I=(n,t)=>T(n.length,t.length-1,E(n,t)),S=(n,t)=>D(n.map(((e,r)=>{let o=n[(r+1)%n.length];return[u(e,o,t),u(e,o,1-t)]})));function $(n,t){let e=`#version 300 es\nprecision highp float;\nprecision highp int;\n\n${t}`;const r=A.createShader(n);A.shaderSource(r,e),A.compileShader(r);{const n=A.getShaderInfoLog(r);n&&(console.log("shader:",n),console.log(e.split("\n").map(((n,t)=>`${t+1}. ${n}`)).join("\n")))}return r}function _(n,t){var e=A.createProgram();return A.attachShader(e,$(35633,n)),A.attachShader(e,$(35632,t)),A.linkProgram(e),e}var B=[5121,6408],R=[5123,6402,33189];var U={5124:"i",5125:"ui",5126:"f",35665:"f",35676:"Matrix4fv"};function N(n){const t={};for(let e=0;e<A.getProgramParameter(n,A.ACTIVE_UNIFORMS);++e){const r=A.getActiveUniform(n,e);let o=U[r.type]||"i";const a=A.getUniformLocation(n,r.name);o.indexOf("Matrix")>=0?t[r.name]=(...n)=>A[`uniform${o}`](a,!1,...n):t[r.name]=(...n)=>{A[`uniform${n.length}${o}`](a,...n)}}return console.log(t),t}function C(n,t,e,r=3){let o=A.getAttribLocation(n,t);A.enableVertexAttribArray(o),A.bindBuffer(34962,e),A.vertexAttribPointer(o,r,5126,!1,0,0)}function L(){return A.createBuffer()}function V(n,t,e=34962){A.bindBuffer(e,n),A.bufferData(e,t,35044)}var k={fMain:"uniform float t;\nuniform vec3 sun;\n\nflat in vec3 normal;\nin vec3 fuv;\n\nlayout(location = 0) out vec4 c0;\nlayout(location = 1) out vec4 c1;\n\nvoid main() {\n  float light = dot(normal, sun)*0.5+.5;\n  //light += fract(fuv.y)>0.1 && fract(fuv.y)<0.9 && fract(fuv.x)>0.1 && fract(fuv.x)<0.9 && fract(fuv.y*10.)>0.3 && fract(fuv.x*10.)>0.3?-1.:.0;\n  /*if(mod(uv.x,0.2)<0.1 != mod(uv.y,0.2)<0.1)\n    light /= 2.;*/\n  c0 = vec4(vec3(light), 1.);\n  c1 = vec4(gl_FrontFacing?0.:1.,0.,0.,0.);\n}\n",vMain:"uniform mat4 camera;\r\n\r\nin vec3 at;\r\nin vec3 norm;\r\nin vec3 uv;\r\n\r\nout vec3 fuv;\r\nflat out vec3 normal;\r\n\r\nvoid main() {\r\n  vec4 glpos = camera * vec4(at, 1.);\r\n  glpos.y = -glpos.y;\r\n  gl_Position = glpos / glpos.w;\r\n  //int i = gl_VertexID % 6;\r\n  //uv = vec2(foo[i * 2], foo[i * 2 + 1]);\r\n  fuv = uv;\r\n  normal = norm;\r\n}",fScreen:"uniform sampler2D T0;\nuniform sampler2D T1;\nuniform sampler2D Depth;\n\nout vec4 c;\n\nint b16[16] = int[] (1, 9, 3, 11, 13, 5, 15, 7, 4, 12, 2, 10, 16, 8, 14, 6);\nint b64[64] = int[] (1, 33, 9, 41, 3, 35, 11, 43, 49, 17, 57, 25, 51, 19, 59, 27, 13, 45, 5, 37, 15, 47, 7, 39, 61, 29, 53, 21, 63, 31, 55, 23, 4, 36, 12, 44, 2, 34, 10, 42, 52, 20, 60, 28, 50, 18, 58, 26, 16, 48, 8, 40, 14, 46, 6, 38, 64, 32, 56, 24, 62, 30, 54, 22);\n\nvoid main() {\n  ivec2 F = ivec2(gl_FragCoord.xy);\n  c = vec4(0.);\n  float depth = texelFetch(Depth, F, 0).r;\n  float lut;\n\n  if(depth == 1.) {\n    lut = 1.;\n  } else {\n    float lit = texelFetch(T0, F, 0).r;\n\n    float diff = 0.;\n    for(int i = 0; i < 8; i++) {\n      int step = i/4;\n      float edge = texelFetch(Depth, F + ivec2(i % 2, i % 4 / 2)*step, 0).r + texelFetch(Depth, F - ivec2(i % 2, i % 4 / 2)*step, 0).r - depth * 2.;\n      diff += abs(edge);\n    }\n\n    if(diff > .00007) {\n      //lut = lit>0.1?0.:1.;\n      lut = 0.;\n    } else {\n      lut = lit * 65. > float(b64[F.y % 8 * 8 + F.x % 8]) ? 1. : 0.;\n      //lut = lit * 15. > float(b16[F.y % 4 * 4 + F.x % 4]) ? 1. : 0.;\n      //lut = lit;\n    }\n  }\n\n  c.rgb = vec3(lut);\n\n  //c.rgb = texelFetch(T0, F, 0).rgb;\n\n  /*if(texelFetch(T1, F, 0).r == 1.)\n    c.rgb = vec3(0., 0., 1.);*/\n  c.a = 1.;\n}",vScreenQuad:"void main() {\n  int i = gl_VertexID;\n  gl_Position = vec4(i%2*2-1, 1-(i+1)%4/2*2, 0., 1.);\n}"},O=1600,Q=document.getElementById("C");Q.width=O,Q.height=800,(A=Q.getContext("webgl2")).enable(2929);var j,q,X=Date.now(),Y=_(k.vMain,k.fMain),z=N(Y),G=_(k.vScreenQuad,k.fScreen),H=N(G),J=function(t,[e,r]){return t.map((t=>function(t,e,r,o){const a=A.createTexture();return A.bindTexture(n,a),A.texImage2D(n,0,r[2]||r[1],t,e,0,r[1],r[0],o),A.texParameteri(n,10241,9728),A.texParameteri(n,10240,9728),A.bindTexture(n,null),{texture:a,format:r}}(e,r,t)))}([B,B,R],[O,800]),K=function(e){const r=A.createFramebuffer();A.bindFramebuffer(t,r);for(let r=0;r<e.length;r++){let o=e[r].format[1],a=34041==o?33306:6402==o?36096:36064+r;A.framebufferTexture2D(t,a,n,e[r].texture,0)}return A.bindFramebuffer(t,null),r}(J),W=50*Math.PI/180,Z=((n,t,e=s)=>((n,t,e=s)=>{const r=f(a(t,-1)),o=f(l(e,r)),i=l(o,r);return[o[0],o[1],o[2],0,i[0],i[1],i[2],0,r[0],r[1],r[2],0,n[0],n[1],n[2],1]})(n,i(t,n),e))([0,-30,30],[0,50,0],[0,0,1]),nn=((n,t,e,r)=>{const o=1/Math.tan(.5*n),a=1/(e-r);return[o/t,0,0,0,0,o,0,0,0,0,(e+r)*a,-1,0,0,e*r*a*2,0]})(W,2,2,250),tn=v(nn,function(n){let[t,e,r,o,a,f]=function(n){const t=v(n,n),e=v(n,t),r=v(t,t),o=h(n),a=h(t),f=h(e);return[(o**4-6*a*o*o+3*a*a+8*f*o-6*h(r))/24,t,e,o,a,f]}(n),i=g((o*o*o-3*o*a+2*f)/6,d,-(o*o-a)/2,n,o,e,-1,r);return m(i,1/t)}(Z)),en=function(){let n=[],t=function(n){0<n&&n<1&&(n=~~(1e9*n));let t=t=>~~(Math.sin(++n)**2*1e9%t)*(t<0?-1:1);return e=>-1==e?n:null==e?t(1e9)/1e9:t(e)}(1);const e=n=>{let[t,e]=[2*n()+.5,0],r=[[0,0]],o=2;for(;n(5)||0==r.length;)r.push([t,e]),o<=1&&(t*=.9-.4*n()),o>=1&&(e+=(n()+.1)**2*2*t),o=n(5);return r.push([0,e]),r};function r(){for(let r=0;r<1e4;r++){let r=e(t),o=2*(3+~~t(5));n.push(T(o,r.length-1,P(r,o,t())))}}function o(){for(let e=0;e<1e4;e++){let r=n[e],o=v(x([e%100*2-100,e/30,0]),p([0,0,1],6*t()));M(o,r)}}return function(){r(),o()}(),n}(),rn=(T(20,20,(j=e(21).map((n=>{let t=n/20*Math.PI,[e,r]=[200*Math.sin(t),200*Math.sin(t-Math.PI/2)+15];return[e,r]})),E(e(q=20).map((n=>c(r/q*n))),j))),I(S([[0,-4],[14,-5],[0,3],[-14,-5]],.1),[[0,0],[.8,0],[1,.5],[1,1],[.8,1.5],[0,1.5]]));M(x([0,13,5]),rn);var on=I(S([[3,-5],[0,5],[-3,-5]],.2),[[0,0],[.8,0],[1,2],[1,4],[.4,5],[0,5]]);M(x([0,12,4]),on);var an,fn,ln=((fn={faces:D((an=[on,rn]).map((n=>n.faces))),verts:D(an.map((n=>n.verts)))}).verts.forEach(((n,t)=>n.ind=t)),fn);en.push(ln),function(n){for(let t of n)y(t)}(en);var{bufs:cn,elements:un}=function(n,t){let e=function(n,t){let e=n.length,r=w(n.map((n=>n.faces))),a=w(n.map((n=>n.verts))),f=new Uint32Array(3*r[e]),i=o(t,(n=>new Float32Array(a[e]*n))),l=0;n.forEach(((n,t)=>{for(let e of n.faces){const n=a[t];f[l++]=e[0].ind+n,f[l++]=e[1].ind+n,f[l++]=e[2].ind+n}}));for(let e in i){let r=t[e],o=i[e],a=0;1==r?n.forEach(((n,t)=>{for(let t of n.verts)t[e]&&(o[a++]=t[e])})):n.forEach(((n,t)=>{for(let t of n.verts)t[e]&&o.set(t[e],a*r),a++}))}return{faces:f,verts:i}}(n,t),r=function(n=F){return{faces:L(),verts:o(n,(n=>L())),attrs:n}}(t);return function(n,t){V(n.faces,t.faces,34963);for(let e in t.verts)V(n.verts[e],t.verts[e])}(r,e),{bufs:r,elements:e}}(en,F);function sn(){X=Date.now(),A.useProgram(Y),z.camera(tn),z.sun(...f([-1,1,-1])),A.bindFramebuffer(t,K),A.drawBuffers([36064,36065]),A.clear(256),A.bindBuffer(A.ELEMENT_ARRAY_BUFFER,cn.faces),A.drawElements(4,un.faces.length,5125,0),A.useProgram(G),function(t,e){for(let r=0;r<t.length;r++)A.activeTexture(A.TEXTURE0+r),e[r]&&e[r](r),A.bindTexture(n,t[r].texture)}(J,[H.T0,H.T1,H.Depth]),A.bindFramebuffer(t,null),A.drawArrays(4,0,6),A.flush(),console.log(`Rendered in ${Date.now()-X} ms`)}console.log(`${Date.now()-X} ms ${un.faces.length} faces`),function(n,t){for(let e in n.verts)C(t,e,n.verts[e],n.attrs[e])}(cn,Y),window.onclick=sn,sn()})();