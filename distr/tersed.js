(()=>{var t=t=>[...new Array(t)].map(((t,n)=>n)),n=2*Math.PI;function e(t,n){let e={};for(let r in t)e[r]=n(t[r],r,t);return e}var r=[[1,0,0],[0,1,0],[0,0,1]],o=(t,n)=>[t[0]*n,t[1]*n,t[2]*n],a=(t,n=1)=>o(t,n/(t=>(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])**.5)(t)),i=(t,n)=>[t[0]-n[0],t[1]-n[1],t[2]-n[2]],l=(t,n)=>[t[1]*n[2]-t[2]*n[1],t[2]*n[0]-t[0]*n[2],t[0]*n[1]-t[1]*n[0]],f=r[1],c=t(16).map((t=>t%5?0:1)),u=(t,n)=>t.map(((e,r)=>{let o=r%4,a=r-o;return n[a]*t[o]+n[a+1]*t[o+4]+n[a+2]*t[o+8]+n[a+3]*t[o+12]})),s=(t,n)=>t.map((t=>n*t)),h=t=>t[0]+t[5]+t[10]+t[15],m=(t,n,...e)=>{const r=s(n,t);return e.length?((t,n)=>t.map(((t,e)=>t+n[e])))(r,m(...e)):r};function v(t){let[n,e,r,o,a,i]=function(t){const n=u(t,t),e=u(t,n),r=u(n,n),o=h(t),a=h(n),i=h(e);return[(o**4-6*a*o*o+3*a*a+8*i*o-6*h(r))/24,n,e,o,a,i]}(t),l=m((o*o*o-3*o*a+2*i)/6,c,-(o*o-a)/2,t,o,e,-1,r);return s(l,1/n)}var p=(t,n,e=f)=>((t,n,e=f)=>{const r=a(o(n,-1)),i=a(l(e,r)),c=l(i,r);return[i[0],i[1],i[2],0,c[0],c[1],c[2],0,r[0],r[1],r[2],0,t[0],t[1],t[2],1]})(t,i(n,t),e);function g(t,n){let[e,r,o]=t;const a=Math.sqrt(e*e+r*r+o*o);e/=a,r/=a,o/=a;const i=Math.cos(n),l=Math.sin(n),f=1-i;return[e*e+(1-e*e)*i,e*r*f+o*l,e*o*f-r*l,0,e*r*f-o*l,r*r+(1-r*r)*i,r*o*f+e*l,0,e*o*f+r*l,r*o*f-e*l,o*o+(1-o*o)*i,0,0,0,0,1]}function d(t,n){const[e,r,o]=n,a=e*t[3]+r*t[7]+o*t[11]+t[15];return[(e*t[0]+r*t[4]+o*t[8]+t[12])/a,(e*t[1]+r*t[5]+o*t[9]+t[13])/a,(e*t[2]+r*t[6]+o*t[10]+t[14])/a]}var b=t=>[1,0,0,0,0,1,0,0,0,0,1,0,t[0],t[1],t[2],1],y=t=>[Math.cos(t),Math.sin(t)],x=(t,n,e)=>t.map(((t,r)=>t*(1-e)+n[r]*e)),M={at:3,norm:3,cell:3};function F(t){for(let n of t.faces)(null==n[2].norm||Number.isNaN(n[2].norm[0]))&&(n[2].norm=a(l(i(n[1].at,n[2].at),i(n[0].at,n[2].at))))}var w=(t,...n)=>{for(let e of n)for(let n of t.verts)n.at=d(e,n.at)};function T(t){let n=0;return[0,...t.map((t=>n+=t.length))]}function P(t,n=(t=>new Array(t))){const e=T(t);let r,o=n(e[t.length]);for(let n=t.length-1;n>=0;n--){r=0==n?0:e[n];for(let e=t[n].length-1;e>=0;e--)o[r+e]=t[n][e]}return o}function D(t,n,e){let r=new Array(t*n*2),o=new Array((t+1)*(n+1)),a=t+1;for(let r=0;r<=t;r++)for(let t=0;t<=n;t++)o[t*a+r]={at:e(r,t),cell:[r,t,0],ind:t*a+r};for(let e=0;e<t;e++)for(let i=0;i<n;i++){const n=2*(i*t+e),l=i*a+e;r[n]=[o[l+1+a],o[l+a],o[l]],r[n+1]=[o[l+1],o[l+1+a],o[l]]}return{faces:r,verts:o}}var A,I=(e,r,o)=>E(t(r).map((t=>y(n/r*(t+(t%2?o:0))))),e),E=(t,n)=>(e,r)=>[t[e%t.length][0]*n[r][0],t[e%t.length][1]*n[r][0],n[r][1]],S=(t,n)=>D(t.length,n.length-1,E(t,n)),_=(t,n)=>P(t.map(((e,r)=>{let o=t[(r+1)%t.length];return[x(e,o,n),x(e,o,1-n)]}))),R=3553,$=36160;function B(t,n){let e=`#version 300 es\nprecision highp float;\nprecision highp int;\n\n${n}`;const r=A.createShader(t);A.shaderSource(r,e),A.compileShader(r);{const t=A.getShaderInfoLog(r);t&&(console.log("shader:",t),console.log(e.split("\n").map(((t,n)=>`${n+1}. ${t}`)).join("\n")))}return r}function k(t,n){var e=A.createProgram();return A.attachShader(e,B(35633,t)),A.attachShader(e,B(35632,n)),A.linkProgram(e),e}var U=[5121,6408],C=[5123,6402,33189];function L(t,[n,e]){return t.map((t=>function(t,n,e,r){const o=A.createTexture();return A.bindTexture(R,o),A.texImage2D(R,0,e[2]||e[1],t,n,0,e[1],e[0],r),A.texParameteri(R,10241,9728),A.texParameteri(R,10240,9728),A.bindTexture(R,null),{texture:o,format:e}}(n,e,t)))}var N={5124:"i",5125:"ui",5126:"f",35665:"f",35676:"Matrix4fv"};function V(t){const n={};for(let e=0;e<A.getProgramParameter(t,A.ACTIVE_UNIFORMS);++e){const r=A.getActiveUniform(t,e);let o=N[r.type]||"i";const a=A.getUniformLocation(t,r.name);o.indexOf("Matrix")>=0?n[r.name]=(...t)=>A[`uniform${o}`](a,!1,...t):n[r.name]=(...t)=>{A[`uniform${t.length}${o}`](a,...t)}}return n}function O(t,n,e,r=3){let o=A.getAttribLocation(t,n);A.enableVertexAttribArray(o),A.bindBuffer(34962,e),A.vertexAttribPointer(o,r,5126,!1,0,0)}function Q(){return A.createBuffer()}function j(t,n,e=34962){A.bindBuffer(e,t),A.bufferData(e,n,35044)}function q(t,n){let r=function(t,n){let r=t.length,o=T(t.map((t=>t.faces))),a=T(t.map((t=>t.verts))),i=new Uint32Array(3*o[r]),l=e(n,(t=>new Float32Array(a[r]*t))),f=0;t.forEach(((t,n)=>{for(let e of t.faces){const t=a[n];i[f++]=e[0].ind+t,i[f++]=e[1].ind+t,i[f++]=e[2].ind+t}}));for(let e in l){let r=n[e],o=l[e],a=0;if(1==r)for(let n of t)for(let t of n.verts)t[e]&&(o[a]=t[e]),a++;else for(let n of t)for(let t of n.verts)t[e]&&o.set(t[e],a*r),a++}return{faces:i,verts:l}}(t,n),o=function(t=M){return{faces:Q(),verts:e(t,(t=>Q())),attrs:t}}(n);return function(t,n){j(t.faces,n.faces,34963);for(let e in n.verts)j(t.verts[e],n.verts[e])}(o,r),[o,r]}var K,X,Y,z,G,H,J={fMain:"uniform float t;\nuniform vec3 sun;\n\nflat in vec3 normal;\nflat in float cellType;\nin vec3 uv;\n\nlayout(location = 0) out vec4 c0;\nlayout(location = 1) out vec4 c1;\n\nvoid main() {\n  float light = dot(normal, sun)*0.5+.5;\n  if(cellType == 2.)\n    light += fract(uv.y)>0.1 && fract(uv.y)<0.9 && fract(uv.x)>0.1 && fract(uv.x)<0.9 && fract(uv.y*10.)>0.3 && fract(uv.x*10.)>0.3?-1.:.0;\n  if(light>0.)\n    light += uv.y*0.05 - 0.3;\n  /*if(mod(uv.x,0.2)<0.1 != mod(uv.y,0.2)<0.1)\n    light /= 2.;*/\n  c0 = vec4(vec3(light), 1.);\n  c1 = vec4(gl_FrontFacing?0.:1.,0.,0.,0.);\n}\n",vMain:"uniform mat4 camera;\r\n\r\nin vec3 at;\r\nin vec3 norm;\r\nin vec3 cell;\r\nin float type;\r\n\r\nout vec3 uv;\r\nflat out vec3 normal;\r\nflat out float cellType;\r\n\r\nvoid main() {\r\n  vec4 glpos = camera * vec4(at, 1.);\r\n  glpos.y = -glpos.y;\r\n  gl_Position = glpos;\r\n  //gl_Position = glpos / glpos.w;\r\n  //int i = gl_VertexID % 6;\r\n  //uv = vec2(foo[i * 2], foo[i * 2 + 1]);\r\n  uv = cell;\r\n  cellType = type;\r\n  normal = norm;\r\n}",fScreen:"uniform sampler2D T0;\nuniform sampler2D T1;\nuniform sampler2D Depth;\n\nout vec4 c;\n\nint b16[16] = int[] (1, 9, 3, 11, 13, 5, 15, 7, 4, 12, 2, 10, 16, 8, 14, 6);\nint b64[64] = int[] (1, 33, 9, 41, 3, 35, 11, 43, 49, 17, 57, 25, 51, 19, 59, 27, 13, 45, 5, 37, 15, 47, 7, 39, 61, 29, 53, 21, 63, 31, 55, 23, 4, 36, 12, 44, 2, 34, 10, 42, 52, 20, 60, 28, 50, 18, 58, 26, 16, 48, 8, 40, 14, 46, 6, 38, 64, 32, 56, 24, 62, 30, 54, 22);\n\nvoid main() {\n  ivec2 F = ivec2(gl_FragCoord.xy);\n  c = vec4(0.);\n  float depth = texelFetch(Depth, F, 0).r;\n  float lit;\n\n  if(depth == 1.) {\n    lit = 1.;\n  } else {\n    lit = texelFetch(T0, F, 0).r;\n\n    float diff = 0.;\n    for(int i = 0; i < 8; i++) {\n      int step = i/4;\n      float edge = texelFetch(Depth, F + ivec2(i % 2, i % 4 / 2)*step, 0).r + texelFetch(Depth, F - ivec2(i % 2, i % 4 / 2)*step, 0).r - depth * 2.;\n      diff += abs(edge);\n    }\n\n    if(diff > .00007) {\n      //lut = lit>0.1?0.:1.;\n      lit = 0.;\n    } else {\n      lit = lit * 65. > float(b64[F.y % 8 * 8 + F.x % 8]) ? 1. : 0.;\n      //lit = lit * 15. > float(b16[F.y % 4 * 4 + F.x % 4]) ? 1. : 0.;\n      //lut = lit;\n    }\n\n    if(depth > 0.99){\n      lit = (depth-0.99)*5000. > float(b64[F.y % 8 * 8 + F.x % 8]) ? 1. : lit;\n    }\n\n  }\n\n  c.rgb = vec3(lit);\n\n  //c.rgb = texelFetch(T0, F, 0).rgb;\n\n  /*if(texelFetch(T1, F, 0).r == 1.)\n    c.rgb = vec3(0., 0., 1.);*/\n  c.a = 1.;\n}",vScreenQuad:"void main() {\n  int i = gl_VertexID;\n  gl_Position = vec4(i%2*2-1, 1-(i+1)%4/2*2, 0., 1.);\n}"};function W(t,[n,e]){Date.now();A.useProgram(K),Y.camera(t),Y.sun(...a([1,1,-1])),A.bindFramebuffer($,H),A.drawBuffers([36064,36065]),A.clear(256),A.bindBuffer(A.ELEMENT_ARRAY_BUFFER,n.faces),A.drawElements(4,e.faces.length,5125,0),A.useProgram(X),function(t,n){for(let e=0;e<t.length;e++)A.activeTexture(A.TEXTURE0+e),n[e]&&n[e](e),A.bindTexture(R,t[e].texture)}(G,[z.T0,z.T1,z.Depth]),A.bindFramebuffer($,null),A.drawArrays(4,0,6),A.flush()}function Z(t,[n,e]){const o=50*Math.PI/180,a=n/e,i=p(t,[0,1e3,0],r[2]),l=((t,n,e,r)=>{const o=1/Math.tan(.5*t),a=1/(e-r);return[o/n,0,0,0,0,o,0,0,0,0,(e+r)*a,-1,0,0,e*r*a*2,0]})(o,a,10,3e3);return u(l,v(i))}var tt={},nt=[];function et(t){let n,e;t instanceof KeyboardEvent?(n=t.code,e="keydown"==t.type?"down":"up"):(n="Click"+t.button,e="mousedown"==t.type?"down":"up"),"down"==e&&(n in tt||(rt(n),tt[n]=window.setInterval((()=>rt(n)),100))),"up"==e&&(window.clearInterval(tt[n]),delete tt[n])}function rt(t){for(let n of nt)n(t)}var ot,at=Math.PI/180,it=[0,0];var lt,ft=[1600,900],ct=Date.now(),ut=function(){let e=function(){let t=[],n=function(t){0<t&&t<1&&(t=~~(1e9*t));let n=n=>(t=16807*t%2147483647)%n;return e=>-1==e?t:null==e?n(1e9)/1e9:n(e)}(1);function e(){for(let e=0;e<1e4;e++){let[e,r]=o(n),a=2*(n(4)+2),i=D(a,e.length-1,I(e,a,n()));for(let t of i.verts)t.type=r[t.cell[1]];t.push(i)}}const o=t=>{let[n,e]=[15*t()+5,0],r=[[0,0],[n,0]],o=[0],a=2;for(;t(4)||r.length<4;){let i=a<=1?.8-.4*t():1,l=a>=1?(t()+.3)**2*2.5*n:0;n*=i,e+=l,r.push([n,e]),o.push(i>.5&&l?2:0),a=t(5)}return r.push([0,e+(t(4)-1)*n]),[r,o]};function a(){e(),function(t,n){for(let e=0;e<t.length;e++)w(t[e],g(r[2],6*n()),b([e/5-1e3+n(),15*(e%200-100)+1200,0]))}(t,n)}return a(),t}();var o,a;D(40,40,(o=t(41).map((t=>{let n=t/40*Math.PI,[e,r]=[2e3*Math.sin(n),2e3*Math.sin(n-Math.PI/2)+15];return[e,r]})),E(t(a=40).map((t=>y(n/a*t))),o)));let i=S(_([[0,-4],[14,-5],[0,3],[-14,-5]],.1),[[0,0],[.8,0],[1,.5],[1,1],[.8,1.5],[0,1.5]]);w(i,b([0,13,5]));let l=S(_([[3,-4],[0,10],[-3,-4]],.2),[[0,1],[.8,1],[1,2],[1,3],[.4,4],[0,4]]);w(l,b([0,12,4]));let f=((u={faces:P((c=[l,i]).map((t=>t.faces))),verts:P(c.map((t=>t.verts)))}).verts.forEach(((t,n)=>t.ind=n)),u);var c,u,s;return w(f,(s=.25,t(16).map((t=>15==t?1:t%5?0:s))),g([0,-1,0],.45),b([20,-60,290])),e.push(f),function(t){for(let n of t)F(n)}(e),e}(),[st,ht]=function([t,n]){let e=document.getElementById("C");return e.width=t,e.height=n,(A=e.getContext("webgl2")).enable(2929),K=k(J.vMain,J.fMain),Y=V(K),X=k(J.vScreenQuad,J.fScreen),z=V(X),G=L([U,U,C],[t,n]),H=function(t){const n=A.createFramebuffer();A.bindFramebuffer($,n);for(let n=0;n<t.length;n++){let e=t[n].format[1],r=34041==e?33306:6402==e?36096:36064+n;A.framebufferTexture2D($,r,R,t[n].texture,0)}return A.bindFramebuffer($,null),n}(G),[K,e]}(ft),[mt]=(lt=ht,["keydown","keyup","mousedown","mouseup"].forEach((t=>lt.addEventListener(t,et))),[tt,nt]);ot={pos:[0,0,0],vel:50,time:0,rot:[0,0],smoothRot:[0,0]};var[vt,pt]=function(t,n){let[e,r]=q(t,{at:3,norm:3,cell:3,type:1});return function(t,n){for(let e in t.verts)O(n,e,t.verts[e],t.attrs[e])}(e,n),[e,r]}(ut,st);console.log(`${Date.now()-ct} ms ${pt.faces.length} faces`);var gt=0;function dt(){let t=Z([0,-500+gt,200],ft);!function(t){it=it.map((n=>Math.sign(n)*Math.min(30,Math.abs(n)*t*60))),ot.rot[0]=ot.rot[0]-.1*it[0],ot.rot[1]=Math.max(-89.999,Math.min(89.999,ot.rot[1]-.1*it[1]));let n=Math.min(1,30*t);ot.smoothRot=ot.smoothRot.map(((t,e)=>t*(1-n)+ot.rot[e]*n));let[e,r]=ot.smoothRot.map((t=>t*at));a([Math.cos(r)*Math.cos(e),Math.cos(r)*Math.sin(e),Math.sin(r)]),it[0],1-10*t,it=[0,0]}(50),W(t,[vt,pt]),gt++}window.onclick=dt,setInterval(dt,50)})();