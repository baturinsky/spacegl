(()=>{var e,n=3553,r=36160;function t(n,r){let t=`#version 300 es\nprecision highp float;\nprecision highp int;\nprecision mediump sampler3D;\n\n${r}`;const a=e.createShader(n);e.shaderSource(a,t),e.compileShader(a);{const n=e.getShaderInfoLog(a);n&&(console.log("shader:",n),console.log(t.split("\n").map(((e,n)=>`${n+1}. ${e}`)).join("\n")))}return a}function a(n,r){var a=e.createProgram();return e.attachShader(a,t(35633,n)),e.attachShader(a,t(35632,r)),e.linkProgram(a),a}var o=[5121,6408],i=[5123,6402,33189];function c(n){const r={},t={5124:"i",5125:"ui",5126:"f",35676:"Matrix4fv"};for(let a=0;a<e.getProgramParameter(n,e.ACTIVE_UNIFORMS);++a){const o=e.getActiveUniform(n,a);console.log(o.name,o.type.toString(16));let i=t[o.type]||"i";const c=e.getUniformLocation(n,o.name);i.indexOf("Matrix")>=0?r[o.name]=(...n)=>e[`uniform${i}`](c,!1,...n):r[o.name]=(...n)=>e[`uniform${n.length}${i}`](c,...n)}return console.log(r),r}function l(){return e.createBuffer()}function f(n,r,t=34962){e.bindBuffer(t,n),e.bufferData(t,r,35044)}function m(n,r,t,a=3){let o=e.getAttribLocation(n,r);e.enableVertexAttribArray(o),e.bindBuffer(34962,t),e.vertexAttribPointer(o,a,5126,!1,0,0)}var u=e=>[...new Array(e)].map(((e,n)=>n));function v(e,n,r){let t=[],a=[],o=[];const i=2*r,c=2*r+1;t[i]=[0,0,0],a[i]=[0,0,-1],t[c]=[0,0,n],a[c]=[0,0,1];const l=2*Math.PI/r;for(let o=0;o<r;o++){let i=s(l*o),c=s(l*(o+.5)),f=e*i[0],m=e*i[1];t[o]=[f,m,0],t[o+r]=[f,m,n],a[o]=a[o+r]=[c[0],c[1],0]}for(let e=0;e<r;e++){let n=(e+1)%r;o[4*e]=[e,n,i],o[4*e+1]=[e+r,n+r,c],o[4*e+2]=[n,n+r,e],o[4*e+3]=[e+r,n+r,e]}return{vert:t,norm:a,face:o}}var g=(e,n)=>[e[0]*n,e[1]*n,e[2]*n],d=(e,n=1)=>g(e,n/(e=>Math.hypot(e[0],e[1],e[2]))(e)),h=(e,n)=>[e[1]*n[2]-e[2]*n[1],e[2]*n[0]-e[0]*n[2],e[0]*n[1]-e[1]*n[0]],s=e=>[Math.cos(e),Math.sin(e)],p=[0,1,0],b=(e,n)=>({...n,vert:n.vert.map((n=>((e,n)=>(n=((e,n=1)=>[e[0],e[1],e[2],e.length>3?e[3]:n])(n),u(3).map((r=>n.reduce(((n,t,a)=>n+t*e[a+4*r]),0)))))(e,n)))}),x=(e,n)=>e.map(((r,t)=>u(4).reduce(((r,a)=>r+n[t-t%4+a]*e[t%4+4*a]),0))),F=(e,n)=>e.map((e=>n*e)),y=e=>e[0]+e[5]+e[10]+e[15],M=(e,n,...r)=>{const t=F(n,e);return r.length?((e,n)=>e.map(((e,r)=>e+n[r])))(t,M(...r)):t};var T=u(16).map((e=>e%5?0:1)),A={fMain:"uniform float t;\n\nflat in vec3 normal;\nin vec2 uv;\n\nlayout(location = 0) out vec4 c0;\nlayout(location = 1) out vec4 c1;\n\nvoid main() {\n  //c0 = vec4(normal*0.5+0.5, 1.);  \n  float light = dot(normal, normalize(vec3(1.,1.,3.)));\n  c0 = vec4(vec3(light), 1.);\n  c1 = vec4(sin(gl_FragCoord.y*.5)+.5, 0., 0., 1.);\n}\n",vCamera:"uniform mat4 camera;\r\n\r\nin vec3 vert;\r\nin vec3 norm;\r\n\r\nout vec2 uv;\r\nflat out vec3 normal;\r\n\r\nvoid main() {  \r\n  vec4 glpos = camera * vec4(vert, 1.);  \r\n  glpos.y = - glpos.y;\r\n  gl_Position = glpos / glpos.w;\r\n  uv = vert.xy*0.5 + vec2(0.5);\r\n  normal = norm;\r\n}",fScreen:"uniform sampler2D T0;\nuniform sampler2D T1;\nuniform sampler2D Depth;\n\nout vec4 c;\n\nint bayer[16] = int[] (1, 9, 3, 11, 13, 5, 15, 7, 4, 12, 2, 10, 16, 8, 14, 6);\n\nvoid main() {\n  ivec2 F = ivec2(gl_FragCoord.xy);\n  c = vec4(0.);\n  float depth = texelFetch(Depth, F, 0).r;\n  c.rgb = vec3(texelFetch(T0, F, 0).r*16.5 > float(bayer[F.y%4*4 + F.x%4])?1.:0.);\n  float diff = 0.;\n  for(int i = 0; i < 4; i++) {\n    float edge = texelFetch(Depth, F + ivec2(i % 2, i / 2), 0).r + texelFetch(Depth, F - ivec2(i % 2, i / 2), 0).r - depth * 2.;\n    diff += abs(edge);\n  }\n  if(diff > .0001)\n    c.rgb = vec3(0.);\n  if(depth == 1.)\n    c.rgb = vec3(1.);\n  c.a = 1.;\n}",vScreenQuad:"void main() {\n  int i = gl_VertexID;\n  gl_Position = vec4(i%2*2-1, 1-(i+1)%4/2*2, 0., 1.);\n}"},D=document.getElementById("C");D.width=800,D.height=800,(e=D.getContext("webgl2")).enable(2929);var P,w=[];for(let e=0;e<1e3;e++)w.push(b([1,0,0,(P=[10*Math.random()-5,10*Math.random()-5,0])[0],0,1,0,P[1],0,0,1,P[2],0,0,0,1],v(.5*Math.random(),1+5*Math.random(),10)));var S=function(e){let n=0;return{vert:e.map((e=>e.vert)).flat(),norm:e.map((e=>e.norm)).flat(),face:e.map((e=>{let r=e.face.map((e=>e.map((e=>e+n))));return n+=e.vert.length,r})).flat()}}(w);console.log(S);var E=l();f(E,new Float32Array(S.vert.flat()));var I=l();f(I,new Float32Array(S.norm.flat()));var _=l();f(_,new Uint32Array(S.face.flat()),34963);var B=[o,o,i].map((r=>function(r,t,a,o){const i=e.createTexture();return e.bindTexture(n,i),e.texImage2D(n,0,a[2]||a[1],r,t,0,a[1],a[0],o),i.fmt=a,e.texParameteri(n,10241,9728),e.texParameteri(n,10240,9728),e.bindTexture(n,null),i}(800,800,r))),C=function(t){const a=e.createFramebuffer();e.bindFramebuffer(r,a);for(let a=0;a<t.length;a++){let o=t[a].fmt&&t[a].fmt[1],i=34041==o?33306:6402==o?36096:36064+a;e.framebufferTexture2D(r,i,n,t[a],0)}return e.bindFramebuffer(r,null),a}(B),U=50*Math.PI/180,$=((e,n,r=p)=>{return((e,n,r=p)=>{const t=d(g(n,-1)),a=d(h(r,t)),o=h(a,t);return[a[0],a[1],a[2],0,o[0],o[1],o[2],0,t[0],t[1],t[2],0,e[0],e[1],e[2],1]})(e,(a=e,[(t=n)[0]-a[0],t[1]-a[1],t[2]-a[2]]),r);var t,a})([0,5,10],[0,0,0],[0,0,1]),R=((e,n,r,t)=>{const a=1/Math.tan(.5*e),o=1/(r-t);return[a/n,0,0,0,0,a,0,0,0,0,(r+t)*o,-1,0,0,r*t*o*2,0]})(U,1,.5,80),L=x(R,function(e){const n=x(e,e),r=x(e,n),t=x(n,n),a=y(e),o=y(n),i=y(r),c=(a**4-6*o*a*a+3*o*o+8*i*a-6*y(t))/24;let l=M((a*a*a-3*a*o+2*i)/6,T,-(a*a-o)/2,e,a,n,-1,r);return F(l,1/c)}($)),V=a(A.vCamera,A.fMain),k=c(V),N=a(A.vScreenQuad,A.fScreen),O=c(N);function Q(){e.useProgram(V),k.camera(L),m(V,"vert",E,3),m(V,"norm",I,3),e.bindFramebuffer(r,C),e.drawBuffers([36064,36065]),e.clear(256),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,_),e.drawElements(4,3*S.face.length,5125,0),e.useProgram(N),function(r,t){for(let a=0;a<r.length;a++)e.activeTexture(e.TEXTURE0+a),t[a]&&t[a](a),e.bindTexture(n,r[a])}(B,[O.T0,O.T1,O.Depth]),e.bindFramebuffer(r,null),e.drawArrays(4,0,6)}window.onclick=Q,Q()})();