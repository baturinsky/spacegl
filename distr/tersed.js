(()=>{var n=n=>[...new Array(n)].map(((n,e)=>e)),e=(n,e)=>[...new Array(n)].map(((n,t)=>e?e(t):t)),t=2*Math.PI,r=Math.PI,o=Math.PI/2,a=Math.PI/4,i=2**31;function l(n){0<n&&n<1&&(n=~~(n*i));let e=e=>(n=16807*n%2147483647)%e;return t=>-1==t?n:null==t?e(i)/i:e(t)}function c(n,e){let t={};for(let r in n)t[r]=e(n[r],r,n);return t}var f=[[1,0,0],[0,1,0],[0,0,1]],s=n=>(n[0]*n[0]+n[1]*n[1]+n[2]*n[2])**.5,u=(n,e)=>[n[0]*e,n[1]*e,n[2]*e],v=(n,e=1)=>u(n,e/s(n)),m=(n,e)=>n[0]*e[0]+n[1]*e[1]+n[2]*e[2],h=(n,e)=>[n[0]+e[0],n[1]+e[1],n[2]+e[2]],p=(n,e)=>[n[0]+e,n[1]+e,n[2]+e],d=(n,e,t)=>[n[0]+e[0]*t,n[1]+e[1]*t,n[2]+e[2]*t],g=(n,e)=>[n[0]-e[0],n[1]-e[1],n[2]-e[2]],y=(n,e)=>[n[1]*e[2]-n[2]*e[1],n[2]*e[0]-n[0]*e[2],n[0]*e[1]-n[1]*e[0]],x=(n,e)=>(n=>F(n,n)**.5)(M(n,e)),b=(n,e)=>n.map((n=>n*e)),F=(n,e)=>n.reduce(((n,t,r)=>n+t*e[r]),0),M=(n,e)=>n.map(((n,t)=>n-e[t])),w=n=>[Math.cos(n),Math.sin(n)],D=(n,e,t)=>n.map(((n,r)=>n*(1-t)+e[r]*t)),z=f[1],P=n(16).map((n=>n%5?0:1)),S=(n,e)=>n.map(((t,r)=>{let o=r%4,a=r-o;return e[a]*n[o]+e[a+1]*n[o+4]+e[a+2]*n[o+8]+e[a+3]*n[o+12]})),T=(...n)=>1==n.length?n[0]:T(...n.slice(0,n.length-2),S(n[n.length-1],n[n.length-2])),A=(n,e)=>n.map((n=>e*n)),E=n=>n[0]+n[5]+n[10]+n[15],B=(n,e,...t)=>{const r=A(e,n);return t.length?((n,e)=>n.map(((n,t)=>n+e[t])))(r,B(...t)):r};function _(n){let[e,t,r,o,a,i]=function(n){const e=S(n,n),t=S(n,e),r=S(e,e),o=E(n),a=E(e),i=E(t);return[(o**4-6*a*o*o+3*a*a+8*i*o-6*E(r))/24,e,t,o,a,i]}(n),l=B((o*o*o-3*o*a+2*i)/6,P,-(o*o-a)/2,n,o,t,-1,r);return A(l,1/e)}var $=(n,e,t=z)=>{const r=v(u(e,-1)),o=v(y(t,r)),a=y(o,r);return[o[0],o[1],o[2],0,a[0],a[1],a[2],0,r[0],r[1],r[2],0,n[0],n[1],n[2],1]};function L(n,e){let[t,r,o]=n;const a=Math.sqrt(t*t+r*r+o*o);t/=a,r/=a,o/=a;const i=Math.cos(e),l=Math.sin(e),c=1-i;return[t*t+(1-t*t)*i,t*r*c+o*l,t*o*c-r*l,0,t*r*c-o*l,r*r+(1-r*r)*i,r*o*c+t*l,0,t*o*c+r*l,r*o*c-t*l,o*o+(1-o*o)*i,0,0,0,0,1]}function R(n,e){const[t,r,o]=e,a=t*n[3]+r*n[7]+o*n[11]+n[15];return[(t*n[0]+r*n[4]+o*n[8]+n[12])/a,(t*n[1]+r*n[5]+o*n[9]+n[13])/a,(t*n[2]+r*n[6]+o*n[10]+n[14])/a]}var C=e=>n(16).map((n=>15==n?1:n%5?0:e)),k=e=>n(16).map((n=>15==n?1:n%5?0:e[n/5])),N=n=>[1,0,0,0,0,1,0,0,0,0,1,0,n[0],n[1],n[2],1];function U(n,e,[t,r],o,[a,i]){let l=t/r;const c=((n,e,t=z)=>$(n,g(e,n),t))(n,h(n,e),f[2]),s=((n,e,t,r)=>{const o=1/Math.tan(.5*n),a=1/(t-r);return[o/e,0,0,0,0,o,0,0,0,0,(t+r)*a,-1,0,0,t*r*a*2,0]})(o,l,a,i);return[S(s,_(c)),s,c]}function O([n,e,t]){return[1-2*n*n,-2*n*e,-2*n*t,0,-2*n*e,1-2*e*e,-2*e*t,0,-2*n*t,-2*e*t,1-2*t*t,0,0,0,0,1]}var V=3553,q=5121,X=5125,Y=5126,J=6408,Q=36160,W=35051,j=36065,G={at:[3],norm:[3],cell:[3]};function H(n){for(let e of n.faces)(null==e[2].norm||Number.isNaN(e[2].norm[0]))&&(e[2].norm=v(y(g(e[0].at,e[2].at),g(e[1].at,e[2].at))))}var K=(n,...e)=>{let t=T(...e);for(let e of n.verts)e.at=R(t,e.at)};function Z(n){return(e={faces:en(n.map((n=>n.faces))),verts:en(n.map((n=>n.verts)))}).verts.forEach(((n,e)=>n.ind=e)),e;var e}function nn(n){let e=0;return[0,...n.map((n=>e+=n.length))]}function en(n,e=(n=>new Array(n))){const t=nn(n);let r,o=e(t[n.length]);for(let e=n.length-1;e>=0;e--){r=0==e?0:t[e];for(let t=n[e].length-1;t>=0;t--)o[r+t]=n[e][t]}return o}function tn(n,e,t){let r=new Array(n*e*2),o=new Array((n+1)*(e+1)),a=n+1;for(let r=0;r<=n;r++)for(let n=0;n<=e;n++)o[n*a+r]={at:t(r,n),cell:[r,n,0],ind:n*a+r};for(let t=0;t<n;t++)for(let i=0;i<e;i++){const e=2*(i*n+t),l=i*a+t;r[e]=[o[l+1+a],o[l+a],o[l]],r[e+1]=[o[l+1],o[l+1+a],o[l]]}return{faces:r,verts:o}}var rn,on=(n,e)=>(t,r)=>[n[t%n.length][0]*e[r][0],n[t%n.length][1]*e[r][0],e[r][1]],an=(n,e)=>ln(n,e,on),ln=(n,e,t)=>tn(n.length,e.length-1,t(n,e)),cn=(n,e)=>en(n.map(((t,r)=>{let o=n[(r+1)%n.length];return[D(t,o,e),D(t,o,1-e)]}))),fn=(n,e)=>en(n.map(((t,r)=>{let o=n[(r+1)%n.length],a=x(t,o),i=e/a;return[D(t,o,i),D(t,o,1-i)]})));function sn(n){let e={...n};return e.verts=JSON.parse(JSON.stringify(n.verts)),e.faces=n.faces.map((n=>n.map((n=>e.verts[n.ind])))),e}function un(n){n.faces=n.faces.map((n=>[n[1],n[0],n[2]]))}function vn(n,e){let t=`#version 300 es\nprecision highp float;\nprecision highp int;\n\n${e}`;const r=rn.createShader(n);rn.shaderSource(r,t),rn.compileShader(r);{const n=rn.getShaderInfoLog(r);n&&(console.log("shader:",n),console.log(t.split("\n").map(((n,e)=>`${e+1}. ${n}`)).join("\n")))}return r}function mn(n,e){var t=rn.createProgram();return rn.attachShader(t,vn(35633,n)),rn.attachShader(t,vn(35632,e)),rn.linkProgram(t),t}var hn=[5121,6408],pn=[5123,6402,33189];function dn(n,[e,t]){return n.map((n=>function(n,e,t,r){const o=rn.createTexture();return rn.bindTexture(V,o),rn.texImage2D(V,0,t[2]||t[1],n,e,0,t[1],t[0],r),rn.texParameteri(V,10241,9728),rn.texParameteri(V,10240,9728),rn.bindTexture(V,null),{texture:o,format:t}}(e,t,n)))}var gn={5124:"i",[X]:"ui",[Y]:"f",35665:"f",35676:"Matrix4fv"};function yn(n){const e={};for(let t=0;t<rn.getProgramParameter(n,rn.ACTIVE_UNIFORMS);++t){const r=rn.getActiveUniform(n,t);console.log(r);let o=gn[r.type]||"i";const a=rn.getUniformLocation(n,r.name);let i=r.size>1?n=>{rn[`uniform1${o}v`](a,n)}:o.indexOf("Matrix")>=0?n=>rn[`uniform${o}`](a,!1,n):(...n)=>{n[0].length>0&&(n=n[0]),rn[`uniform${n.length}${o}`](a,...n)};e[r.name]=i}return e}function xn(n,e){for(let t in e)n[t]&&n[t](e[t])}function bn(n,e,t,r=3,o=5126){let a=rn.getAttribLocation(n,e);rn.enableVertexAttribArray(a),rn.bindBuffer(34962,t),rn.vertexAttribPointer(a,r,o,!1,0,0)}function Fn(){return rn.createBuffer()}function Mn(n,e,t=34962){rn.bindBuffer(t,n),rn.bufferData(t,e,35044),rn.bindBuffer(t,null)}function wn(n,e){for(let t in n.verts)bn(e,t,n.verts[t],n.attrs[t][0],n.attrs[t][1]||Y)}function Dn(n,e){let t=function(n,e){let t=n.length,r=nn(n.map((n=>n.faces))),o=nn(n.map((n=>n.verts))),a=new Uint32Array(3*r[t]),i=c(e,(n=>n[1]&&n[1]!=Y?new Int32Array(o[t]*n[0]):new Float32Array(o[t]*n[0]))),l=0;n.forEach(((n,e)=>{for(let t of n.faces){const n=o[e];a[l++]=t[0].ind+n,a[l++]=t[1].ind+n,a[l++]=t[2].ind+n}}));for(let t in i){let r=e[t][0],o=i[t],a=0;for(let e of n){let n=e.common?e.common[t]:null;for(let i of e.verts){let e=i[t]||n;e&&(1==r?o[a]=e:o.set(e,a*r)),a++}}}return{faces:a,verts:i}}(n,e),r=function(n=G){return{faces:Fn(),verts:c(n,(n=>Fn())),attrs:n}}(e);return function(n,e){Mn(n.faces,e.faces,34963);for(let t in e.verts)Mn(n.verts[t],e.verts[t])}(r,t),[r,t]}async function zn(n,e,t,r,o,a){const i=rn.fenceSync(37143,0);return rn.flush(),await function(n,e,t){return new Promise(((r,o)=>{!function a(){const i=rn.clientWaitSync(n,e,0);i!=rn.WAIT_FAILED?i!=rn.TIMEOUT_EXPIRED?r(null):setTimeout(a,t):o()}()}))}(i,0,10),rn.deleteSync(i),rn.bindBuffer(n,e),rn.getBufferSubData(n,t,r,o,a),rn.bindBuffer(n,null),r}var Pn=K,Sn=72,Tn=400,An=12960,En=7200;function In(){let n=l(1),a=function(n){let e=function(n){let e=new Array(An),o=new Array(An);for(let a=0;a<An;a++){if(o[a])continue;let i=[n(4)?0:n(3),n(4)?0:n(3)],l=a%Sn/Sn*t,c=Math.sin(6*l+r/2),f=Math.min(1.4-3*Math.abs(.5-a/An),.5*c+1),s=0;if(f>.3*n()){let t=30+n(10);!n(10)&&c>0&&(t*=1.2),t=Math.min(18,t),s=3+20*f*(8+n(10));let r=0!=n(4);r&&(s/=2);let l=Bn(n,t*(.5+.5*n()),a,s/t,r);if(t*=1-(.1+i[0]+i[1]),e[a]=l,o[a]=s,l.extend=i,l.height=s,l.density=f,i[0]>1||i[1]>1)for(let n=0;n<=i[0];n++)for(let e=0;e<=i[1];e++)o[a+n+e*Sn]=s;l.verts.push({at:[0,0,s+3],ind:l.verts.length})}}return e}(n);return function(n){let e=[];for(let e=0;e<An;e++){let r=n[e];if(!r)continue;let o=e%Sn/Sn*t+r.extend[0]/2;(r.extend[0]>1||r.extend[1]>1)&&Pn(r,k([r.extend[0]+1,r.extend[1]+1,1])),Pn(r,N([0,e/An*En+40*r.extend[1]/2,-400]),L(f[1],o))}}(e),e}(n),i=a.filter((n=>n)),c=function(n,r,o,a,i){let l=(n=>e(n,(e=>w(e/(n-1)*t))))(r),c=[];for(let e=0;e<r-1;e++){let t=1e3*n(),f=e/r*6%1<.5?.8:1,s=an([b(l[e],o),b(l[(e+1)%r],o),b(l[(e+1)%r],a),b(l[e],a)].reverse(),[[1,-t],[1,.96*i],[f,.98*i],[f,1.03*i]]);c.push(s)}let f=an(l,[[0,i],[a,i],[1.2*a,i],[1.2*a,1.2*i],[0,1.2*i]]);for(let n of f.verts)0==n.cell[1]&&(n.type=[5,0,0,0]);let s=Z([f,...c]);return s.common={type:[4,0,0,0]},s}(n,72,Tn,520,7200);Pn(c,L(f[0],-Math.PI/2)),i.push(c);let s=[],u=function(){let n=an(fn([[0,-4],[6,-5],[0,4],[-6,-5]],2),[[0,0],[.8,0],[1,.5],[1,1],[.8,1.1],[0,1.1]]);Pn(n,N([0,3,5]));let e=an(fn([[-1,0],[1,0],[1,2],[-1,2]],.5),[[0,0],[.8,0],[1,1],[1,1],[.5,3],[0,3]]);Pn(e,L([1,0,0],-o),N([2,-1.5,6.2]));let t=sn(e);Pn(t,O([1,0,0])),un(t);let r=an(fn([[1,-4],[1,7],[0,10],[-1,7],[-1,-4]],1),[[0,1],[.8,1],[1,2],[1,3],[.4,4],[0,4]]);Pn(r,N([0,2,3.5]));let a=Z([r,n,e,t]);return a.common={type:[3,0,0,0]},Pn(a,C(.2),L([0,-1,0],Math.PI),L([-1,0,0],Math.PI/2),N([0,2,0])),a}();s.push(u);for(let e=0;e<150;e++){let a=Ln(n,e),l=e%6;Pn(a,L([0,1,0],o+(l<3?r:0)),C(n(5)+2),N([0,0,Tn*(.35+.15*n())]),L([0,1,0],l*t/6+5*t/12+.2*n()-.1)),i.push(a)}let v=[];for(;v.length<1920;){let e=a[n(a.length)];if(e&&e.height*n()<e.density&&e.density>.4){let n=(m=e.verts,m[m.length-1]).at;v.push({ind:v.length,at:n,live:!0})}}var m;v.forEach(((e,t)=>{for(let o=0;o<32;o++){let a=3*n()+1,i={faces:[[(r=[[-a/2,-a/2,0],[-a/2,a,0],[a/2,a/2,0],[a/2,-a/2,0]].map(((n,e)=>({ind:e,at:n}))))[1],r[2],r[3]],[r[0],r[1],r[3]]],verts:r};i.common={type:[9,...e.at],shape:32*t+o},s.push(i)}var r}));let h=0;for(let n of[...i,...s])h++,H(n),n.common=n.common||{},n.common.shape=n.common.shape||h;return[i,s,v]}function Bn(n,r,o,i,l){let c,f,s;if(l)[f,s]=_n(n,i,r*(.5+.4*n()),!0),c=[[1,1],[-1,1],[-1,-1],[1,-1]];else{let o=n(4)+4;[f,s]=_n(n,i,r),c=e(o,(n=>((n,e=0)=>r=>w(t/n*r+e))(o,a)(n))),n(3)||(c=cn(c,.1)),0==n(4)&&c.forEach((n=>n[1]+=.95))}let u=ln(c,f,on);for(let n of u.verts)n.type=s?s[n.cell[1]]:[2,0,0,0];return u}function _n(n,e,t,r=!1){let[o,a]=[1,0],i=[[o*t,0]],l=[],c=2,[f,s]=function(n){return[[n(6)+2,n(6)+2,n(6),n(6)],[(n()+.3)/4,n()+.3]]}(n);for(;a<e;){let v=c>1?0:o*(.1+.5*n())*(n(4)?-1:1);(o+v>1||o+v<.3)&&(v=-v);let m=r?e:(c>0?1:0)*(.5*n()*(1.1*e-a));a<5&&m>0&&m++,o+=v,a+=m,a>e&&(a=e),i.push([o*t,a*t]);let h=~~(m*s[0]*t)||1,p=~~(o*s[1]*t)||1,d=(1-f[0]/15)*(1-f[1]/15);0!=v&&(h=1),l.push([2,256*h+p,(u=f,u.reduce(((n,e)=>16*n+e))),256*d]);let g=n(3);c=0==g&&0==c?2:g}var u;return i.push([0,a*t]),l.push([2,2056,57344,0]),[i,l]}function $n(n,e,t,r){let o=[n()*t[1][0],n()*t[1][1]],a=t[0][0],i=[[[a,o[0]]],[[a,o[1]]]],l=(t[0][1]-t[0][0])/(e[0]+e[1]);if(!(l<0)){for(let r=0;r<20&&(a+=n()*l*2,a>t[0][1]&&(a=t[0][1]),n()<e[0]/(e[0]+e[1])&&(o[0]=n()*t[1][0]),n()<e[1]/(e[0]+e[1])&&(o[1]=n()*t[1][1]),i[0].push([a,o[0]]),i[1].push([a,o[1]]),!(a>=t[0][1]));r++);return i[0].push([a,o[0]]),i[1].push([a,o[1]]),((n,e)=>{let t=e[0][1],r=e[e.length-1][1];const o=e=>tn(n.length/2,1,((t,r)=>[...n[0==r?t:n.length-t-1],e]));let a=o(t),i=o(r);return un(a),Z([an(n,e),a,i])})(cn([...i[0],...i[1].reverse()].map((n=>[n[0],n[1]/2])),.1),r)}}function Ln(n,e){let t=5+n(15),r=.5+n(),a=.5+n(),i=.1+3*n(),l=$n(n,[n(4)+1,n(4)+1],[[0,r+1+n(5)],[-2-n()*t/3,6+n()*t/2]],[[1,0],[1.5,.33*i],[1.5,.66*i],[1,i]]),c=sn(l);var f;K(f=c,O([1,0,0])),un(f);let s=$n(n,[n(3)+1,n(3)+1],[[-3,t],[-4*a,4*a]],[[1,-2*r],[1.5,-1*r],[1.5,1*r],[1,2*r]]);Pn(s,L([0,0,-1],o),L([0,1,0],o));let u=Z([s,l,c]);for(let n of u.verts)n.type=[7,e,0,0];return u}var Rn,Cn,kn,Nn,Un,On,Vn,qn={fMain:"uniform float time;\nuniform float pass;\n\nin vec3 vcell;\nin vec3 vat;\nin float dist;\n\nflat in float light;\nflat in vec3 vnorm;\nflat in vec4 vcolor;\n\nflat in ivec4 vtype;\nflat in int vshape;\n\nlayout(location = 0) out vec4 c0;\nlayout(location = 1) out vec4 c1;\n\nfloat hexDigitF(int n, int place) {\n  return float((n >> (place * 4)) & 15) / 15.;\n}\n\nint hex2Digit(int n, int place) {\n  return (n >> (place * 8)) % 256;\n}\n\nvoid main() {\n  //vec4 worldAt = \n  int itype = vtype.x;\n  int t1 = vtype.y;\n  int t2 = vtype.z;\n  float bright = light;\n  //vt = 2.0101000000;\n  if(itype == 2) {\n    float hm = hexDigitF(t2, 0);\n    float vm = hexDigitF(t2, 1);\n    float x = fract(vcell.x);\n    float y = fract(vcell.y);\n\n    float far = 0., near = 0.;\n\n    if(dist >= 500.) {\n      //bright *= float(vtype.a)/256.;\n      far = x > hm &&\n        x < 1. - hm &&\n        y > vm &&\n        y < 1. - vm ? -float(vtype.a) / 256. : .0;\n    }\n\n    if(dist <= 700.) {\n      float cols = float(hex2Digit(t1, 1));\n      float rows = float(hex2Digit(t1, 0));\n      float hb = hexDigitF(t2, 2);\n      float vb = hexDigitF(t2, 3);\n      near = x > hm &&\n        x < 1. - hm &&\n        y > vm &&\n        y < 1. - vm &&\n        (cols == 1. || fract((x - hm) / (1. - hm * 2.) * cols) > hb) &&\n        (rows == 1. || fract((y - vm) / (1. - vm * 2.) * rows) > vb) ? -1. : .0;\n    }\n\n    float l = clamp((dist - 500.) / 200., 0., 1.);\n    bright += mix(near, far, l);\n\n  } else if(itype == 4) {\n    bright += vat.z * 5e-4 + (fract(vat.y / 40. + 0.55) < .1 || fract(atan(vat.x, vat.z) / 3.141 * 36. + 0.45) < .1 ? -1. : 0.);\n  } else if(itype == 5) {\n    bright = 2.;\n  }\n\n  if(itype == 7) {\n    float y = fract(vcell.y);\n    bright += y < 0.03 || y > 0.97 || y>0.49 && y<0.51/* || mod(vcell.x,3. + sin(floor(vcell.y)*100.)) < 0.03*/? -.5 : .0;\n  }\n\n  if(bright > 0.)\n    bright += vcell.y * 0.05 - 0.3;\n  /*if(mod(vcell.x,0.2)<0.1 != mod(vcell.y,0.2)<0.1)\n    light /= 2.;*/\n  //c0 = vec4(light, 0., 0., 1.);\n  c0 = vec4(vcolor.rgb * bright, vcolor.a);\n  //c1 = vec4(gl_FrontFacing?0.:1.,0.,0.,0.);\n  //c1 = vec4(vat / 1000. + 0.5, 1.);\n  //c1 = vec4(1.,0.,0.,1.);\n  //if(pass == 0.)\n  //c1 = vec4(gl_FragCoord.xyz * gl_FragCoord.w, 1.);\n  //c1 = vec4(vnorm, 1.);\n  c1 = vec4(vnorm*0.5+0.5, gl_FragCoord.z * gl_FragCoord.w);\n}\n",vMain:"uniform mat4 camera;\r\nuniform mat4 flyer;\r\nuniform vec3 sun;\r\nuniform float time;\r\nuniform int consuming;\r\nuniform float consumingStage;\r\n\r\nuniform int liveDebris[32];\r\n\r\nin vec3 at;\r\nin vec3 norm;\r\nin vec3 cell;\r\nin vec4 type;\r\nin float shape;\r\n\r\nout vec3 vcell;\r\nout vec3 vat;\r\nout float dist;\r\nflat out float light;\r\n\r\nflat out vec3 vnorm;\r\nflat out vec4 vcolor;\r\n\r\nflat out ivec4 vtype;\r\nflat out int vshape;\r\n\r\nfloat rand(float n){return fract(sin(n) * 43758.5453123);}\r\n\r\nmat4 axisRotation(vec3 axis, float angle) {\r\n\r\n  float x = axis.x;\r\n  float y = axis.y;\r\n  float z = axis.z;\r\n\r\n  float n = sqrt(x * x + y * y + z * z);\r\n  x /= n;\r\n  y /= n;\r\n  z /= n;\r\n  float c = cos(angle);\r\n  float s = sin(angle);\r\n  float omc = 1. - c;\r\n\r\n  return mat4(x * x + (1. - x * x) * c, x * y * omc + z * s, x * z * omc - y * s, 0., x * y * omc - z * s, y * y + (1. - y * y) * c, y * z * omc + x * s, 0., x * z * omc + y * s, y * z * omc - x * s, z * z + (1. - z * z) * c, 0., 0., 0., 0., 1.);\r\n}\r\n\r\nvoid main() {\r\n  vat = at;\r\n  vnorm = norm;\r\n  vcell = cell;\r\n\r\n  vtype = ivec4(type);\r\n  vshape = int(shape);\r\n\r\n  vec4 at4 = vec4(at, 1.);\r\n\r\n  vcolor.rgb = vec3(1.);\r\n\r\n  if(vtype.x == 9) {\r\n    int swarm = vshape/32;\r\n    bool live = (liveDebris[swarm/30] & (1 << swarm%30)) != 0;\r\n    if(live || consuming == swarm){\r\n      vcolor.rgb = vec3(1.,0.,1.);\r\n      float a = rand(shape);\r\n      vec3 axis = normalize(vec3(rand(a+1.), rand(a+2.), rand(a+3.)));\r\n      //vec3 axis = vec3(1.,0.,0.);   \r\n      light -= a*0.3; \r\n      mat4 rot = axisRotation(axis, time * 5e-3 * (.5+rand(a+4.)) + rand(a+4.) );\r\n      vnorm = normalize((rot * vec4(norm, 1.)).xyz);\r\n      at4 = rot * at4;\r\n      at4.xyz += 25. * (vec3(rand(a+5.), rand(a+6.), rand(a+7.)) - .5);\r\n      at4.xyz += vec3(vtype.yzw);\r\n      if(!live)\r\n        at4.xyz = mix(at4.xyz, flyer[3].xyz, consumingStage);\r\n    } else {\r\n      at4 = vec4(1e6);\r\n    }\r\n  }\r\n\r\n  //int si = int(shape);\r\n\r\n  /*if(vshape > 0)\r\n    //vcolor.rgb = vec3(shape/10000., mod(shape,100.)/100., mod(shape,10.)/10.) * 1.5;\r\n    vcolor.rgb = vec3(1.);\r\n  else\r\n    vcolor.rgb = vec3(.9);*/\r\n  //color = vec4(1., 1., 0., 1.);\r\n\r\n\r\n  if(vtype.x == 3) {\r\n    at4 = flyer * at4;\r\n    mat4 fnorm = flyer;\r\n    fnorm[3] = vec4(0.);\r\n    vnorm = normalize((fnorm * vec4(norm, 1.)).xyz);\r\n  }\r\n\r\n  if(vtype.x == 7) {\r\n    int id = vtype.y;\r\n    if(id % 2 == 0) {\r\n      vnorm.y = -vnorm.y;\r\n      at4.y = -at4.y;\r\n    }\r\n    float shift = fract(fract(float(id) / 1e2) + time * 1e-5 * (id % 2 == 1 ? 3. : -3.));\r\n    at4.y = at4.y + 7300. - pow(shift * 120., 2.);\r\n    if(at4.y<0.){\r\n      at4.xz += vec2(rand(float(id))-.5,rand(float(id+1))-.5) * pow(at4.y/1e2,2.) ;\r\n    }\r\n  }\r\n\r\n  vec4 pos;\r\n\r\n  if(vtype.x == 8) {\r\n    pos = at4;\r\n  } else {\r\n    pos = camera * at4;\r\n  }\r\n\r\n  vat = at4.xyz;\r\n  pos.y = -pos.y;\r\n\r\n  vec3 toSun = sun - vat;\r\n  //vec3 toSun = vec3(0, 1000, 0);\r\n  light = dot(vnorm, normalize(toSun)) * 0.2 + .9 - length(toSun) * 1e-6;\r\n\r\n  if(vtype.x == 7) {\r\n    light += 0.2;\r\n  }\r\n\r\n  dist = distance(vat, flyer[3].xyz);\r\n\r\n  gl_Position = pos;\r\n}\r\n",fScreen:"uniform sampler2D T0;\nuniform sampler2D T1;\nuniform sampler2D Depth;\nuniform mat4 invCamera;\nuniform mat4 invPerspective;\nuniform mat4 flyer;\nuniform vec3 scp0;\nuniform vec3 scp1;\nuniform vec3 scp2;\n\nin vec2 uv;\n\nout vec4 color;\n\nfloat Noise2d(in vec2 x) {\n  float xhash = cos(x.x * 37.0);\n  float yhash = cos(x.y * 57.0);\n  return fract(415.92653 * (xhash + yhash));\n}\n\nint b16[16] = int[] (1, 9, 3, 11, 13, 5, 15, 7, 4, 12, 2, 10, 16, 8, 14, 6);\nint b64[64] = int[] (1, 33, 9, 41, 3, 35, 11, 43, 49, 17, 57, 25, 51, 19, 59, 27, 13, 45, 5, 37, 15, 47, 7, 39, 61, 29, 53, 21, 63, 31, 55, 23, 4, 36, 12, 44, 2, 34, 10, 42, 52, 20, 60, 28, 50, 18, 58, 26, 16, 48, 8, 40, 14, 46, 6, 38, 64, 32, 56, 24, 62, 30, 54, 22);\n\nfloat dither(float v, ivec2 F) {\n  return v * 75. > float(b64[F.y % 8 * 8 + F.x % 8]) ? 1. : 0.;\n}\n\nconst bool ditherOn = true;\nconst float collisionDepth = 0.6;\n\nvoid main() {\n\n  ivec2 F = ivec2(gl_FragCoord.xy);\n\n  float depth = texelFetch(Depth, F, 0).r;\n  color = vec4(1.);\n\n  vec4 screenPos = vec4(uv.x, -uv.y, depth * 2. - 1., 1.);\n\n  vec4 pos4 = invCamera * screenPos;\n  vec3 pos = (pos4 / pos4.w).xyz - flyer[3].xyz;\n\n  /*if(distance(vec2(scp0.x, scp0.y), vec2(F)) < 10.) {\n    color = vec4(1., 0., 0., 1.);\n    return;\n  }\n\n  if(distance(vec2(scp1.x, scp1.y), vec2(F)) < 10.) {\n    color = vec4(0., 1., 0., 1.);\n    return;\n  }\n\n  if(distance(vec2(scp2.x, scp2.y), vec2(F)) < 10.) {\n    color = vec4(0., 0., 1., 1.);\n    return;\n  }*/\n\n  if(F.y < 4 && F.x < 4) {\n    color = vec4(\n      texelFetch(Depth, ivec2(scp0.xy), 0).r < collisionDepth ? 1. : 0., \n      texelFetch(Depth, ivec2(scp1.xy), 0).r < collisionDepth ? 1. : 0., \n      texelFetch(Depth, ivec2(scp2.xy), 0).r < collisionDepth ? 1. : 0., 1.);\n    return;\n  }\n\n  if(depth == 1.) {\n\n    vec3 pos1 = pos / length(pos);\n\n    if(Noise2d(vec2(floor((pos1.x + pos1.y) * 3e2), floor(pos1.z * 3e2))) > 0.99)\n      color.xyz = pos1 * 0.5 + 0.5;\n    else\n      color.xyz = vec3(0.);\n\n  } else {\n    color = texelFetch(T0, F, 0);\n\n    if(color.r > 0.)\n      color = (color * 2. + texelFetch(T0, F + ivec2(1, 0), 0) + texelFetch(T0, F + ivec2(0, 1), 0)) * 0.25;\n\n    float diff = 0.;\n    for(int i = 0; i < 8; i++) {\n      int step = i / 4;\n      ivec2 place = ivec2(i % 2, i % 4 / 2) * step;\n      float edge = texelFetch(Depth, F + place, 0).r +\n        texelFetch(Depth, F - place, 0).r - depth * 2.;\n      diff += abs(edge);\n    }\n\n    if(depth > 0.99)\n      diff *= 1. + (depth - 0.99);\n\n    if(diff > .00005) {\n      color.rgb = normalize(color.rgb) * 0.3;\n    } else {\n      if(ditherOn) {\n        color.r = dither(color.r, F);\n        color.g = dither(color.g, F);\n        color.b = dither(color.b, F);\n      }\n    }\n\n    if(depth > 0.995 && (depth - 0.99) * 1000. > float(b64[F.y % 8 * 8 + F.x % 8])) {\n      color = vec4(1.);\n    }\n  }\n\n  //color = texelFetch(T1, F, 0);\n  color.a = 1.;\n}",vScreenQuad:"out vec2 uv;\n\nvoid main() {\n  int i = gl_VertexID;\n  ivec2 uvi = ivec2(i % 2, (i + 1) % 4 / 2) * 2 - 1;\n  gl_Position = vec4(uvi.x, uvi.y, 0, 1);\n  uv = vec2(uvi);\n  //gl_Position = vec4(i%2*2-1, 1-(i+1)%4/2*2, 0., 1.);\n}"};function Xn(n){let e=document.getElementById("C");return Vn=n,e.width=Vn[0],e.height=Vn[1],(rn=e.getContext("webgl2")).enable(2929),Rn=mn(qn.vMain,qn.fMain),kn=yn(Rn),Cn=mn(qn.vScreenQuad,qn.fScreen),Nn=yn(Cn),Un=dn([hn,hn,pn],Vn),On=function(n){const e=rn.createFramebuffer();rn.bindFramebuffer(Q,e);for(let e=0;e<n.length;e++){let t=n[e].format[1],r=34041==t?33306:6402==t?36096:36064+e;rn.framebufferTexture2D(Q,r,V,n[e].texture,0)}return rn.bindFramebuffer(Q,null),e}(Un),[Rn,e]}var Yn=[[-1,1,-1],[1,1,-1],[0,1,-1]];l(1);function Jn(n,[t,o],[a,i]){I.innerHTML=`LMB click to speed up, RMB to speed down. consuming ${n.consumingStage} | ${n.at.map((n=>~~n))} | ${Wn[0]};${Wn[1]};${Wn[2]}`;let l=n.time,[c,f,s]=U(h(h(n.at,u(n.dir,-5)),[0,0,0]),n.dir,Vn,r/4,[4,En+x(n.at,[0,3600,0])]),v=_(c),m=$(n.at,n.dir,[0,0,1]);m=S(m,L([0,0,1],-n.smoothDrot[0]*Math.PI/4/100)),m=S(m,L([1,0,0],-n.smoothDrot[1]*Math.PI/4/200));let p=Yn.map((n=>{let e=R(c,R(m,n));return e[0]=~~((.5*e[0]+.5)*Vn[0]),e[1]=~~((.5-.5*e[1])*Vn[1]),e[2]=0,e}));Date.now();rn.useProgram(Rn),xn(kn,{camera:c,flyer:m,sun:[0,En,0],time:l,"liveDebris[0]":n.liveDebris,consuming:n.consuming,consumingStage:n.consumingStage}),rn.bindFramebuffer(Q,On),rn.clear(16640),rn.drawBuffers([36064,36065]),xn(kn,{pass:0}),rn.bindBuffer(rn.ELEMENT_ARRAY_BUFFER,t.faces),wn(t,Rn),rn.drawElements(4,o.faces.length,X,0),async function(n){rn.readBuffer(j),await Promise.all(e(3,(e=>async function(n,e,t,r,o,a,i){const l=rn.createBuffer();return rn.bindBuffer(W,l),rn.bufferData(W,i.byteLength,35041),rn.readPixels(n,e,t,r,o,a,0),rn.bindBuffer(W,null),await zn(W,l,0,i),rn.deleteBuffer(l),i}(n[e][0],n[e][1],1,1,J,q,Wn[e]))))}(p),xn(kn,{pass:1}),rn.bindBuffer(rn.ELEMENT_ARRAY_BUFFER,a.faces),wn(a,Rn),rn.drawElements(4,i.faces.length,X,0),rn.useProgram(Cn),xn(Nn,{invCamera:v,flyer:m,time:l,invPerspective:_(f),scp0:p[0],scp1:p[1],scp2:p[2]}),function(n,e){for(let t=0;t<n.length;t++)rn.activeTexture(rn.TEXTURE0+t),e[t]&&e[t](t),rn.bindTexture(V,n[t].texture)}(Un,[Nn.T0,Nn.T1,Nn.Depth]),rn.bindFramebuffer(Q,null),rn.drawArrays(4,0,6),rn.flush()}var Qn,Wn=e(4,(n=>new Uint8Array(4)));var jn=1;var Gn=n=>2**(n/12)*440;l(Math.random());function Hn(n,e=3,t=1){let[r,o]=function(n="sine"){let e=Qn.createOscillator(),t=Qn.createGain();return e.type=n,e.connect(t),e.start(),t.connect(Qn.destination),[e,t]}();o.gain.setValueAtTime(jn*t*440/Gn(n),Qn.currentTime),r.frequency.setValueAtTime(Gn(n),Qn.currentTime),o.gain.exponentialRampToValueAtTime(1e-5,Qn.currentTime+e),r.stop(Qn.currentTime+e)}var Kn,Zn=Math.PI/180,ne=[90,0],ee=[0,0];var te=l(1);function re(n){Kn.time+=n;let e=((oe[0]?1:0)+(oe[2]?-1:0))*n*3e-4;Kn.vel+=Math.max(e,-Kn.vel),ee=ee.map((e=>Math.sign(e)*Math.min(30,Math.abs(e)*n*60))),Kn.drot[0]=Kn.drot[0]-.1*ee[0],Kn.drot[1]=Math.max(-89.999,Math.min(89.999,Kn.drot[1]-.1*ee[1]));let t=Math.min(1,.01*n);var r,o,a;Kn.smoothDrot=Kn.smoothDrot.map(((n,e)=>n*(1-t)+Kn.drot[e]*t)),Kn.rot=(r=Kn.rot,o=Kn.smoothDrot,a=.006,r.map(((n,e)=>n+o[e]*a))),Kn.rot[1]=Math.max(-89,Math.min(Kn.rot[1],89)),Kn.smoothDrot=b(Kn.smoothDrot,1-.2*t);let[i,l]=Kn.rot.map((n=>n*Zn));Kn.dir=v([Math.cos(l)*Math.cos(i),Math.cos(l)*Math.sin(i),Math.sin(l)]);Math.sin(i),Math.cos(i),Math.sin(i),Math.cos(i),Math.cos(i),Math.sin(i);ee[0],1-10*n,ee=[0,0],Kn.vel*=1-0*n;let c=u(Kn.dir,Kn.vel*n);Kn.at=h(Kn.at,c),Kn.debris.forEach(((n,e)=>{n.live&&((n,e)=>s(g(n,e)))(n.at,Kn.at)<50&&(n.live=!1,Hn(te(20)-20),Kn.consuming=e,Kn.consumingStage=0,Kn.liveDebris.fill(0),Kn.debris.forEach(((n,e)=>{n.live&&(Kn.liveDebris[~~(e/30)]+=1<<e%30)})))})),Kn.consuming>-1&&(Kn.consumingStage=Kn.consumingStage+n/100,Kn.consumingStage>1&&(Kn.consuming=-1));for(let n in[0,1,2]){let e=Wn[n][3];if(e>10){let t=[...Wn[n].slice(0,3)],r=v(p(t,-128)),o=-m(r,Kn.dir);Hn(te(20)-60,10*o,o**2),Kn.at=d(Kn.at,r,Kn.vel*o*e/2),Kn.vel>-.1&&(Kn.vel*=1-.01*o)}}}var oe=[];!function(){let n=Date.now(),[t,r,o]=In(),[a,i]=Xn([1200,800]);["keydown","keyup","mousedown","mouseup","mousemove"].forEach((n=>document.addEventListener(n,(n=>{switch(n.type){case"mousemove":e=ee,t=[n.movementX,n.movementY],ee=e.map(((n,e)=>n+t[e]));break;case"mousedown":oe[n.button]=!0;break;case"mouseup":oe[n.button]=!1}var e,t}))));let l=Kn={dir:[1,0,0],at:[0,-300,0],vel:.05,time:0,drot:[0,0],smoothDrot:[0,0],rot:ne,debris:[],consuming:-1,consumingStage:0,liveDebris:new Int32Array(e(32,(()=>2**30-1)))};l.debris=o;let c={at:[3],norm:[3],cell:[3],type:[4],shape:[1]},[f,s]=Dn(t,c),[u,v]=Dn(r,c);function m(n){re(n),Jn(l,[f,s],[u,v])}console.log(`${Date.now()-n} ms ${s.faces.length} faces`);let h=!1;function p(){return document.pointerLockElement==i}function d(n){null==n&&(n=!p()),n?i.requestPointerLock():document.exitPointerLock()}i.onclick=n=>{if(d(!0),!h){Qn=Qn||new window.AudioContext,jn=.1;let n=Date.now();const e=()=>{p()&&m(Date.now()-n),n=Date.now(),requestAnimationFrame(e)};e()}h=!0},document.onkeydown=n=>{switch(n.code){case"Space":d()}},m(0)}()})();