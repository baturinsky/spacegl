(()=>{var n,e=3553,t=36160;function r(e,t){let r=`#version 300 es\nprecision highp float;\nprecision highp int;\n\n${t}`;const o=n.createShader(e);n.shaderSource(o,r),n.compileShader(o);{const e=n.getShaderInfoLog(o);e&&(console.log("shader:",e),console.log(r.split("\n").map(((n,e)=>`${e+1}. ${n}`)).join("\n")))}return o}function o(e,t){var o=n.createProgram();return n.attachShader(o,r(35633,e)),n.attachShader(o,r(35632,t)),n.linkProgram(o),o}var a=[5121,6408],i=[5123,6402,33189];function c(e){const t={},r={5124:"i",5125:"ui",5126:"f",35676:"Matrix4fv"};for(let o=0;o<n.getProgramParameter(e,n.ACTIVE_UNIFORMS);++o){const a=n.getActiveUniform(e,o);console.log(a.name,a.type.toString(16));let i=r[a.type]||"i";const c=n.getUniformLocation(e,a.name);i.indexOf("Matrix")>=0?t[a.name]=(...e)=>n[`uniform${i}`](c,!1,...e):t[a.name]=(...e)=>n[`uniform${e.length}${i}`](c,...e)}return console.log(t),t}function l(){return n.createBuffer()}function f(e,t,r=34962){n.bindBuffer(r,e),n.bufferData(r,t,35044)}function u(e,t,r,o=3){let a=n.getAttribLocation(e,t);n.enableVertexAttribArray(a),n.bindBuffer(34962,r),n.vertexAttribPointer(a,o,5126,!1,0,0)}var m=n=>[...new Array(n)].map(((n,e)=>e));function v(n,e,t){let r=[],o=[],a=[];const i=2*t,c=2*t+1;r[i]=[0,0,0],o[i]=[0,0,-1],r[c]=[0,0,e],o[c]=[0,0,1];const l=2*Math.PI/t;for(let a=0;a<t;a++){let i=d(l*a),c=d(l*(a+.5)),f=n*i[0],u=n*i[1];r[a]=[f,u,0],r[a+t]=[f,u,e],o[a]=o[a+t]=[c[0],c[1],0]}for(let n=0;n<t;n++){let e=(n+1)%t;a[4*n]=[n,e,i],a[4*n+1]=[n+t,e+t,c],a[4*n+2]=[e,e+t,n],a[4*n+3]=[n+t,e+t,n]}return[r,a,o]}var s=(n,e)=>[n[0]*e,n[1]*e,n[2]*e],h=(n,e=1)=>s(n,e/(n=>Math.hypot(n[0],n[1],n[2]))(n)),g=(n,e)=>[n[1]*e[2]-n[2]*e[1],n[2]*e[0]-n[0]*e[2],n[0]*e[1]-n[1]*e[0]],d=n=>[Math.cos(n),Math.sin(n)],p=[0,1,0];var b=(n,e)=>[e[0].map((e=>function(n,e){const[t,r,o]=e,a=t*n[3]+r*n[7]+o*n[11]+n[15];return[(t*n[0]+r*n[4]+o*n[8]+n[12])/a,(t*n[1]+r*n[5]+o*n[9]+n[13])/a,(t*n[2]+r*n[6]+o*n[10]+n[14])/a]}(n,e))),e[1],e[2].map((e=>function(n,e){const[t,r,o]=e;return[t*n[0]+r*n[4]+o*n[8],t*n[1]+r*n[5]+o*n[9],t*n[2]+r*n[6]+o*n[10]]}(n,e)))],F=(n,e)=>n.map(((t,r)=>m(4).reduce(((t,o)=>t+e[r-r%4+o]*n[r%4+4*o]),0))),x=(n,e)=>n.map((n=>e*n)),y=n=>n[0]+n[5]+n[10]+n[15],M=(n,e,...t)=>{const r=x(e,n);return t.length?((n,e)=>n.map(((n,t)=>n+e[t])))(r,M(...t)):r};var T=m(16).map((n=>n%5?0:1));function w(n,e){let[t,r,o]=n;const a=Math.sqrt(t*t+r*r+o*o);t/=a,r/=a,o/=a;const i=Math.cos(e),c=Math.sin(e),l=1-i;return[t*t+(1-t*t)*i,t*r*l+o*c,t*o*l-r*c,0,t*r*l-o*c,r*r+(1-r*r)*i,r*o*l+t*c,0,t*o*l+r*c,r*o*l-t*c,o*o+(1-o*o)*i,0,0,0,0,1]}var A={fMain:"uniform float t;\n\nflat in vec3 normal;\nin vec2 uv;\n\nlayout(location = 0) out vec4 c0;\nlayout(location = 1) out vec4 c1;\n\nvoid main() {\n  //c0 = vec4(normal*0.5+0.5, 1.);  \n  float light = dot(normal, normalize(vec3(-1.,-2.,3.)));\n  c0 = vec4(vec3(light), 1.);\n  c1 = vec4(sin(gl_FragCoord.y*.5)+.5, 0., 0., 1.);\n}\n",vCamera:"uniform mat4 camera;\r\n\r\nin vec3 vert;\r\nin vec3 norm;\r\n\r\nout vec2 uv;\r\nflat out vec3 normal;\r\n\r\nvoid main() {  \r\n  vec4 glpos = camera * vec4(vert, 1.);  \r\n  glpos.y = - glpos.y;\r\n  gl_Position = glpos / glpos.w;\r\n  uv = vert.xy*0.5 + vec2(0.5);\r\n  normal = norm;\r\n}",fScreen:"uniform sampler2D T0;\nuniform sampler2D T1;\nuniform sampler2D Depth;\n\nout vec4 c;\n\nint bayer[16] = int[] (1, 9, 3, 11, 13, 5, 15, 7, 4, 12, 2, 10, 16, 8, 14, 6);\nint b64[64] = int[] (1,33,9,41,3,35,11,43,49,17,57,25,51,19,59,27,13,45,5,37,15,47,7,39,61,29,53,21,63,31,55,23,4,36,12,44,2,34,10,42,52,20,60,28,50,18,58,26,16,48,8,40,14,46,6,38,64,32,56,24,62,30,54,22);\n\nvoid main() {\n  ivec2 F = ivec2(gl_FragCoord.xy);\n  c = vec4(0.);\n  float depth = texelFetch(Depth, F, 0).r;\n  c.rgb = vec3(texelFetch(T0, F, 0).r*65. > float(b64[F.y%8*8 + F.x%8])?1.:0.);\n  //c.rgb = vec3(texelFetch(T0, F, 0).r*65. > float(F.y/1000%65));\n  //c.rgb = vec3(1. + sin(float(F.y)*2000.));\n  float diff = 0.;\n  for(int i = 0; i < 4; i++) {\n    float edge = texelFetch(Depth, F + ivec2(i % 2, i / 2), 0).r + texelFetch(Depth, F - ivec2(i % 2, i / 2), 0).r - depth * 2.;\n    diff += abs(edge);\n  }\n  if(diff > .0001)\n    c.rgb = vec3(0.);\n  if(depth == 1.)\n    c.rgb = vec3(1.);\n  c.a = 1.;\n}",vScreenQuad:"void main() {\n  int i = gl_VertexID;\n  gl_Position = vec4(i%2*2-1, 1-(i+1)%4/2*2, 0., 1.);\n}"},D=1600,P=document.getElementById("C");P.width=D,P.height=800,(n=P.getContext("webgl2")).enable(2929),console.log(Date.now());var S=[];!function(){for(let e=0;e<1e4;e++){let e=F([1,0,0,0,0,1,0,0,0,0,1,0,(n=[200*Math.random()-100,100*Math.random(),0])[0],n[1],n[2],1],w([0,0,1],6*Math.random()));S.push(b(e,v(1,1+Math.random()**5*5,3+~~(10*Math.random()))))}var n}();var E=function(n){let e=n.length,t=new Array(e+1);t[0]=[0,0,0];for(let r=0;r<e;r++)t[r+1]=t[r].map(((e,t)=>e+n[r][t].length));let r=[new Float32Array(3*t[e][0]),new Uint32Array(3*t[e][1]),new Float32Array(3*t[e][2])];return n.forEach(((n,e)=>{for(let o of[0,1,2])n[o].forEach(((n,a)=>{1==o&&(n=n.map((n=>n+t[e][0]))),r[o].set(n,3*(t[e][o]+a))}))})),r}(S),I=l(),_=l(),B=l();console.log(E),f(I,E[0]),f(B,E[1],34963),f(_,E[2]),console.log(Date.now());var C=[a,a,i].map((t=>function(t,r,o,a){const i=n.createTexture();return n.bindTexture(e,i),n.texImage2D(e,0,o[2]||o[1],t,r,0,o[1],o[0],a),i.fmt=o,n.texParameteri(e,10241,9728),n.texParameteri(e,10240,9728),n.bindTexture(e,null),i}(D,800,t))),U=function(r){const o=n.createFramebuffer();n.bindFramebuffer(t,o);for(let o=0;o<r.length;o++){let a=r[o].fmt&&r[o].fmt[1],i=34041==a?33306:6402==a?36096:36064+o;n.framebufferTexture2D(t,i,e,r[o],0)}return n.bindFramebuffer(t,null),o}(C),$=50*Math.PI/180,R=((n,e,t=p)=>{return((n,e,t=p)=>{const r=h(s(e,-1)),o=h(g(t,r)),a=g(o,r);return[o[0],o[1],o[2],0,a[0],a[1],a[2],0,r[0],r[1],r[2],0,n[0],n[1],n[2],1]})(n,(o=n,[(r=e)[0]-o[0],r[1]-o[1],r[2]-o[2]]),t);var r,o})([0,-10,20],[0,30,0],[0,0,1]),L=((n,e,t,r)=>{const o=1/Math.tan(.5*n),a=1/(t-r);return[o/e,0,0,0,0,o,0,0,0,0,(t+r)*a,-1,0,0,t*r*a*2,0]})($,2,.5,200),V=F(L,function(n){const e=F(n,n),t=F(n,e),r=F(e,e),o=y(n),a=y(e),i=y(t),c=(o**4-6*a*o*o+3*a*a+8*i*o-6*y(r))/24;let l=M((o*o*o-3*o*a+2*i)/6,T,-(o*o-a)/2,n,o,e,-1,t);return x(l,1/c)}(R)),k=o(A.vCamera,A.fMain),N=c(k),O=o(A.vScreenQuad,A.fScreen),Q=c(O);function j(){n.useProgram(k),N.camera(V),u(k,"vert",I,3),u(k,"norm",_,3),n.bindFramebuffer(t,U),n.drawBuffers([36064,36065]),n.clear(256),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,B),n.drawElements(4,E[1].length,5125,0),n.useProgram(O),function(t,r){for(let o=0;o<t.length;o++)n.activeTexture(n.TEXTURE0+o),r[o]&&r[o](o),n.bindTexture(e,t[o])}(C,[Q.T0,Q.T1,Q.Depth]),n.bindFramebuffer(t,null),n.drawArrays(4,0,6)}console.log("done"),window.onclick=j,j()})();