(()=>{var n=n=>[...new Array(n)].map(((n,t)=>t)),t=(n,t)=>[...new Array(n)].map(((n,e)=>t?t(e):e)),e=2*Math.PI,r=Math.PI,o=Math.PI/2,a=Math.PI/4,i=2**31;function l(n){0<n&&n<1&&(n=~~(n*i));let t=t=>(n=16807*n%2147483647)%t;return e=>-1==e?n:null==e?t(i)/i:t(e)}function c(n,t){let e={};for(let r in n)e[r]=t(n[r],r,n);return e}var f=[[1,0,0],[0,1,0],[0,0,1]],s=(n,t)=>[n[0]*t,n[1]*t,n[2]*t],u=(n,t=1)=>s(n,t/(n=>(n[0]*n[0]+n[1]*n[1]+n[2]*n[2])**.5)(n)),v=(n,t)=>n[0]*t[0]+n[1]*t[1]+n[2]*t[2],h=(n,t)=>[n[0]+t[0],n[1]+t[1],n[2]+t[2]],m=(n,t)=>[n[0]+t,n[1]+t,n[2]+t],p=(n,t,e)=>[n[0]+t[0]*e,n[1]+t[1]*e,n[2]+t[2]*e],d=(n,t)=>[n[0]-t[0],n[1]-t[1],n[2]-t[2]],y=(n,t)=>[n[1]*t[2]-n[2]*t[1],n[2]*t[0]-n[0]*t[2],n[0]*t[1]-n[1]*t[0]],x=n=>[n(),n(),n()],g=(n,t)=>(n=>F(n,n)**.5)(M(n,t)),b=(n,t)=>n.map((n=>n*t)),F=(n,t)=>n.reduce(((n,e,r)=>n+e*t[r]),0),M=(n,t)=>n.map(((n,e)=>n-t[e])),D=n=>[Math.cos(n),Math.sin(n)],w=(n,t,e)=>n.map(((n,r)=>n*(1-e)+t[r]*e)),z=f[1],P=n(16).map((n=>n%5?0:1)),A=(n,t)=>n.map(((e,r)=>{let o=r%4,a=r-o;return t[a]*n[o]+t[a+1]*n[o+4]+t[a+2]*n[o+8]+t[a+3]*n[o+12]})),E=(...n)=>1==n.length?n[0]:E(...n.slice(0,n.length-2),A(n[n.length-1],n[n.length-2])),T=(n,t)=>n.map((n=>t*n)),S=n=>n[0]+n[5]+n[10]+n[15],B=(n,t,...e)=>{const r=T(t,n);return e.length?((n,t)=>n.map(((n,e)=>n+t[e])))(r,B(...e)):r};function _(n){let[t,e,r,o,a,i]=function(n){const t=A(n,n),e=A(n,t),r=A(t,t),o=S(n),a=S(t),i=S(e);return[(o**4-6*a*o*o+3*a*a+8*i*o-6*S(r))/24,t,e,o,a,i]}(n),l=B((o*o*o-3*o*a+2*i)/6,P,-(o*o-a)/2,n,o,e,-1,r);return T(l,1/t)}var L=(n,t,e=z)=>{const r=u(s(t,-1)),o=u(y(e,r)),a=y(o,r);return[o[0],o[1],o[2],0,a[0],a[1],a[2],0,r[0],r[1],r[2],0,n[0],n[1],n[2],1]};function R(n,t){let[e,r,o]=n;const a=Math.sqrt(e*e+r*r+o*o);e/=a,r/=a,o/=a;const i=Math.cos(t),l=Math.sin(t),c=1-i;return[e*e+(1-e*e)*i,e*r*c+o*l,e*o*c-r*l,0,e*r*c-o*l,r*r+(1-r*r)*i,r*o*c+e*l,0,e*o*c+r*l,r*o*c-e*l,o*o+(1-o*o)*i,0,0,0,0,1]}function $(n,t){const[e,r,o]=t,a=e*n[3]+r*n[7]+o*n[11]+n[15];return[(e*n[0]+r*n[4]+o*n[8]+n[12])/a,(e*n[1]+r*n[5]+o*n[9]+n[13])/a,(e*n[2]+r*n[6]+o*n[10]+n[14])/a]}var k=t=>n(16).map((n=>15==n?1:n%5?0:t)),C=t=>n(16).map((n=>15==n?1:n%5?0:t[n/5])),N=n=>[1,0,0,0,0,1,0,0,0,0,1,0,n[0],n[1],n[2],1];function U(n,t,[e,r],o,[a,i]){let l=e/r;const c=((n,t,e=z)=>L(n,d(t,n),e))(n,h(n,t),f[2]),s=((n,t,e,r)=>{const o=1/Math.tan(.5*n),a=1/(e-r);return[o/t,0,0,0,0,o,0,0,0,0,(e+r)*a,-1,0,0,e*r*a*2,0]})(o,l,a,i);return[A(s,_(c)),s,c]}function O([n,t,e]){return[1-2*n*n,-2*n*t,-2*n*e,0,-2*n*t,1-2*t*t,-2*t*e,0,-2*n*e,-2*t*e,1-2*e*e,0,0,0,0,1]}var q=3553,V=5121,X=5125,Y=5126,J=6408,Q=36160,W=35051,j=36065,H={at:[3],norm:[3],cell:[3]};function G(n){for(let t of n.faces)(null==t[2].norm||Number.isNaN(t[2].norm[0]))&&(t[2].norm=u(y(d(t[0].at,t[2].at),d(t[1].at,t[2].at))))}var K=(n,...t)=>{let e=E(...t);for(let t of n.verts)t.at=$(e,t.at)};function Z(n){return(t={faces:tn(n.map((n=>n.faces))),verts:tn(n.map((n=>n.verts)))}).verts.forEach(((n,t)=>n.ind=t)),t;var t}function nn(n){let t=0;return[0,...n.map((n=>t+=n.length))]}function tn(n,t=(n=>new Array(n))){const e=nn(n);let r,o=t(e[n.length]);for(let t=n.length-1;t>=0;t--){r=0==t?0:e[t];for(let e=n[t].length-1;e>=0;e--)o[r+e]=n[t][e]}return o}function en(n,t,e){let r=new Array(n*t*2),o=new Array((n+1)*(t+1)),a=n+1;for(let r=0;r<=n;r++)for(let n=0;n<=t;n++)o[n*a+r]={at:e(r,n),cell:[r,n,0],ind:n*a+r};for(let e=0;e<n;e++)for(let i=0;i<t;i++){const t=2*(i*n+e),l=i*a+e;r[t]=[o[l+1+a],o[l+a],o[l]],r[t+1]=[o[l+1],o[l+1+a],o[l]]}return{faces:r,verts:o}}var rn,on=(n,t)=>(e,r)=>[n[e%n.length][0]*t[r][0],n[e%n.length][1]*t[r][0],t[r][1]],an=(n,t)=>ln(n,t,on),ln=(n,t,e)=>en(n.length,t.length-1,e(n,t)),cn=(n,t)=>tn(n.map(((e,r)=>{let o=n[(r+1)%n.length];return[w(e,o,t),w(e,o,1-t)]}))),fn=(n,t)=>tn(n.map(((e,r)=>{let o=n[(r+1)%n.length],a=g(e,o),i=t/a;return[w(e,o,i),w(e,o,1-i)]})));function sn(n){let t={...n};return t.verts=JSON.parse(JSON.stringify(n.verts)),t.faces=n.faces.map((n=>n.map((n=>t.verts[n.ind])))),t}function un(n){n.faces=n.faces.map((n=>[n[1],n[0],n[2]]))}function vn(n,t){for(let e of n.verts)e.type=t(e)}function hn(n,t){let e=`#version 300 es\nprecision highp float;\nprecision highp int;\n\n${t}`;const r=rn.createShader(n);rn.shaderSource(r,e),rn.compileShader(r);{const n=rn.getShaderInfoLog(r);n&&(console.log("shader:",n),console.log(e.split("\n").map(((n,t)=>`${t+1}. ${n}`)).join("\n")))}return r}function mn(n,t){var e=rn.createProgram();return rn.attachShader(e,hn(35633,n)),rn.attachShader(e,hn(35632,t)),rn.linkProgram(e),e}var pn=[5121,6408],dn=[5123,6402,33189];function yn(n,[t,e]){return n.map((n=>function(n,t,e,r){const o=rn.createTexture();return rn.bindTexture(q,o),rn.texImage2D(q,0,e[2]||e[1],n,t,0,e[1],e[0],r),rn.texParameteri(q,10241,9728),rn.texParameteri(q,10240,9728),rn.bindTexture(q,null),{texture:o,format:e}}(t,e,n)))}var xn={5124:"i",[X]:"ui",[Y]:"f",35665:"f",35676:"Matrix4fv"};function gn(n){const t={};for(let e=0;e<rn.getProgramParameter(n,rn.ACTIVE_UNIFORMS);++e){const r=rn.getActiveUniform(n,e);let o=xn[r.type]||"i";const a=rn.getUniformLocation(n,r.name);o.indexOf("Matrix")>=0?t[r.name]=(...n)=>rn[`uniform${o}`](a,!1,...n):t[r.name]=(...n)=>{n[0].length>0&&(n=n[0]),rn[`uniform${n.length}${o}`](a,...n)}}return t}function bn(n,t){for(let e in t)n[e]&&n[e](t[e])}function Fn(n,t,e,r=3,o=5126){let a=rn.getAttribLocation(n,t);rn.enableVertexAttribArray(a),rn.bindBuffer(34962,e),rn.vertexAttribPointer(a,r,o,!1,0,0)}function Mn(){return rn.createBuffer()}function Dn(n,t,e=34962){rn.bindBuffer(e,n),rn.bufferData(e,t,35044),rn.bindBuffer(e,null)}function wn(n,t){for(let e in n.verts)Fn(t,e,n.verts[e],n.attrs[e][0],n.attrs[e][1]||Y)}function zn(n,t){let e=function(n,t){let e=n.length,r=nn(n.map((n=>n.faces))),o=nn(n.map((n=>n.verts))),a=new Uint32Array(3*r[e]),i=c(t,(n=>n[1]&&n[1]!=Y?new Int32Array(o[e]*n[0]):new Float32Array(o[e]*n[0]))),l=0;n.forEach(((n,t)=>{for(let e of n.faces){const n=o[t];a[l++]=e[0].ind+n,a[l++]=e[1].ind+n,a[l++]=e[2].ind+n}}));for(let e in i){let r=t[e][0],o=i[e],a=0;if(1==r)for(let t of n)for(let n of t.verts)n[e]&&(o[a]=n[e]),a++;else for(let t of n)for(let n of t.verts)n[e]&&o.set(n[e],a*r),a++}return{faces:a,verts:i}}(n,t),r=function(n=H){return{faces:Mn(),verts:c(n,(n=>Mn())),attrs:n}}(t);return function(n,t){Dn(n.faces,t.faces,34963);for(let e in t.verts)Dn(n.verts[e],t.verts[e])}(r,e),[r,e]}async function Pn(n,t,e,r,o,a){const i=rn.fenceSync(37143,0);return rn.flush(),await function(n,t,e){return new Promise(((r,o)=>{!function a(){const i=rn.clientWaitSync(n,t,0);i!=rn.WAIT_FAILED?i!=rn.TIMEOUT_EXPIRED?r(null):setTimeout(a,e):o()}()}))}(i,0,10),rn.deleteSync(i),rn.bindBuffer(n,t),rn.getBufferSubData(n,e,r,o,a),rn.bindBuffer(n,null),r}var An=K,En=72,Tn=400,In=12960,Sn=7200;function Bn(){let n=l(1),a=function(n){let o=[],a=function(n){let t=new Array(In),o=new Array(In);for(let a=0;a<In;a++){if(o[a])continue;let i=[n(4)?0:n(3),n(4)?0:n(3)],l=a%En/En*e,c=Math.sin(6*l+r/2),f=Math.min(1.4-3*Math.abs(.5-a/In),.5*c+1),s=0;if(f>.3*n()){let e=30+n(10);!n(10)&&c>0&&(e*=1.2),e=Math.min(18,e),s=20*f*(8+n(10));let r=_n(n,e*(.5+.5*n()),a,s/e);if(e*=1-(.1+i[0]+i[1]),t[a]=r,o[a]=s,r.extend=i,r.height=s,i[0]>1||i[1]>1)for(let n=0;n<=i[0];n++)for(let t=0;t<=i[1];t++)o[a+n+t*En]=s}}return t}(n);(function(n){let t=[];for(let t=0;t<In;t++){let r=n[t];if(!r)continue;let o=t%En/En*e+r.extend[0]/2;(r.extend[0]>1||r.extend[1]>1)&&An(r,C([r.extend[0]+1,r.extend[1]+1,1])),An(r,N([0,t/In*Sn+40*r.extend[1]/2,-400]),R(f[1],o))}})(a),a.forEach((n=>n&&o.push(n)));let i=function(n,r,o,a,i){let l=(n=>t(n,(t=>D(t/(n-1)*e))))(r),c=[];for(let t=0;t<r-1;t++){let e=1e3*n(),f=t/r*6%1<.5?.8:1,s=an([b(l[t],o),b(l[(t+1)%r],o),b(l[(t+1)%r],a),b(l[t],a)].reverse(),[[1,-e],[1,.96*i],[f,.98*i],[f,1.03*i]]);c.push(s)}let f=an(l,[[0,i],[a,i],[1.2*a,i],[1.2*a,1.2*i],[0,1.2*i]]);for(let n of f.verts)0==n.cell[1]&&(n.type=[5,0,0,0]);let s=Z([f,...c]);return vn(s,(n=>n.type||[4,0,0,0])),s}(n,72,Tn,520,7200);return An(i,R(f[0],-Math.PI/2)),o.push(i),o}(n),i=[],c=function(){let n=an(fn([[0,-4],[6,-5],[0,4],[-6,-5]],2),[[0,0],[.8,0],[1,.5],[1,1],[.8,1.1],[0,1.1]]);An(n,N([0,3,5]));let t=an(fn([[-1,0],[1,0],[1,2],[-1,2]],.5),[[0,0],[.8,0],[1,1],[1,1],[.5,3],[0,3]]);An(t,R([1,0,0],-o),N([2,-1.5,6.2]));let e=sn(t);An(e,O([1,0,0])),un(e);let r=an(fn([[1,-4],[1,7],[0,10],[-1,7],[-1,-4]],1),[[0,1],[.8,1],[1,2],[1,3],[.4,4],[0,4]]);An(r,N([0,2,3.5]));let a=Z([r,n,t,e]);return vn(a,(n=>[3,0,0,0])),An(a,k(.2),R([0,-1,0],Math.PI),R([-1,0,0],Math.PI/2),N([0,2,0])),a}();i.push(c);for(let t=0;t<150;t++){let i=$n(n,t),l=t%6;An(i,R([0,1,0],o+(l<3?r:0)),k(n(5)+2),N([0,0,Tn*(.35+.15*n())]),R([0,1,0],l*e/6+5*e/12+.2*n()-.1)),a.push(i)}for(let t=0;t<100;t++){let t=s(x(n),100);for(let e=0;e<20;e++){let e=3*n()+1,r={faces:[u=[[-e/2,-e/2,0],[-e/2,e,0],[e/2,-e/2,0]].map(((n,t)=>({ind:t,at:n})))],verts:u};vn(r,(()=>[9,...t])),i.push(r)}}var u;let v=0;for(let n of[...a,...i]){v++,G(n);for(let t of n.verts)t.shape=v}return[a,i]}function _n(n,r,o,i){let l,c,f;if(n(4))[c,f]=Ln(n,i/2,r*(.5+.4*n()),!0),l=[[1,1],[-1,1],[-1,-1],[1,-1]];else{let o=n(4)+4;[c,f]=Ln(n,i,r),l=t(o,(n=>((n,t=0)=>r=>D(e/n*r+t))(o,a)(n))),n(3)||(l=cn(l,.1)),0==n(4)&&l.forEach((n=>n[1]+=.95))}let s=ln(l,c,on);for(let n of s.verts)n.type=f?f[n.cell[1]]:[2,0,0,0];return s}function Ln(n,t,e,r=!1){let[o,a]=[1,0],i=[[o*e,0]],l=[],c=2,[f,s]=function(n){return[[n(6)+2,n(6)+2,n(6),n(6)],[(n()+.3)/4,n()+.3]]}(n);for(;a<t;){let v=c>1?0:o*(.1+.5*n())*(n(4)?-1:1);(o+v>1||o+v<.3)&&(v=-v);let h=r?t:(c>0?1:0)*(.5*n()*(1.1*t-a));a<5&&h>0&&h++,o+=v,a+=h,a>t&&(a=t),i.push([o*e,a*e]);let m=~~(h*s[0]*e)||1,p=~~(o*s[1]*e)||1,d=(1-f[0]/15)*(1-f[1]/15);0!=v&&(m=1),l.push([2,256*m+p,(u=f,u.reduce(((n,t)=>16*n+t))),256*d]);let y=n(3);c=0==y&&0==c?2:y}var u;return i.push([0,a*e]),l.push([2,2056,57344,0]),[i,l]}function Rn(n,t,e,r){let o=[n()*e[1][0],n()*e[1][1]],a=e[0][0],i=[[[a,o[0]]],[[a,o[1]]]],l=(e[0][1]-e[0][0])/(t[0]+t[1]);if(!(l<0)){for(let r=0;r<20&&(a+=n()*l*2,a>e[0][1]&&(a=e[0][1]),n()<t[0]/(t[0]+t[1])&&(o[0]=n()*e[1][0]),n()<t[1]/(t[0]+t[1])&&(o[1]=n()*e[1][1]),i[0].push([a,o[0]]),i[1].push([a,o[1]]),!(a>=e[0][1]));r++);return i[0].push([a,o[0]]),i[1].push([a,o[1]]),((n,t)=>{let e=t[0][1],r=t[t.length-1][1];const o=t=>en(n.length/2,1,((e,r)=>[...n[0==r?e:n.length-e-1],t]));let a=o(e),i=o(r);return un(a),Z([an(n,t),a,i])})(cn([...i[0],...i[1].reverse()].map((n=>[n[0],n[1]/2])),.1),r)}}function $n(n,t){let e=5+n(15),r=.5+n(),a=.5+n(),i=.1+3*n(),l=Rn(n,[n(4)+1,n(4)+1],[[0,r+1+n(5)],[-2-n()*e/3,6+n()*e/2]],[[1,0],[1.5,.33*i],[1.5,.66*i],[1,i]]),c=sn(l);var f;K(f=c,O([1,0,0])),un(f);let s=Rn(n,[n(3)+1,n(3)+1],[[-3,e],[-4*a,4*a]],[[1,-2*r],[1.5,-1*r],[1.5,1*r],[1,2*r]]);An(s,R([0,0,-1],o),R([0,1,0],o));let u=Z([s,l,c]);for(let n of u.verts)n.type=[7,t,0,0];return u}var kn,Cn,Nn,Un,On,qn,Vn,Xn={fMain:"uniform float time;\nuniform float pass;\n\nin vec3 vcell;\nin vec3 vat;\nin float dist;\n\nflat in float light;\nflat in vec3 vnorm;\nflat in vec4 vcolor;\n\nflat in ivec4 vtype;\nflat in int vshape;\n\nlayout(location = 0) out vec4 c0;\nlayout(location = 1) out vec4 c1;\n\nfloat hexDigitF(int n, int place) {\n  return float((n >> (place * 4)) & 15) / 15.;\n}\n\nint hex2Digit(int n, int place) {\n  return (n >> (place * 8)) % 256;\n}\n\nvoid main() {\n  //vec4 worldAt = \n  int itype = vtype.x;\n  int t1 = vtype.y;\n  int t2 = vtype.z;\n  float bright = light;\n  //vt = 2.0101000000;\n  if(itype == 2) {\n    float hm = hexDigitF(t2, 0);\n    float vm = hexDigitF(t2, 1);\n    float x = fract(vcell.x);\n    float y = fract(vcell.y);\n\n    float far = 0., near = 0.;\n\n    if(dist >= 500.) {\n      //bright *= float(vtype.a)/256.;\n      far = x > hm &&\n        x < 1. - hm &&\n        y > vm &&\n        y < 1. - vm ? -float(vtype.a) / 256. : .0;\n    }\n\n    if(dist <= 700.) {\n      float cols = float(hex2Digit(t1, 1));\n      float rows = float(hex2Digit(t1, 0));\n      float hb = hexDigitF(t2, 2);\n      float vb = hexDigitF(t2, 3);\n      near = x > hm &&\n        x < 1. - hm &&\n        y > vm &&\n        y < 1. - vm &&\n        (cols == 1. || fract((x - hm) / (1. - hm * 2.) * cols) > hb) &&\n        (rows == 1. || fract((y - vm) / (1. - vm * 2.) * rows) > vb) ? -1. : .0;\n    }\n\n    float l = clamp((dist - 500.) / 200., 0., 1.);\n    bright += mix(near, far, l);\n\n  } else if(itype == 4) {\n    bright += vat.z * 5e-4 + (fract(vat.y / 40. + 0.55) < .1 || fract(atan(vat.x, vat.z) / 3.141 * 36. + 0.45) < .1 ? -1. : 0.);\n  } else if(itype == 5) {\n    bright = 2.;\n  }\n\n  if(itype == 7) {\n    float y = fract(vcell.y);\n    bright += y < 0.03 || y > 0.97 || y>0.49 && y<0.51/* || mod(vcell.x,3. + sin(floor(vcell.y)*100.)) < 0.03*/? -.5 : .0;\n  }\n\n  if(bright > 0.)\n    bright += vcell.y * 0.05 - 0.3;\n  /*if(mod(vcell.x,0.2)<0.1 != mod(vcell.y,0.2)<0.1)\n    light /= 2.;*/\n  //c0 = vec4(light, 0., 0., 1.);\n  c0 = vec4(vcolor.rgb * bright, vcolor.a);\n  //c1 = vec4(gl_FrontFacing?0.:1.,0.,0.,0.);\n  //c1 = vec4(vat / 1000. + 0.5, 1.);\n  //c1 = vec4(1.,0.,0.,1.);\n  //if(pass == 0.)\n  //c1 = vec4(gl_FragCoord.xyz * gl_FragCoord.w, 1.);\n  //c1 = vec4(vnorm, 1.);\n  c1 = vec4(vnorm*0.5+0.5, gl_FragCoord.z * gl_FragCoord.w);\n}\n",vMain:"uniform mat4 camera;\r\nuniform mat4 flyer;\r\nuniform vec3 sun;\r\nuniform float time;\r\n\r\nin vec3 at;\r\nin vec3 norm;\r\nin vec3 cell;\r\nin vec4 type;\r\nin float shape;\r\n\r\nout vec3 vcell;\r\nout vec3 vat;\r\nout float dist;\r\nflat out float light;\r\n\r\nflat out vec3 vnorm;\r\nflat out vec4 vcolor;\r\n\r\nflat out ivec4 vtype;\r\nflat out int vshape;\r\n\r\nfloat rand(float n){return fract(sin(n) * 43758.5453123);}\r\n\r\nmat4 axisRotation(vec3 axis, float angle) {\r\n\r\n  float x = axis.x;\r\n  float y = axis.y;\r\n  float z = axis.z;\r\n\r\n  float n = sqrt(x * x + y * y + z * z);\r\n  x /= n;\r\n  y /= n;\r\n  z /= n;\r\n  float c = cos(angle);\r\n  float s = sin(angle);\r\n  float omc = 1. - c;\r\n\r\n  return mat4(x * x + (1. - x * x) * c, x * y * omc + z * s, x * z * omc - y * s, 0., x * y * omc - z * s, y * y + (1. - y * y) * c, y * z * omc + x * s, 0., x * z * omc + y * s, y * z * omc - x * s, z * z + (1. - z * z) * c, 0., 0., 0., 0., 1.);\r\n}\r\n\r\nvoid main() {\r\n  vat = at;\r\n  vnorm = norm;\r\n  vcell = cell;\r\n\r\n  vtype = ivec4(type);\r\n  vshape = int(shape);\r\n\r\n  vec4 at4 = vec4(at, 1.);\r\n\r\n  if(vtype.x == 9) {\r\n    float a = rand(shape);\r\n    vec3 axis = normalize(vec3(rand(a+1.), rand(a+2.), rand(a+3.)));\r\n    //vec3 axis = vec3(1.,0.,0.);   \r\n    light -= a*0.3; \r\n    at4 = axisRotation(axis, time * 5e-3 * (.5+rand(a+4.)) + rand(a+4.) ) * at4;\r\n    at4.xyz += 10. * (vec3(rand(a+5.), rand(a+6.), rand(a+7.)) - .5);\r\n    at4.xyz += vec3(vtype.yzw);\r\n  }\r\n\r\n  //int si = int(shape);\r\n\r\n  if(vshape > 0)\r\n    //vcolor.rgb = vec3(shape/10000., mod(shape,100.)/100., mod(shape,10.)/10.) * 1.5;\r\n    vcolor.rgb = vec3(1.);\r\n  else\r\n    vcolor.rgb = vec3(.9);\r\n  //color = vec4(1., 1., 0., 1.);\r\n\r\n  if(vtype.x == 3) {\r\n    at4 = flyer * at4;\r\n    mat4 fnorm = flyer;\r\n    fnorm[3] = vec4(0.);\r\n    vnorm = normalize((fnorm * vec4(norm, 1.)).xyz);\r\n  }\r\n\r\n  if(vtype.x == 7) {\r\n    int id = vtype.y;\r\n    if(id % 2 == 0) {\r\n      vnorm.y = -vnorm.y;\r\n      at4.y = -at4.y;\r\n    }\r\n    float shift = fract(fract(float(id) / 1e2) + time * 1e-5 * (id % 2 == 1 ? 3. : -3.));\r\n    at4.y = at4.y + 7300. - pow(shift * 120., 2.);\r\n  }\r\n\r\n  vec4 pos;\r\n\r\n  if(vtype.x == 8) {\r\n    pos = at4;\r\n  } else {\r\n    pos = camera * at4;\r\n  }\r\n\r\n  vat = at4.xyz;\r\n  pos.y = -pos.y;\r\n\r\n  vec3 toSun = sun - vat;\r\n  //vec3 toSun = vec3(0, 1000, 0);\r\n  light = dot(vnorm, normalize(toSun)) * 0.2 + .9 - length(toSun) * 1e-6;\r\n\r\n  if(vtype.x == 7) {\r\n    light += 0.2;\r\n  }\r\n\r\n  dist = distance(vat, flyer[3].xyz);\r\n\r\n  gl_Position = pos;\r\n}\r\n",fScreen:"uniform sampler2D T0;\nuniform sampler2D T1;\nuniform sampler2D Depth;\nuniform mat4 invCamera;\nuniform mat4 invPerspective;\nuniform mat4 flyer;\nuniform vec3 scp0;\nuniform vec3 scp1;\nuniform vec3 scp2;\n\nin vec2 uv;\n\nout vec4 color;\n\nfloat Noise2d(in vec2 x) {\n  float xhash = cos(x.x * 37.0);\n  float yhash = cos(x.y * 57.0);\n  return fract(415.92653 * (xhash + yhash));\n}\n\nint b16[16] = int[] (1, 9, 3, 11, 13, 5, 15, 7, 4, 12, 2, 10, 16, 8, 14, 6);\nint b64[64] = int[] (1, 33, 9, 41, 3, 35, 11, 43, 49, 17, 57, 25, 51, 19, 59, 27, 13, 45, 5, 37, 15, 47, 7, 39, 61, 29, 53, 21, 63, 31, 55, 23, 4, 36, 12, 44, 2, 34, 10, 42, 52, 20, 60, 28, 50, 18, 58, 26, 16, 48, 8, 40, 14, 46, 6, 38, 64, 32, 56, 24, 62, 30, 54, 22);\n\nfloat dither(float v, ivec2 F) {\n  return v * 75. > float(b64[F.y % 8 * 8 + F.x % 8]) ? 1. : 0.;\n}\n\nconst bool ditherOn = true;\nconst float collisionDepth = 0.6;\n\nvoid main() {\n\n  ivec2 F = ivec2(gl_FragCoord.xy);\n\n  float depth = texelFetch(Depth, F, 0).r;\n  color = vec4(1.);\n\n  vec4 screenPos = vec4(uv.x, -uv.y, depth * 2. - 1., 1.);\n\n  vec4 pos4 = invCamera * screenPos;\n  vec3 pos = (pos4 / pos4.w).xyz - flyer[3].xyz;\n\n  if(distance(vec2(scp0.x, scp0.y), vec2(F)) < 10.) {\n    color = vec4(1., 0., 0., 1.);\n    return;\n  }\n\n  if(distance(vec2(scp1.x, scp1.y), vec2(F)) < 10.) {\n    color = vec4(0., 1., 0., 1.);\n    return;\n  }\n\n  if(distance(vec2(scp2.x, scp2.y), vec2(F)) < 10.) {\n    color = vec4(0., 0., 1., 1.);\n    return;\n  }\n\n  if(F.y < 4 && F.x < 4) {\n    color = vec4(\n      texelFetch(Depth, ivec2(scp0.xy), 0).r < collisionDepth ? 1. : 0., \n      texelFetch(Depth, ivec2(scp1.xy), 0).r < collisionDepth ? 1. : 0., \n      texelFetch(Depth, ivec2(scp2.xy), 0).r < collisionDepth ? 1. : 0., 1.);\n    return;\n  }\n\n  if(depth == 1.) {\n\n    vec3 pos1 = pos / length(pos);\n\n    if(Noise2d(vec2(floor((pos1.x + pos1.y) * 3e2), floor(pos1.z * 3e2))) > 0.99)\n      color.xyz = pos1 * 0.5 + 0.5;\n    else\n      color.xyz = vec3(0.);\n\n  } else {\n    color = texelFetch(T0, F, 0);\n\n    if(color.r > 0.)\n      color = (color * 2. + texelFetch(T0, F + ivec2(1, 0), 0) + texelFetch(T0, F + ivec2(0, 1), 0)) * 0.25;\n\n    float diff = 0.;\n    for(int i = 0; i < 8; i++) {\n      int step = i / 4;\n      ivec2 place = ivec2(i % 2, i % 4 / 2) * step;\n      float edge = texelFetch(Depth, F + place, 0).r +\n        texelFetch(Depth, F - place, 0).r - depth * 2.;\n      diff += abs(edge);\n    }\n\n    if(depth > 0.99)\n      diff *= 1. + (depth - 0.99);\n\n    if(diff > .00005) {\n      color.rgb = normalize(color.rgb) * 0.3;\n    } else {\n      if(ditherOn) {\n        color.r = dither(color.r, F);\n        color.g = dither(color.g, F);\n        color.b = dither(color.b, F);\n      }\n    }\n\n    if(depth > 0.995 && (depth - 0.99) * 1000. > float(b64[F.y % 8 * 8 + F.x % 8])) {\n      color = vec4(1.);\n    }\n  }\n\n  //color = texelFetch(T1, F, 0);\n  color.a = 1.;\n}",vScreenQuad:"out vec2 uv;\n\nvoid main() {\n  int i = gl_VertexID;\n  ivec2 uvi = ivec2(i % 2, (i + 1) % 4 / 2) * 2 - 1;\n  gl_Position = vec4(uvi.x, uvi.y, 0, 1);\n  uv = vec2(uvi);\n  //gl_Position = vec4(i%2*2-1, 1-(i+1)%4/2*2, 0., 1.);\n}"};function Yn(n){let t=document.getElementById("C");return Vn=n,t.width=Vn[0],t.height=Vn[1],(rn=t.getContext("webgl2")).enable(2929),kn=mn(Xn.vMain,Xn.fMain),Nn=gn(kn),Cn=mn(Xn.vScreenQuad,Xn.fScreen),Un=gn(Cn),On=yn([pn,pn,dn],Vn),qn=function(n){const t=rn.createFramebuffer();rn.bindFramebuffer(Q,t);for(let t=0;t<n.length;t++){let e=n[t].format[1],r=34041==e?33306:6402==e?36096:36064+t;rn.framebufferTexture2D(Q,r,q,n[t].texture,0)}return rn.bindFramebuffer(Q,null),t}(On),[kn,t]}var Jn=[[-1,1,-1],[1,1,-1],[0,1,-1]];function Qn(n,[e,o],[a,i]){I.innerHTML=`LMB click to speed up, RMB to speed down. ${n.at.map((n=>~~n))} | ${Wn[0]};${Wn[1]};${Wn[2]}`;let l=n.time,[c,f,u]=U(h(h(n.at,s(n.dir,-5)),[0,0,0]),n.dir,Vn,r/4,[4,Sn+g(n.at,[0,3600,0])]),v=_(c),m=L(n.at,n.dir,[0,0,1]);m=A(m,R([0,0,1],-n.smoothDrot[0]*Math.PI/4/100)),m=A(m,R([1,0,0],-n.smoothDrot[1]*Math.PI/4/200));let p=Jn.map((n=>{let t=$(c,$(m,n));return t[0]=~~((.5*t[0]+.5)*Vn[0]),t[1]=~~((.5-.5*t[1])*Vn[1]),t[2]=0,t}));Date.now();rn.useProgram(kn),bn(Nn,{camera:c,flyer:m,sun:[0,Sn,0],time:l}),rn.bindFramebuffer(Q,qn),rn.clear(16640),rn.drawBuffers([36064,36065]),bn(Nn,{pass:0}),rn.bindBuffer(rn.ELEMENT_ARRAY_BUFFER,e.faces),wn(e,kn),rn.drawElements(4,o.faces.length,X,0),async function(n){rn.readBuffer(j),await Promise.all(t(3,(t=>async function(n,t,e,r,o,a,i){const l=rn.createBuffer();return rn.bindBuffer(W,l),rn.bufferData(W,i.byteLength,35041),rn.readPixels(n,t,e,r,o,a,0),rn.bindBuffer(W,null),await Pn(W,l,0,i),rn.deleteBuffer(l),i}(n[t][0],n[t][1],1,1,J,V,Wn[t]))))}(p),bn(Nn,{pass:1}),rn.bindBuffer(rn.ELEMENT_ARRAY_BUFFER,a.faces),wn(a,kn),rn.drawElements(4,i.faces.length,X,0),rn.useProgram(Cn),bn(Un,{invCamera:v,flyer:m,time:l,invPerspective:_(f),scp0:p[0],scp1:p[1],scp2:p[2]}),function(n,t){for(let e=0;e<n.length;e++)rn.activeTexture(rn.TEXTURE0+e),t[e]&&t[e](e),rn.bindTexture(q,n[e].texture)}(On,[Un.T0,Un.T1,Un.Depth]),rn.bindFramebuffer(Q,null),rn.drawArrays(4,0,6)}var Wn=t(4,(n=>new Uint8Array(4)));var jn,Hn=Math.PI/180,Gn=[90,0],Kn=[0,0];var Zn=[];l(Math.random());!function(){let n=Date.now(),[t,e]=Bn(),[r,o]=Yn([1200,800]);["keydown","keyup","mousedown","mouseup","mousemove"].forEach((n=>document.addEventListener(n,(n=>{switch(n.type){case"mousemove":t=Kn,e=[n.movementX,n.movementY],Kn=t.map(((n,t)=>n+e[t]));break;case"mousedown":Zn[n.button]=!0;break;case"mouseup":Zn[n.button]=!1}var t,e}))));let a=jn={dir:[1,0,0],at:[0,-300,0],vel:.05,time:0,drot:[0,0],smoothDrot:[0,0],rot:Gn},i={at:[3],norm:[3],cell:[3],type:[4],shape:[1]},[l,c]=zn(t,i),[f,d]=zn(e,i);function y(n){!function(n){jn.time+=n;let t=((Zn[0]?1:0)+(Zn[2]?-1:0))*n*3e-4;jn.vel+=Math.max(t,-jn.vel),Kn=Kn.map((t=>Math.sign(t)*Math.min(30,Math.abs(t)*n*60))),jn.drot[0]=jn.drot[0]-.1*Kn[0],jn.drot[1]=Math.max(-89.999,Math.min(89.999,jn.drot[1]-.1*Kn[1]));let e=Math.min(1,.01*n);var r,o,a;jn.smoothDrot=jn.smoothDrot.map(((n,t)=>n*(1-e)+jn.drot[t]*e)),jn.rot=(r=jn.rot,o=jn.smoothDrot,a=.006,r.map(((n,t)=>n+o[t]*a))),jn.rot[1]=Math.max(-89,Math.min(jn.rot[1],89)),jn.smoothDrot=b(jn.smoothDrot,1-.2*e);let[i,l]=jn.rot.map((n=>n*Hn));jn.dir=u([Math.cos(l)*Math.cos(i),Math.cos(l)*Math.sin(i),Math.sin(l)]),Math.sin(i),Math.cos(i),Math.sin(i),Math.cos(i),Math.cos(i),Math.sin(i),Kn[0],1-10*n,Kn=[0,0],jn.vel*=1-0*n;let c=s(jn.dir,jn.vel*n);jn.at=h(jn.at,c);for(let n in[0,1,2]){let t=Wn[n][3];if(t>10){let e=[...Wn[n].slice(0,3)],r=u(m(e,-128)),o=-v(r,jn.dir);jn.at=p(jn.at,r,jn.vel*o*t/2),jn.vel>-.1&&(jn.vel*=1-.01*o)}}}(n),Qn(a,[l,c],[f,d])}console.log(`${Date.now()-n} ms ${c.faces.length} faces`);let x=!1;function g(){return document.pointerLockElement==o}function F(n){null==n&&(n=!g()),n?o.requestPointerLock():document.exitPointerLock()}o.onclick=n=>{if(F(!0),!x){let n=Date.now();const t=()=>{g()&&y(Date.now()-n),n=Date.now(),requestAnimationFrame(t)};t()}x=!0},document.onkeydown=n=>{switch(n.code){case"Space":F()}},y(0)}()})();