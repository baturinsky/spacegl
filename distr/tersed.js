(()=>{var e=e=>[...new Array(e)].map(((e,t)=>t)),t=(e,t)=>[...new Array(e)].map(((e,n)=>t?t(n):n)),n=2*Math.PI,r=Math.PI,o=Math.PI/2,a=Math.PI/4,i=2**31;function l(e){0<e&&e<1&&(e=~~(e*i));let t=t=>(e=16807*e%2147483647)%t;return n=>-1==n?e:null==n?t(i)/i:t(n)}function c(e,t){let n={};for(let r in e)n[r]=t(e[r],r,e);return n}var s=[[1,0,0],[0,1,0],[0,0,1]],f=e=>(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])**.5,u=(e,t)=>[e[0]*t,e[1]*t,e[2]*t],m=(e,t=1)=>u(e,t/f(e)),v=(e,t)=>e[0]*t[0]+e[1]*t[1]+e[2]*t[2],h=(e,t)=>[e[0]+t[0],e[1]+t[1],e[2]+t[2]],p=(e,t)=>[e[0]+t,e[1]+t,e[2]+t],d=(e,t,n)=>[e[0]+t[0]*n,e[1]+t[1]*n,e[2]+t[2]*n],g=(e,t)=>[e[0]-t[0],e[1]-t[1],e[2]-t[2]],y=(e,t)=>[e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0]],x=(e,t)=>(e=>w(e,e)**.5)(S(e,t)),b=(e,t)=>e.map((e=>e*t)),w=(e,t)=>e.reduce(((e,n,r)=>e+n*t[r]),0),S=(e,t)=>e.map(((e,n)=>e-t[n])),M=e=>[Math.cos(e),Math.sin(e)],D=(e,t,n)=>e.map(((e,r)=>e*(1-n)+t[r]*n)),F=s[1],z=e(16).map((e=>e%5?0:1)),T=(e,t)=>e.map(((n,r)=>{let o=r%4,a=r-o;return t[a]*e[o]+t[a+1]*e[o+4]+t[a+2]*e[o+8]+t[a+3]*e[o+12]})),A=(...e)=>1==e.length?e[0]:A(...e.slice(0,e.length-2),T(e[e.length-1],e[e.length-2])),E=(e,t)=>e.map((e=>t*e)),P=e=>e[0]+e[5]+e[10]+e[15],$=(e,t,...n)=>{const r=E(t,e);return n.length?((e,t)=>e.map(((e,n)=>e+t[n])))(r,$(...n)):r};function B(e){let[t,n,r,o,a,i]=function(e){const t=T(e,e),n=T(e,t),r=T(t,t),o=P(e),a=P(t),i=P(n);return[(o**4-6*a*o*o+3*a*a+8*i*o-6*P(r))/24,t,n,o,a,i]}(e),l=$((o*o*o-3*o*a+2*i)/6,z,-(o*o-a)/2,e,o,n,-1,r);return E(l,1/t)}var I=(e,t,n=F)=>{const r=m(u(t,-1)),o=m(y(n,r)),a=y(o,r);return[o[0],o[1],o[2],0,a[0],a[1],a[2],0,r[0],r[1],r[2],0,e[0],e[1],e[2],1]};function L(e,t){let[n,r,o]=e;const a=Math.sqrt(n*n+r*r+o*o);n/=a,r/=a,o/=a;const i=Math.cos(t),l=Math.sin(t),c=1-i;return[n*n+(1-n*n)*i,n*r*c+o*l,n*o*c-r*l,0,n*r*c-o*l,r*r+(1-r*r)*i,r*o*c+n*l,0,n*o*c+r*l,r*o*c-n*l,o*o+(1-o*o)*i,0,0,0,0,1]}function k(e,t){const[n,r,o]=t,a=n*e[3]+r*e[7]+o*e[11]+e[15];return[(n*e[0]+r*e[4]+o*e[8]+e[12])/a,(n*e[1]+r*e[5]+o*e[9]+e[13])/a,(n*e[2]+r*e[6]+o*e[10]+e[14])/a]}var _=t=>e(16).map((e=>15==e?1:e%5?0:t)),C=t=>e(16).map((e=>15==e?1:e%5?0:t[e/5])),N=e=>[1,0,0,0,0,1,0,0,0,0,1,0,e[0],e[1],e[2],1];function O(e,t,[n,r],o,[a,i]){let l=n/r;const c=((e,t,n=F)=>I(e,g(t,e),n))(e,h(e,t),s[2]),f=((e,t,n,r)=>{const o=1/Math.tan(.5*e),a=1/(n-r);return[o/t,0,0,0,0,o,0,0,0,0,(n+r)*a,-1,0,0,n*r*a*2,0]})(o,l,a,i);return[T(f,B(c)),f,c]}function R([e,t,n]){return[1-2*e*e,-2*e*t,-2*e*n,0,-2*e*t,1-2*t*t,-2*t*n,0,-2*e*n,-2*t*n,1-2*n*n,0,0,0,0,1]}var U=3553,H=5121,K=5125,V=5126,j=6408,q=36160,J=35051,G=36065,W={at:[3],norm:[3],cell:[3]};function X(e){for(let t of e.faces)(null==t[2].norm||Number.isNaN(t[2].norm[0]))&&(t[2].norm=m(y(g(t[0].at,t[2].at),g(t[1].at,t[2].at))))}var Y=(e,...t)=>{let n=A(...t);for(let t of e.verts)t.at=k(n,t.at)};function Q(e){return(t={faces:ee(e.map((e=>e.faces))),verts:ee(e.map((e=>e.verts)))}).verts.forEach(((e,t)=>e.ind=t)),t;var t}function Z(e){let t=0;return[0,...e.map((e=>t+=e.length))]}function ee(e,t=(e=>new Array(e))){const n=Z(e);let r,o=t(n[e.length]);for(let t=e.length-1;t>=0;t--){r=0==t?0:n[t];for(let n=e[t].length-1;n>=0;n--)o[r+n]=e[t][n]}return o}function te(e,t,n){let r=new Array(e*t*2),o=new Array((e+1)*(t+1)),a=e+1;for(let r=0;r<=e;r++)for(let e=0;e<=t;e++)o[e*a+r]={at:n(r,e),cell:[r,e,0],ind:e*a+r};for(let n=0;n<e;n++)for(let i=0;i<t;i++){const t=2*(i*e+n),l=i*a+n;r[t]=[o[l+1+a],o[l+a],o[l]],r[t+1]=[o[l+1],o[l+1+a],o[l]]}return{faces:r,verts:o}}var ne,re=(e,t=0)=>r=>M(n/e*r+t),oe=(e,t)=>(n,r)=>[e[n%e.length][0]*t[r][0],e[n%e.length][1]*t[r][0],t[r][1]],ae=(e,t)=>ie(e,t,oe),ie=(e,t,n)=>te(e.length,t.length-1,n(e,t)),le=(e,t)=>ee(e.map(((n,r)=>{let o=e[(r+1)%e.length];return[D(n,o,t),D(n,o,1-t)]}))),ce=(e,t)=>ee(e.map(((n,r)=>{let o=e[(r+1)%e.length],a=x(n,o),i=t/a;return[D(n,o,i),D(n,o,1-i)]})));function se(e){let t={...e};return t.verts=JSON.parse(JSON.stringify(e.verts)),t.faces=e.faces.map((e=>e.map((e=>t.verts[e.ind])))),t}function fe(e){e.faces=e.faces.map((e=>[e[1],e[0],e[2]]))}function ue(e,t){let n=`#version 300 es\nprecision highp float;\nprecision highp int;\n\n${t}`;const r=ne.createShader(e);ne.shaderSource(r,n),ne.compileShader(r);{const e=ne.getShaderInfoLog(r);e&&(console.log("shader:",e),console.log(n.split("\n").map(((e,t)=>`${t+1}. ${e}`)).join("\n")))}return r}function me(e,t){var n=ne.createProgram();return ne.attachShader(n,ue(35633,e)),ne.attachShader(n,ue(35632,t)),ne.linkProgram(n),n}var ve=[5121,6408],he=[5123,6402,33189];function pe(e,[t,n]){return e.map((e=>function(e,t,n,r){const o=ne.createTexture();return ne.bindTexture(U,o),ne.texImage2D(U,0,n[2]||n[1],e,t,0,n[1],n[0],r),ne.texParameteri(U,10241,9728),ne.texParameteri(U,10240,9728),ne.bindTexture(U,null),{texture:o,format:n}}(t,n,e)))}var de={5124:"i",[K]:"ui",[V]:"f",35665:"f",35676:"Matrix4fv"};function ge(e){const t={};for(let n=0;n<ne.getProgramParameter(e,ne.ACTIVE_UNIFORMS);++n){const r=ne.getActiveUniform(e,n);let o=de[r.type]||"i";const a=ne.getUniformLocation(e,r.name);let i=r.size>1?e=>{ne[`uniform1${o}v`](a,e)}:o.indexOf("Matrix")>=0?e=>ne[`uniform${o}`](a,!1,e):(...e)=>{e[0].length>0&&(e=e[0]),ne[`uniform${e.length}${o}`](a,...e)};t[r.name]=i}return t}function ye(e,t){for(let n in t)e[n]&&e[n](t[n])}function xe(e,t,n,r=3,o=5126){let a=ne.getAttribLocation(e,t);ne.enableVertexAttribArray(a),ne.bindBuffer(34962,n),ne.vertexAttribPointer(a,r,o,!1,0,0)}function be(){return ne.createBuffer()}function we(e,t,n=34962){ne.bindBuffer(n,e),ne.bufferData(n,t,35044),ne.bindBuffer(n,null)}function Se(e,t){for(let n in e.verts)xe(t,n,e.verts[n],e.attrs[n][0],e.attrs[n][1]||V)}function Me(e,t){let n=function(e,t){let n=e.length,r=Z(e.map((e=>e.faces))),o=Z(e.map((e=>e.verts))),a=new Uint32Array(3*r[n]),i=c(t,(e=>e[1]&&e[1]!=V?new Int32Array(o[n]*e[0]):new Float32Array(o[n]*e[0]))),l=0;e.forEach(((e,t)=>{for(let n of e.faces){const e=o[t];a[l++]=n[0].ind+e,a[l++]=n[1].ind+e,a[l++]=n[2].ind+e}}));for(let n in i){let r=t[n][0],o=i[n],a=0;for(let t of e){let e=t.common?t.common[n]:null;for(let i of t.verts){let t=i[n]||e;t&&(1==r?o[a]=t:o.set(t,a*r)),a++}}}return{faces:a,verts:i}}(e,t),r=function(e=W){return{faces:be(),verts:c(e,(e=>be())),attrs:e}}(t);return function(e,t){we(e.faces,t.faces,34963);for(let n in t.verts)we(e.verts[n],t.verts[n])}(r,n),[r,n]}async function De(e,t,n,r,o,a){const i=ne.fenceSync(37143,0);return ne.flush(),await function(e,t,n){return new Promise(((r,o)=>{!function a(){const i=ne.clientWaitSync(e,t,0);i!=ne.WAIT_FAILED?i!=ne.TIMEOUT_EXPIRED?r(null):setTimeout(a,n):o()}()}))}(i,0,10),ne.deleteSync(i),ne.bindBuffer(e,t),ne.getBufferSubData(e,n,r,o,a),ne.bindBuffer(e,null),r}var Fe=Y,ze=72,Te=400,Ae=12960,Ee=7200,Pe=[];function $e(){let e=l(1),a=function(e){let t=function(e){let t=new Array(Ae),n=new Array(Ae);for(let r=0;r<Ae;r++){if(n[r])continue;let o=[e(4)?0:e(3),e(4)?0:e(3)],a=0,i=[];for(let e=0;e<=o[0];e++)for(let t=0;t<=o[1];t++)i.push(r+e+t*ze);let l=1e6;for(let e of i)l=Math.min(l,Ie(e));if(l>.3*e()){let c=30+e(10);e(10)||(c*=1.2),c=Math.min(18,c),a=Math.min(300*l,3+20*l*(8+e(10)));let s=0!=e(4);s&&(a/=2);let f=Be(e,c*(.5+.5*e()),r,a/c,s);c*=1-(.1+o[0]+o[1]),t[r]=f,n[r]=a,f.extend=o,f.height=a,f.density=l;for(let e of i)n[e]=a;let u=a+10*e()+30;f.verts.push({at:[0,0,u-1],ind:f.verts.length}),f.verts.push({at:[0,0,u],ind:f.verts.length})}}return t}(e);return function(e){let t=[];for(let t=0;t<Ae;t++){let r=e[t];if(!r)continue;let o=t%ze/ze*n+r.extend[0]/2;(r.extend[0]>1||r.extend[1]>1)&&Fe(r,C([r.extend[0]+1,r.extend[1]+1,1])),Fe(r,N([0,t/Ae*Ee+40*r.extend[1]/2,-400]),L(s[1],o))}}(t),t}(e),i=a.filter((e=>e)),c=function(e,r,o,a,i){let l=(e=>t(e,(t=>M(t/(e-1)*n))))(r),c=[];for(let t=0;t<r-1;t++){let n=1e3*e(),s=t/r*6%1<.5?.8:1,f=ae([b(l[t],o),b(l[(t+1)%r],o),b(l[(t+1)%r],a),b(l[t],a)].reverse(),[[1,-n],[1,.96*i],[s,.98*i],[s,1.03*i]]);c.push(f)}let s=ae(l,[[0,i],[a,i],[1.2*a,i],[1.2*a,1.2*i],[0,1.2*i]]);for(let e of s.verts)0==e.cell[1]&&(e.type=[5,0,0,0]);let f=Q([s,...c]);return f.common={type:[4,0,0,0]},f}(e,72,Te,520,7200);Fe(c,L(s[0],-Math.PI/2)),i.push(c);let f=[],u=function(){let e=ae(ce([[0,-4],[6,-5],[0,4],[-6,-5]],2),[[0,0],[.8,0],[1,.5],[1,1],[.8,1.1],[0,1.1]]);Fe(e,N([0,3,5]));let n=ae(ce([[-1,0],[1,0],[1,2],[-1,2]],.5),[[0,0],[.8,0],[1,1],[1,1],[.5,3],[0,3]]);Fe(n,L([1,0,0],-o),N([2,-1.5,6.2]));let r=se(n);Fe(r,R([1,0,0])),fe(r);let a=ae(t(32,re(32)),[[0,0],[3.9,0],[4,.1],[4,.9],[3.9,1],[0,1]]);Fe(a,N([0,2.5,5.5]));let i=ae(t(32,re(32)),[[0,0],[.9,0],[1,.1],[1,.9],[.9,1],[0,1]]);Fe(i,N([0,4,6]));let l=Q([a,i,e,n,r]);return l.common={type:[3,0,0,0]},Fe(l,_(.18),L([0,-1,0],Math.PI),L([-1,0,0],Math.PI/2),N([0,2,0])),l}();f.push(u);for(let t=0;t<150;t++){let a=_e(e,t),l=t%6;Fe(a,L([0,1,0],o+(l<3?r:0)),_(e(5)+2),N([0,0,Te*(.35+.15*e())]),L([0,1,0],l*n/6+5*n/12+.2*e()-.1)),i.push(a)}for(;Pe.length<1920;){let t=a[e(a.length)];if(t&&t.height*e()<t.density&&t.density>.4){let e=~~((t.density/(t.height+10)*400)**2+1),n=(m=t.verts,m[m.length-1]).at,r=g(n,t.verts[t.verts.length-2].at),o={ind:Pe.length,at:n,up:r,live:!0,score:e};Pe.push(o)}}var m;Pe.forEach(((t,n)=>{for(let n=0;n<32;n++){let o=3*e()+1,a={faces:[[(r=[[-o/2,-o/2,0],[-o/2,o,0],[o/2,o/2,0],[o/2,-o/2,0]].map(((e,t)=>({ind:t,at:e}))))[1],r[2],r[3]],[r[0],r[1],r[3]]],verts:r};a.common={type:[9,...t.at],shape:32*t.ind+n,up:t.up},f.push(a)}var r}));let v=0;for(let e of[...i,...f])v++,X(e),e.common=e.common||{},e.common.shape=e.common.shape||v;return[i,f]}function Be(e,n,r,o,i){let l,c,s;if(i)[c,s]=Le(e,o,n*(.5+.4*e()),!0),l=[[1,1],[-1,1],[-1,-1],[1,-1]];else{let r=e(4)+4;[c,s]=Le(e,o,n),l=t(r,(e=>re(r,a)(e))),e(3)||(l=le(l,.1)),0==e(4)&&l.forEach((e=>e[1]+=.95))}let f=ie(l,c,oe);for(let e of f.verts)e.type=s?s[e.cell[1]]:[2,0,0,0];return f}function Ie(e){let t=e%ze/ze*n,o=Math.sin(6*t+r/2);return Math.min(1.4-3*Math.abs(.5-e/Ae),.5*o+1)}function Le(e,t,n,r=!1){let[o,a]=[1,0],i=[[o*n,0]],l=[],c=2,[s,f]=function(e){return[[e(6)+2,e(6)+2,e(6),e(6)],[(e()+.3)/4,e()+.3]]}(e);for(;a<t;){let m=c>1?0:o*(.1+.5*e())*(e(4)?-1:1);(o+m>1||o+m<.3)&&(m=-m);let v=r?t:(c>0?1:0)*(.5*e()*(1.1*t-a));a<5&&v>0&&v++,o+=m,a+=v,a>t&&(a=t),i.push([o*n,a*n]);let h=~~(v*f[0]*n)||1,p=~~(o*f[1]*n)||1,d=(1-s[0]/15)*(1-s[1]/15);0!=m&&(h=1),l.push([2,256*h+p,(u=s,u.reduce(((e,t)=>16*e+t))),256*d]);let g=e(3);c=0==g&&0==c?2:g}var u;return i.push([0,a*n]),l.push([2,2056,57344,0]),[i,l]}function ke(e,t,n,r){let o=[e()*n[1][0],e()*n[1][1]],a=n[0][0],i=[[[a,o[0]]],[[a,o[1]]]],l=(n[0][1]-n[0][0])/(t[0]+t[1]);if(!(l<0)){for(let r=0;r<20&&(a+=e()*l*2,a>n[0][1]&&(a=n[0][1]),e()<t[0]/(t[0]+t[1])&&(o[0]=e()*n[1][0]),e()<t[1]/(t[0]+t[1])&&(o[1]=e()*n[1][1]),i[0].push([a,o[0]]),i[1].push([a,o[1]]),!(a>=n[0][1]));r++);return i[0].push([a,o[0]]),i[1].push([a,o[1]]),((e,t)=>{let n=t[0][1],r=t[t.length-1][1];const o=t=>te(e.length/2,1,((n,r)=>[...e[0==r?n:e.length-n-1],t]));let a=o(n),i=o(r);return fe(a),Q([ae(e,t),a,i])})(le([...i[0],...i[1].reverse()].map((e=>[e[0],e[1]/2])),.1),r)}}function _e(e,t){let n=5+e(15),r=.5+e(),a=.5+e(),i=.1+3*e(),l=ke(e,[e(4)+1,e(4)+1],[[0,r+1+e(5)],[-2-e()*n/3,6+e()*n/2]],[[1,0],[1.5,.33*i],[1.5,.66*i],[1,i]]),c=se(l);var s;Y(s=c,R([1,0,0])),fe(s);let f=ke(e,[e(3)+1,e(3)+1],[[-3,n],[-4*a,4*a]],[[1,-2*r],[1.5,-1*r],[1.5,1*r],[1,2*r]]);Fe(f,L([0,0,-1],o),L([0,1,0],o));let u=Q([f,l,c]);for(let e of u.verts)e.type=[7,t,0,0];return u}var Ce,Ne={fMain:"in vec3 vcell;\nin vec3 vat;\nin float dist;\n\nflat in float light;\nflat in vec3 vnorm;\nflat in vec4 vcolor;\n\nflat in ivec4 vtype;\n\nlayout(location = 0) out vec4 c0;\nlayout(location = 1) out vec4 c1;\n\nfloat hexDigitF(int n, int place) {\n  return float((n >> (place * 4)) & 15) / 15.;\n}\n\nint hex2Digit(int n, int place) {\n  return (n >> (place * 8)) % 256;\n}\n\nvoid main() {\n  int itype = vtype.x;\n  int t1 = vtype.y;\n  int t2 = vtype.z;\n  float bright = light;\n  if(itype == 2) {\n    float hm = hexDigitF(t2, 0);\n    float vm = hexDigitF(t2, 1);\n    float x = fract(vcell.x);\n    float y = fract(vcell.y);\n\n    float far = 0., near = 0.;\n\n    if(dist >= 500.) {\n      far = x > hm &&\n        x < 1. - hm &&\n        y > vm &&\n        y < 1. - vm ? -float(vtype.a) / 256. : .0;\n    }\n\n    if(dist <= 700.) {\n      float cols = float(hex2Digit(t1, 1));\n      float rows = float(hex2Digit(t1, 0));\n      float hb = hexDigitF(t2, 2);\n      float vb = hexDigitF(t2, 3);\n      near = x > hm &&\n        x < 1. - hm &&\n        y > vm &&\n        y < 1. - vm &&\n        (cols == 1. || fract((x - hm) / (1. - hm * 2.) * cols) > hb) &&\n        (rows == 1. || fract((y - vm) / (1. - vm * 2.) * rows) > vb) ? -1. : .0;\n    }\n\n    float l = clamp((dist - 500.) / 200., 0., 1.);\n    bright += mix(near, far, l);\n\n  } else if(itype == 4) {\n    bright += vat.z * 5e-4 + (fract(vat.y / 40. + 0.55) < .1 || fract(atan(vat.x, vat.z) / 3.141 * 36. + 0.45) < .1 ? -1. : 0.);\n  } else if(itype == 5) {\n    bright = 2.;\n  }\n\n  if(itype == 7) {\n    float y = fract(vcell.y);\n    bright += y < 0.03 || y > 0.97 || y>0.49 && y<0.51? -.5 : .0;\n  }\n\n  if(bright > 0.)\n    bright += vcell.y * 0.05 - 0.3;\n\n  c0 = vec4(vcolor.rgb * bright, vcolor.a);\n  c1 = vec4(vnorm*0.5+0.5, gl_FragCoord.z * gl_FragCoord.w);\n}\n",vMain:"uniform mat4 camera;\r\nuniform mat4 flyer;\r\nuniform vec3 sun;\r\nuniform float time;\r\nuniform int consuming;\r\nuniform float consumingStage;\r\n\r\nuniform int liveDebris[32];\r\n\r\nin vec3 at;\r\nin vec3 up;\r\nin vec3 norm;\r\nin vec3 cell;\r\nin vec4 type;\r\nin float shape;\r\n\r\nout vec3 vcell;\r\nout vec3 vat;\r\nout float dist;\r\nflat out float light;\r\n\r\nflat out vec3 vnorm;\r\nflat out vec4 vcolor;\r\n\r\nflat out ivec4 vtype;\r\nflat out int vshape;\r\n\r\nfloat rand(float n){return fract(sin(n) * 43758.5453123);}\r\n\r\nmat4 axisRotation(vec3 axis, float angle) {\r\n\r\n  float x = axis.x;\r\n  float y = axis.y;\r\n  float z = axis.z;\r\n\r\n  float n = sqrt(x * x + y * y + z * z);\r\n  x /= n;\r\n  y /= n;\r\n  z /= n;\r\n  float c = cos(angle);\r\n  float s = sin(angle);\r\n  float omc = 1. - c;\r\n\r\n  return mat4(x * x + (1. - x * x) * c, x * y * omc + z * s, x * z * omc - y * s, 0., x * y * omc - z * s, y * y + (1. - y * y) * c, y * z * omc + x * s, 0., x * z * omc + y * s, y * z * omc - x * s, z * z + (1. - z * z) * c, 0., 0., 0., 0., 1.);\r\n}\r\n\r\nvoid main() {\r\n  vat = at;\r\n  vnorm = norm;\r\n  vcell = cell;\r\n\r\n  vtype = ivec4(type);\r\n  vshape = int(shape);\r\n\r\n  vec4 at4 = vec4(at+up*0., 1.);\r\n\r\n  vcolor.rgb = vec3(1.);\r\n\r\n  if(vtype.x == 9) {\r\n    int swarm = vshape/32;\r\n    bool live = (liveDebris[swarm/30] & (1 << swarm%30)) != 0;\r\n    if(live || consuming == swarm){\r\n      vcolor.rgb = vec3(1.,0.,1.);\r\n      float a = rand(shape);\r\n      vec3 axis = normalize(vec3(rand(a+1.), rand(a+2.), rand(a+3.)));\r\n      light -= a*0.3; \r\n      mat4 rot = axisRotation(axis, time * 5. * (.5+rand(a+4.)) + rand(a+4.) );\r\n      vnorm = normalize((rot * vec4(norm, 1.)).xyz);\r\n      at4 = rot * at4;\r\n      at4.xyz += 25. * (vec3(rand(a+5.), rand(a+6.), rand(a+7.)) - .5);\r\n      at4.xyz += vec3(vtype.yzw);\r\n      at4.xyz += up * sin(float(swarm) + time*0.1) * 20.;\r\n      if(consuming == swarm)\r\n        at4.xyz = mix(at4.xyz, flyer[3].xyz, consumingStage);\r\n    } else {\r\n      at4 = vec4(1e6);\r\n    }\r\n  }\r\n\r\n  if(vtype.x == 3) {\r\n    at4 = flyer * at4;\r\n    mat4 fnorm = flyer;\r\n    fnorm[3] = vec4(0.);\r\n    vnorm = normalize((fnorm * vec4(norm, 1.)).xyz);\r\n  }\r\n\r\n  if(vtype.x == 7) {\r\n    int id = vtype.y;\r\n    if(id % 2 == 0) {\r\n      vnorm.y = -vnorm.y;\r\n      at4.y = -at4.y;\r\n    }\r\n    float shift = fract(fract(float(id) / 1e2) + time * 1e-2 * (id % 2 == 1 ? 3. : -3.));\r\n    at4.y = at4.y + 7300. - pow(shift * 120., 2.);\r\n    if(at4.y<0.){\r\n      at4.xz += vec2(rand(float(id))-.5,rand(float(id+1))-.5) * pow(at4.y/1e2,2.) ;\r\n    }\r\n  }\r\n\r\n  vec4 pos;\r\n\r\n  if(vtype.x == 8) {\r\n    pos = at4;\r\n  } else {\r\n    pos = camera * at4;\r\n  }\r\n\r\n  vat = at4.xyz;\r\n  pos.y = -pos.y;\r\n\r\n  vec3 toSun = sun - vat;\r\n  light = dot(vnorm, normalize(toSun)) * 0.2 + .9 - length(toSun) * 1e-6;\r\n\r\n  if(vtype.x == 7) {\r\n    light += 0.2;\r\n  }\r\n\r\n  dist = distance(vat, flyer[3].xyz);\r\n\r\n  gl_Position = pos;\r\n}\r\n",fScreen:"uniform sampler2D T0;\nuniform sampler2D T1;\nuniform sampler2D Depth;\nuniform mat4 invCamera;\nuniform mat4 invPerspective;\nuniform mat4 flyer;\nuniform vec3 viewSize;\nuniform vec3 scp0;\nuniform vec3 scp1;\nuniform vec3 scp2;\nuniform float timeout;\n\nin vec2 uv;\n\nout vec4 color;\n\nfloat Noise2d(in vec2 x) {\n  float xhash = cos(x.x * 37.0);\n  float yhash = cos(x.y * 57.0);\n  return fract(415.92653 * (xhash + yhash));\n}\n\nint b64[64] = int[] (1, 33, 9, 41, 3, 35, 11, 43, 49, 17, 57, 25, 51, 19, 59, 27, 13, 45, 5, 37, 15, 47, 7, 39, 61, 29, 53, 21, 63, 31, 55, 23, 4, 36, 12, 44, 2, 34, 10, 42, 52, 20, 60, 28, 50, 18, 58, 26, 16, 48, 8, 40, 14, 46, 6, 38, 64, 32, 56, 24, 62, 30, 54, 22);\n\nfloat dither(float v, ivec2 F) {\n  return v * 75. > float(b64[F.y % 8 * 8 + F.x % 8]) ? 1. : 0.;\n}\n\nconst bool ditherOn = true;\nconst float collisionDepth = 0.6;\n\nvoid main() {\n\n  ivec2 F = ivec2(gl_FragCoord.xy);\n\n  float depth = texelFetch(Depth, F, 0).r;\n  color = vec4(1.);\n\n  vec4 screenPos = vec4(uv.x, -uv.y, depth * 2. - 1., 1.);\n\n  vec4 pos4 = invCamera * screenPos;\n  vec3 pos = (pos4 / pos4.w).xyz - flyer[3].xyz;\n\n  color = texelFetch(T0, F, 0);\n\n  float r = 75.;\n  bool ui = false;\n\n  vec2 cntr = vec2(viewSize.x-r-10., viewSize.y - r-10.);\n  vec2 dif = cntr - gl_FragCoord.xy;\n  float l = length(dif);\n  if(l < r) {\n    float a = atan(-dif.x, dif.y);\n    if(l>r*.7 && l<r && timeout > 0.){\n      ui = true;\n      color.xyz = a / 6.282 + 0.5 > timeout ? vec3(.01):vec3(1.);\n    }\n  }\n\n  if(depth == 1. && !ui) {\n\n    vec3 pos1 = pos / length(pos);\n\n    if(Noise2d(vec2(floor((pos1.x + pos1.y) * 3e2), floor(pos1.z * 3e2))) > 0.99)\n      color.xyz = pos1 * 0.5 + 0.5;\n    else\n      color.xyz = vec3(0.);\n\n  } else {\n\n    if(color.r > 0.)\n      color = (color * 2. + texelFetch(T0, F + ivec2(1, 0), 0) + texelFetch(T0, F + ivec2(0, 1), 0)) * 0.25;\n\n    float diff = 0.;\n    for(int i = 0; i < 8; i++) {\n      int step = i / 4;\n      ivec2 place = ivec2(i % 2, i % 4 / 2) * step;\n      float edge = texelFetch(Depth, F + place, 0).r +\n        texelFetch(Depth, F - place, 0).r - depth * 2.;\n      diff += abs(edge);\n    }\n\n    diff *= depth;\n\n    if(diff > .00007) {\n      color.rgb = normalize(color.rgb) * 0.3;\n    } else {\n      if(ditherOn) {\n        color.r = dither(color.r, F);\n        color.g = dither(color.g, F);\n        color.b = dither(color.b, F);\n      }\n    }\n\n    if(depth > 0.995 && (depth - 0.99) * 1000. > float(b64[F.y % 8 * 8 + F.x % 8])) {\n      color = vec4(1.);\n    }\n  }\n\n  //color = texelFetch(T1, F, 0);\n  color.a = 1.;\n}",vScreenQuad:"out vec2 uv;\n\nvoid main() {\n  int i = gl_VertexID;\n  ivec2 uvi = ivec2(i % 2, (i + 1) % 4 / 2) * 2 - 1;\n  gl_Position = vec4(uvi.x, uvi.y, 0, 1);\n  uv = vec2(uvi);\n}"};var Oe=(e=.02,t=.1)=>{let n=0;return()=>{var r=2*Math.random()-1;let o=(n+e*r)/(1+e);return n=o,o*=t/e,o}},Re=e=>2**(e/12)*440;function Ue(){return function(e,t=!1){const n=Ce.createBufferSource();n.buffer=e;let r=Ce.createGain();return r.gain.value=0,r.connect(Ce.destination),n.connect(r),n.loop=t,n.start(),r}(function(e){const t=Ce.createBuffer(e.length,e[0].length,44100);return e.forEach(((e,n)=>t.getChannelData(n).set(e))),t}([t(2e5,Oe(.02,.01))]),!0)}l(Math.random());function He(e,t=3,n=1){if(!Ce)return;let[r,o]=function(e="sine"){let t=Ce.createOscillator(),n=Ce.createGain();return t.type=e,t.connect(n),t.start(),n.connect(Ce.destination),[t,n]}();o.gain.setValueAtTime(1*n*44/Re(e),Ce.currentTime),r.frequency.setValueAtTime(Re(e),Ce.currentTime),o.gain.exponentialRampToValueAtTime(1e-5,Ce.currentTime+t),r.stop(Ce.currentTime+t)}var Ke=Math.PI/180,Ve=[90,0],je=[0,0],qe={},Je=["Extend collection radius","Accelerate and brake faster","Turn faster","Longer combo timer","Bigger starting combo multiplier","Less combo loss on collisions"],Ge=new Int32Array(32);function We(){Object.assign(qe,{dir:[1,0,0],at:[0,-300,0],vel:.05,time:0,drot:[0,0],smoothDrot:[0,0],rot:Ve,consuming:-1,consumingStage:0,debris:Pe,liveDebris:Ge,debrisLeft:0,combo:0,timeout:0,timeoutSpeed:0,speedBonus:0,score:0,upgrades:[0,0,0,0,0,0],points:0,level:0});for(let e of qe.debris){let t=Xe(2);e.live=!!t}return lt(),qe}var Xe=l(1);function Ye(e){for(qe.time+=e;ut()<=qe.score;){pt("LEVEL UP!",2),qe.level++,qe.points++;for(let e=0;e<12;e++)setTimeout((()=>He(e)),100*e)}if(e>Xe()){let e=qe.debris[Xe(qe.debris.length)];e.live=!e.live,lt()}qe.combo>0&&(qe.timeout-=(1+qe.timeoutSpeed)*e),(qe.timeout<=0||qe.combo<=0)&&(qe.timeout=0,qe.timeoutSpeed=0,qe.combo=0);let t=((it[0]?1:0)+(it[2]?-1:0))*e*(.15+.1*qe.upgrades[1]);qe.vel+=Math.max(t,-qe.vel),qe.speedBonus=Math.min(qe.speedBonus+e/10,qe.vel),je=je.map((t=>Math.sign(t)*Math.min(30,Math.abs(t)*e*6e4))),qe.drot[0]=qe.drot[0]-.1*je[0],qe.drot[1]=Math.max(-89.999,Math.min(89.999,qe.drot[1]-.1*je[1]));let n=Math.min(1,e*(7+3*qe.upgrades[2]));var r,o,a;qe.smoothDrot=qe.smoothDrot.map(((e,t)=>e*(1-n)+qe.drot[t]*n)),qe.rot=(r=qe.rot,o=qe.smoothDrot,a=.006,r.map(((e,t)=>e+o[t]*a))),qe.rot[1]=Math.max(-89,Math.min(qe.rot[1],89)),qe.smoothDrot=b(qe.smoothDrot,1-.2*n);let[i,l]=qe.rot.map((e=>e*Ke));qe.dir=m([Math.cos(l)*Math.cos(i),Math.cos(l)*Math.sin(i),Math.sin(l)]),je=[0,0];let c=u(qe.dir,qe.vel*e*1e3);qe.at=h(qe.at,c),qe.debris.forEach(((e,t)=>{let n=h(e.at,u(e.up,20*Math.sin(e.ind+.1*qe.time)));e.live&&((e,t)=>f(g(e,t)))(n,qe.at)<30+qe.upgrades[0]**.4*10&&function(e){e.live=!1;let t=~~(e.score*ct()*ft()*st());pt(t.toFixed()),He(Xe(20)-30+qe.combo),qe.consuming=e.ind,qe.consumingStage=0,qe.combo+=1,qe.timeoutSpeed+=.1/(1+.3*qe.upgrades[3]),qe.timeout=10,qe.score+=t,lt()}(e)})),qe.consuming>-1&&(qe.consumingStage=qe.consumingStage+10*e,qe.consumingStage>1&&(qe.consuming=-1));for(let e in[0,1,2]){let t=wt[e][3];if(t>10){let n=[...wt[e].slice(0,3)],r=m(p(n,-128)),o=-v(r,qe.dir),a=o*qe.vel;console.log("DAMAGE",a),a-=.05*qe.upgrades[5],a>0&&(qe.combo-=a,qe.timeout-=a),o>0&&(He(Xe(20)-60,10*o,o**2),qe.at=d(qe.at,r,qe.vel*o*t/2),qe.vel*=1-Math.min(1,.03*o))}}}var Qe,Ze,et,tt,nt,rt,ot,at,it=[];function lt(){qe.debrisLeft=0,qe.liveDebris.fill(0);for(let e of qe.debris)e.live&&(qe.liveDebris[~~(e.ind/30)]+=1<<e.ind%30,qe.debrisLeft++);qe.time>1&&Ft(0)}function ct(){return~~(10+~~(3.334*qe.upgrades[4])+qe.combo)/10}function st(){return~~(1920/qe.debrisLeft*5)/10}function ft(){return 1+.1*~~(qe.speedBonus**2*100)}function ut(){return(qe.level+1)*(qe.level+2)*500}var mt,vt=[],ht=0;function pt(e,t=1){vt.push({text:e,at:[ot[0]*(.2*Math.random()+.4),ot[1]/2],importance:t})}function dt(e){let t=document.getElementById("C"),n=document.getElementById("D");return mt=document.getElementById("O"),ot=e,t.width=n.width=ot[0],t.height=n.height=ot[1],mt.style.marginTop=n.style.marginTop=-ot[1]+"px",t.style.width=n.style.width=mt.style.width=`${ot[0]}px`,t.style.height=n.style.height=mt.style.height=`${ot[1]}px`,(ne=t.getContext("webgl2")).enable(2929),(at=n.getContext("2d")).fillStyle="#fff",Qe=me(Ne.vMain,Ne.fMain),et=ge(Qe),Ze=me(Ne.vScreenQuad,Ne.fScreen),tt=ge(Ze),nt=pe([ve,ve,he],ot),rt=function(e){const t=ne.createFramebuffer();ne.bindFramebuffer(q,t);for(let t=0;t<e.length;t++){let n=e[t].format[1],r=34041==n?33306:6402==n?36096:36064+t;ne.framebufferTexture2D(q,r,U,e[t].texture,0)}return ne.bindFramebuffer(q,null),t}(nt),[t,mt]}var gt=[[-.8,1,-1],[.8,1,-1],[0,1,-1]];l(1);function yt(e,t,n){at.fillText(e,t,n),at.strokeText(e,t,n)}function xt(e,[n,o],[a,i],l){at.clearRect(0,0,ot[0],ot[1]),e.combo&&(at.textAlign="center",at.font="bold 32pt sans-serif",yt(`x${ct().toFixed(1)}`,ot[0]-85,100),yt(`${(ht=Math.min(e.score,ht+Math.max((e.score-ht)/10,10*l))).toFixed()}`,ot[0]/2,40),at.textAlign="right",at.font="bold 16pt Courier",yt("speed",ot[0]-10,200),yt("clean city",ot[0]-10,250),at.font="bold 20pt Courier",yt(`x${ft().toFixed(1)}`,ot[0]-10,220),yt(`x${st().toFixed(1)}`,ot[0]-10,270)),at.font="bold 32pt Courier";for(let e of vt)yt(e.text,e.at[0],e.at[1]),e.at[1]-=300*l/(e.importance||1);let c=e.time,[s,f,m]=O(h(h(e.at,u(e.dir,-5)),[0,0,0]),e.dir,ot,r/4,[4,Ee+x(e.at,[0,3600,0])]),v=B(s),p=I(e.at,e.dir,[0,0,1]);p=T(p,L([0,0,1],-e.smoothDrot[0]*Math.PI/4/100)),p=T(p,L([1,0,0],-e.smoothDrot[1]*Math.PI/4/200));let d=gt.map((e=>{let t=k(s,k(p,e));return t[0]=~~((.5*t[0]+.5)*ot[0]),t[1]=~~((.5-.5*t[1])*ot[1]),t[2]=0,t}));Date.now();ne.useProgram(Qe),ye(et,{camera:s,flyer:p,sun:[0,Ee,0],time:c,"liveDebris[0]":e.liveDebris,consuming:e.consuming,consumingStage:e.consumingStage}),ne.bindFramebuffer(q,rt),ne.clear(16640),ne.drawBuffers([36064,36065]),ye(et,{pass:0}),ne.bindBuffer(ne.ELEMENT_ARRAY_BUFFER,n.faces),Se(n,Qe),ne.drawElements(4,o.faces.length,K,0),async function(e){ne.readBuffer(G),await Promise.all(t(3,(t=>async function(e,t,n,r,o,a,i){const l=ne.createBuffer();return ne.bindBuffer(J,l),ne.bufferData(J,i.byteLength,35041),ne.readPixels(e,t,n,r,o,a,0),ne.bindBuffer(J,null),await De(J,l,0,i),ne.deleteBuffer(l),i}(e[t][0],e[t][1],1,1,j,H,wt[t]))))}(d),ye(et,{pass:1}),ne.bindBuffer(ne.ELEMENT_ARRAY_BUFFER,a.faces),Se(a,Qe),ne.drawElements(4,i.faces.length,K,0),ne.useProgram(Ze),ye(tt,{invCamera:v,flyer:p,time:c,invPerspective:B(f),timeout:qe.timeout/10,viewSize:[ot[0],ot[1],0],scp0:d[0],scp1:d[1],scp2:d[2]}),function(e,t){for(let n=0;n<e.length;n++)ne.activeTexture(ne.TEXTURE0+n),t[n]&&t[n](n),ne.bindTexture(U,e[n].texture)}(nt,[tt.T0,tt.T1,tt.Depth]),ne.bindFramebuffer(q,null),ne.drawArrays(4,0,6),ne.flush()}var bt,wt=t(4,(e=>new Uint8Array(4)));function St(e){if(!e)return void(mt.style.visibility="hidden");mt.style.visibility="visible";let t=[];for(let e=0;e<10;e++){let n=localStorage["warpStation13K-"+e];if(!n&&e>1)break;let r=n?JSON.parse(n):{};t.push(`${r.score||"0"}pts ${r.date||""}`)}t.length<10&&t.push("New Save"),mt.innerHTML=`\n  <H1>Warp Station 13K</H1>\n  <p>Score: ${e.score}/${ut()} Level: ${e.level} Upgrade points: ${e.points}</p>\n  <H3>Upgrades</H3>\n    ${Je.map(((t,n)=>`\n      <span class="u">${t}</span>\n      <button id="down_${n}">-</button>\n      <span class="up">${e.upgrades[n]}</span>\n      <button id="up_${n}">+</button><br/>`)).join("")}\n  <H3>Saves</H3>\n  <button id="new">New Game</button><br/><br/>\n  ${t.map(((e,t)=>`\n  <div>    \n    <button id="save_${t}">Save</button>\n    <span class="si">${t||"Auto"}</span>\n    <span class="st">${e}</span>    \n    <button style="visibility:${"New Save"!=e?"":"hidden"}" id="load_${t}" class="lb">Load</button>\n    </div>\n  `)).join("")}`}var Mt=1,Dt={at:[3],norm:[3],cell:[3],type:[4],shape:[1],up:[3]};localStorage.warpStation13K;function Ft(e){localStorage["warpStation13K-"+e]=function(){let e={...qe};return delete e.liveDebris,e.debris=e.debris.map((e=>e.live?1:0)).join(""),e.date=(new Date).toLocaleTimeString(),JSON.stringify(e)}()}function zt(e){!function(e){if(!e)return;let t=qe.liveDebris,n=qe.debris;Object.assign(qe,JSON.parse(e)),qe.debris.split().forEach(((e,t)=>n[t].live="1"==e)),qe.liveDebris=t,qe.debris=n,lt()}(localStorage["warpStation13K-"+e])}!function(){let e=Date.now(),[t,n]=$e(),[r,o]=dt([1200,800]);["keydown","keyup","mousedown","mouseup","mousemove"].forEach((e=>document.addEventListener(e,(e=>{switch(e.type){case"mousemove":t=je,n=[e.movementX,e.movementY],je=t.map(((e,t)=>e+n[t]));break;case"mousedown":it[e.button]=!0;break;case"mouseup":it[e.button]=!1}var t,n}))));let a=We(),[i,l]=Me(t,Dt),[c,s]=Me(n,Dt);function f(e){Ye(e),xt(a,[i,l],[c,s],e),bt&&(bt.gain.value=a.vel*Mt*.7,e*a.vel*10>Math.random()&&(Mt=.5+Math.random()),Mt=Mt*(1-e)+e)}console.log(`${Date.now()-e} ms ${l.faces.length} faces`);let u=!1;function m(){return document.pointerLockElement==r}function v(e){null==e&&(e=!m()),e?(r.requestPointerLock(),St(null)):(document.exitPointerLock(),bt&&(bt.gain.value=0),St(a))}r.onclick=e=>{if(v(!0),!u){Ce=Ce||new window.AudioContext,bt=Ue();let e=Date.now();const t=()=>{m()&&f((Date.now()-e)/1e3),e=Date.now(),requestAnimationFrame(t)};t()}u=!0},o.onclick=e=>{let t=e.target.id,[n,r]=t.split("_");switch(n){case"up":a.points>0&&(a.upgrades[r]++,a.points--);break;case"down":a.upgrades[r]>0&&(a.upgrades[r]--,a.points++);break;case"save":Ft(r);break;case"load":zt(r),St(null),f(0),setTimeout((()=>v(!0)),10);break;case"new":We(),St(null),f(0),setTimeout((()=>v(!0)),10)}St(a)},document.onkeydown=e=>{switch(e.code){case"Space":v();break;case"KeyS":Ft(0);break;case"KeyL":zt(0)}},zt(0),f(0),v(!1)}()})();