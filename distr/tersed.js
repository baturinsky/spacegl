(()=>{var t=t=>[...new Array(t)].map(((t,n)=>n)),n=(t,n)=>[...new Array(t)].map(((t,e)=>n?n(e):e)),e=2*Math.PI,r=Math.PI,o=(Math.PI,Math.PI,2**31);function a(t){0<t&&t<1&&(t=~~(t*o));let n=n=>(t=16807*t%2147483647)%n;return e=>-1==e?t:null==e?n(o)/o:n(e)}function i(t,n){let e={};for(let r in t)e[r]=n(t[r],r,t);return e}var l=[[1,0,0],[0,1,0],[0,0,1]],c=(t,n)=>[t[0]*n,t[1]*n,t[2]*n],f=(t,n=1)=>c(t,n/(t=>(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])**.5)(t)),u=(t,n)=>[t[0]+n[0],t[1]+n[1],t[2]+n[2]],s=(t,n)=>[t[0]-n[0],t[1]-n[1],t[2]-n[2]],v=(t,n)=>[t[1]*n[2]-t[2]*n[1],t[2]*n[0]-t[0]*n[2],t[0]*n[1]-t[1]*n[0]],h=(t,n)=>(t=>m(t,t)**.5)(p(t,n)),m=(t,n)=>t.reduce(((t,e,r)=>t+e*n[r]),0),p=(t,n)=>t.map(((t,e)=>t-n[e])),d=t=>[Math.cos(t),Math.sin(t)],g=(t,n,e)=>t.map(((t,r)=>t*(1-e)+n[r]*e)),y=l[1],x=t(16).map((t=>t%5?0:1)),b=(t,n)=>t.map(((e,r)=>{let o=r%4,a=r-o;return n[a]*t[o]+n[a+1]*t[o+4]+n[a+2]*t[o+8]+n[a+3]*t[o+12]})),F=(t,n)=>t.map((t=>n*t)),M=t=>t[0]+t[5]+t[10]+t[15],D=(t,n,...e)=>{const r=F(n,t);return e.length?((t,n)=>t.map(((t,e)=>t+n[e])))(r,D(...e)):r};function w(t){let[n,e,r,o,a,i]=function(t){const n=b(t,t),e=b(t,n),r=b(n,n),o=M(t),a=M(n),i=M(e);return[(o**4-6*a*o*o+3*a*a+8*i*o-6*M(r))/24,n,e,o,a,i]}(t),l=D((o*o*o-3*o*a+2*i)/6,x,-(o*o-a)/2,t,o,e,-1,r);return F(l,1/n)}var P=(t,n,e=y)=>{const r=f(c(n,-1)),o=f(v(e,r)),a=v(o,r);return[o[0],o[1],o[2],0,a[0],a[1],a[2],0,r[0],r[1],r[2],0,t[0],t[1],t[2],1]};function T(t,n){let[e,r,o]=t;const a=Math.sqrt(e*e+r*r+o*o);e/=a,r/=a,o/=a;const i=Math.cos(n),l=Math.sin(n),c=1-i;return[e*e+(1-e*e)*i,e*r*c+o*l,e*o*c-r*l,0,e*r*c-o*l,r*r+(1-r*r)*i,r*o*c+e*l,0,e*o*c+r*l,r*o*c-e*l,o*o+(1-o*o)*i,0,0,0,0,1]}function A(t,n){const[e,r,o]=n,a=e*t[3]+r*t[7]+o*t[11]+t[15];return[(e*t[0]+r*t[4]+o*t[8]+t[12])/a,(e*t[1]+r*t[5]+o*t[9]+t[13])/a,(e*t[2]+r*t[6]+o*t[10]+t[14])/a]}var E=t=>[1,0,0,0,0,1,0,0,0,0,1,0,t[0],t[1],t[2],1];function S(t,n,[e,o]){const a=r/4,i=e/o,c=((t,n,e=y)=>P(t,s(n,t),e))(t,u(t,n),l[2]),f=((t,n,e,r)=>{const o=1/Math.tan(.5*t),a=1/(e-r);return[o/n,0,0,0,0,o,0,0,0,0,(e+r)*a,-1,0,0,e*r*a*2,0]})(a,i,5,3e3);return b(f,w(c))}var z=3553,k=5126,L=36160,_={at:[3],norm:[3],cell:[3]};function $(t){for(let n of t.faces)(null==n[2].norm||Number.isNaN(n[2].norm[0]))&&(n[2].norm=f(v(s(n[1].at,n[2].at),s(n[0].at,n[2].at))))}function B(t){let n=0;return[0,...t.map((t=>n+=t.length))]}function C(t,n=(t=>new Array(t))){const e=B(t);let r,o=n(e[t.length]);for(let n=t.length-1;n>=0;n--){r=0==n?0:e[n];for(let e=t[n].length-1;e>=0;e--)o[r+e]=t[n][e]}return o}var U,N=(t,n)=>(e,r)=>[t[e%t.length][0]*n[r][0],t[e%t.length][1]*n[r][0],n[r][1]],R=(t,n)=>q(t,n,N),q=(t,n,e)=>function(t,n,e){let r=new Array(t*n*2),o=new Array((t+1)*(n+1)),a=t+1;for(let r=0;r<=t;r++)for(let t=0;t<=n;t++)o[t*a+r]={at:e(r,t),cell:[r,t,0],ind:t*a+r};for(let e=0;e<t;e++)for(let i=0;i<n;i++){const n=2*(i*t+e),l=i*a+e;r[n]=[o[l+1+a],o[l+a],o[l]],r[n+1]=[o[l+1],o[l+1+a],o[l]]}return{faces:r,verts:o}}(t.length,n.length-1,e(t,n)),V=(t,n)=>C(t.map(((e,r)=>{let o=t[(r+1)%t.length],a=h(e,o),i=n/a;return[g(e,o,i),g(e,o,1-i)]})));function O(t,n){let e=`#version 300 es\nprecision highp float;\nprecision highp int;\n\n${n}`;const r=U.createShader(t);U.shaderSource(r,e),U.compileShader(r);{const t=U.getShaderInfoLog(r);t&&(console.log("shader:",t),console.log(e.split("\n").map(((t,n)=>`${n+1}. ${t}`)).join("\n")))}return r}function Q(t,n){var e=U.createProgram();return U.attachShader(e,O(35633,t)),U.attachShader(e,O(35632,n)),U.linkProgram(e),e}var X=[5121,6408],Y=[5123,6402,33189];function j(t,[n,e]){return t.map((t=>function(t,n,e,r){const o=U.createTexture();return U.bindTexture(z,o),U.texImage2D(z,0,e[2]||e[1],t,n,0,e[1],e[0],r),U.texParameteri(z,10241,9728),U.texParameteri(z,10240,9728),U.bindTexture(z,null),{texture:o,format:e}}(n,e,t)))}var H={5124:"i",5124:"ui",5125:"f",35665:"f",35676:"Matrix4fv"};function G(t){const n={};for(let e=0;e<U.getProgramParameter(t,U.ACTIVE_UNIFORMS);++e){const r=U.getActiveUniform(t,e);let o=H[r.type]||"i";const a=U.getUniformLocation(t,r.name);o.indexOf("Matrix")>=0?n[r.name]=(...t)=>U[`uniform${o}`](a,!1,...t):n[r.name]=(...t)=>{t[0].length>0&&(t=t[0]),U[`uniform${t.length}${o}`](a,...t)}}return n}function J(t,n){for(let e in n)t[e]&&t[e](n[e])}function K(t,n,e,r=3,o=5126){let a=U.getAttribLocation(t,n);U.enableVertexAttribArray(a),U.bindBuffer(34962,e),U.vertexAttribPointer(a,r,o,!1,0,0)}function W(){return U.createBuffer()}function Z(t,n,e=34962){U.bindBuffer(e,t),U.bufferData(e,n,35044)}function tt(t,n){let e=function(t,n){let e=t.length,r=B(t.map((t=>t.faces))),o=B(t.map((t=>t.verts))),a=new Uint32Array(3*r[e]),l=i(n,(t=>t[1]&&t[1]!=k?new Int32Array(o[e]*t[0]):new Float32Array(o[e]*t[0]))),c=0;t.forEach(((t,n)=>{for(let e of t.faces){const t=o[n];a[c++]=e[0].ind+t,a[c++]=e[1].ind+t,a[c++]=e[2].ind+t}}));for(let e in l){let r=n[e][0],o=l[e],a=0;if(1==r)for(let n of t)for(let t of n.verts)t[e]&&(o[a]=t[e]),a++;else for(let n of t)for(let t of n.verts)t[e]&&o.set(t[e],a*r),a++}return{faces:a,verts:l}}(t,n),r=function(t=_){return{faces:W(),verts:i(t,(t=>W())),attrs:t}}(n);return function(t,n){Z(t.faces,n.faces,34963);for(let e in n.verts)Z(t.verts[e],n.verts[e])}(r,e),[r,e]}var nt=(t,...n)=>{for(let e of n)for(let n of t.verts)n.at=A(e,n.at)};function et(t,n){let[e,r]=tt(t,{at:[3],norm:[3],cell:[3],type:[4],shape:[1]});return function(t,n){for(let e in t.verts)K(n,e,t.verts[e],t.attrs[e][0],t.attrs[e][1]||k)}(e,n),[e,r]}function rt(){let r=function(){let t=[],r=a(1);const o=70,i=70,c=400,f=40,u=o*i;function s(t,o){let[a,i]=m(r);a=a.map((n=>[n[0]*t,n[1]*t]));let l,c=r(4)+4;l=n(c,(t=>(t=>n=>d(e/t*n))(c)(t))),r(3)||(l=((t,n)=>C(t.map(((e,r)=>{let o=t[(r+1)%t.length];return[g(e,o,n),g(e,o,1-n)]}))))(l,.1)),0==r(4)&&l.forEach((t=>t[1]+=.95));let f=q(l,a,N);for(let t of f.verts)t.type=i[t.cell[1]],t.shape=o;return f}function v(){let t=[];for(let n=0;n<u;n++)if(r(3)){let e=s(15*r()+5,n);t[n]=e}return t}function h(t,n){for(let r=0;r<t.length;r++){let o=r%i/i*e;nt(t[r],T(l[2],n()*e),E([0,f*(r/i+1),-c]),T(l[1],o))}}const m=t=>{let[n,e]=[1,0],r=[[0,0],[n,0]],o=[[0,0,0,0]],a=2,i=0,l=[t(4),t(4),t(4),t(4)].reduce(((t,n)=>16*t+n));let c=[t()+.3,t()+.3];for(;n>.2&&e<10&&(e<3||t(3)||r.length<4);){let f=a>1?0:n*(.1+.5*t())*(t(4)?-1:1);n+f>1&&(f=-f);let u=a*(n+i++/10)*(t()+.3)**2;e<3&&u>0&&u++,n+=f,e+=u,r.push([n,e]);let s=~~(10*u*c[0]),v=~~(20*n*c[1]);o.push([2,256*s+v,0==f?l:l&&-1281,0]);let h=t(3);a=0==h&&0==a?2:h}return r.push([0,e+t(2)]),o.push([2,2056,57344,0]),[r,o]};function p(){v(),h(t,r)}p();let y=(x=o,b=c,F=1.1*c,M=i*f,R(n(x,(t=>d(t/(x-1)*e))),[[b,0],[F,0],[F,M],[b,M],[b,0]]));var x,b,F,M;for(let t of y.verts)t.type=[4,0,0,0];return nt(y,T(l[0],-Math.PI/2)),t.push(y),t}(),o=function(){let n=R(V([[0,-4],[7,-5],[0,3],[-7,-5]],2),[[0,0],[.8,0],[1,.5],[1,1],[.8,1.5],[0,1.5]]);nt(n,E([0,13,5]));let e=R(V([[3,-4],[0,10],[-3,-4]],2),[[0,1],[.8,1],[1,2],[1,3],[.4,4],[0,4]]);nt(e,E([0,12,4]));let r=(o=[e,n],(a={faces:C(o.map((t=>t.faces))),verts:C(o.map((t=>t.verts)))}).verts.forEach(((t,n)=>t.ind=n)),a);var o,a;for(let t of r.verts)t.type=[3,0,0,0];return nt(r,(n=>t(16).map((t=>15==t?1:t%5?0:n)))(.25),T([0,-1,0],Math.PI),T([-1,0,0],Math.PI/2),E([0,3,0])),r}();return r.push(o),function(t){for(let n of t)$(n)}(r),r}var ot,at,it,lt,ct,ft,ut,st={fMain:"uniform float t;\nuniform vec3 sun;\n\nin vec3 vcell;\nin vec3 vat;\n\nflat in vec3 vnorm;\nflat in vec4 vcolor;\n\nflat in ivec4 vtype;\nflat in int vshape;\n\nlayout(location = 0) out vec4 c0;\nlayout(location = 1) out vec4 c1;\n\nfloat hexDigitF(int n, int place) {\n  return float((n >> (place * 4)) & 15) / 15.;\n}\n\nint hex2Digit(int n, int place) {\n  return (n >> (place * 8)) % 256;\n}\n\nvoid main() {\n  //vec4 worldAt = \n  vec3 toSun = sun - vat;\n  float light = dot(vnorm, normalize(toSun)) * 0.45 + .45 + length(toSun) / 3000.;\n  int itype = vtype.x;\n  int t1 = vtype.y;\n  int t2 = vtype.z;\n  //vt = 2.0101000000;\n  if(itype == 2) {\n    float cols = float(hex2Digit(t1, 0));\n    float rows = float(hex2Digit(t1, 1));\n    float hm = hexDigitF(t2, 0);\n    float vm = hexDigitF(t2, 1);\n    float hb = hexDigitF(t2, 2);\n    float vb = hexDigitF(t2, 3);\n    float x = fract(vcell.x);\n    float y = fract(vcell.y);\n    light += x > hm &&\n      x < 1. - hm &&\n      y > vm &&\n      y < 1. - vm &&\n      fract((x - hm * 0.5) / (1. - hm) * cols) > hb &&\n      fract((y - vm * 0.5) / (1. - vm) * rows) > vb ? -1. : .0;\n  }\n\n  if(light > 0.)\n    light += vcell.y * 0.05 - 0.3;\n  /*if(mod(vcell.x,0.2)<0.1 != mod(vcell.y,0.2)<0.1)\n    light /= 2.;*/\n  //c0 = vec4(light, 0., 0., 1.);\n  c0 = vec4(vcolor.rgb * light, vcolor.a);\n  //c1 = vec4(gl_FrontFacing?0.:1.,0.,0.,0.);\n  c1 = vec4(vat / 1000. + 0.5, 1.);\n  //c1 = vec4(1.,0.,0.,1.);\n}\n",vMain:"uniform mat4 camera;\r\nuniform mat4 flyer;\r\n\r\nin vec3 at;\r\nin vec3 norm;\r\nin vec3 cell;\r\nin vec4 type;\r\nin float shape;\r\n\r\nout vec3 vcell;\r\nout vec3 vat;\r\n\r\nflat out vec3 vnorm;\r\nflat out vec4 vcolor;\r\n\r\nflat out ivec4 vtype;\r\nflat out int vshape;\r\n\r\nvoid main() {\r\n  vat = at;\r\n  vnorm = norm;\r\n  vcell = cell;\r\n  \r\n  vtype = ivec4(type);\r\n  vshape = int(shape);\r\n\r\n  vec4 at4 = vec4(at, 1.);\r\n\r\n  //int si = int(shape);\r\n\r\n  if(vshape > 0)\r\n    //vcolor.rgb = vec3(shape/10000., mod(shape,100.)/100., mod(shape,10.)/10.) * 1.5;\r\n    vcolor.rgb = vec3(1.);\r\n  else\r\n    vcolor.rgb = vec3(.9);\r\n  //color = vec4(1., 1., 0., 1.);\r\n\r\n  if(vtype.x == 3 ){\r\n    at4 = flyer * at4;\r\n    mat4 fnorm = flyer;\r\n    fnorm[3] = vec4(0.);\r\n    vnorm = (fnorm * vec4(norm,1.)).xyz;\r\n  }\r\n\r\n  vec4 pos = camera * at4;\r\n  vat = at4.xyz;\r\n  pos.y = -pos.y;\r\n\r\n  gl_Position = pos;\r\n}",fScreen:"uniform sampler2D T0;\nuniform sampler2D T1;\nuniform sampler2D Depth;\nuniform mat4 invCamera;\n\nin vec2 uv;\n\nout vec4 color;\n\nint b16[16] = int[] (1, 9, 3, 11, 13, 5, 15, 7, 4, 12, 2, 10, 16, 8, 14, 6);\nint b64[64] = int[] (1, 33, 9, 41, 3, 35, 11, 43, 49, 17, 57, 25, 51, 19, 59, 27, 13, 45, 5, 37, 15, 47, 7, 39, 61, 29, 53, 21, 63, 31, 55, 23, 4, 36, 12, 44, 2, 34, 10, 42, 52, 20, 60, 28, 50, 18, 58, 26, 16, 48, 8, 40, 14, 46, 6, 38, 64, 32, 56, 24, 62, 30, 54, 22);\n\nfloat dither(float v, ivec2 F) {\n  return v * 75. > float(b64[F.y % 8 * 8 + F.x % 8]) ? 1. : 0.;\n}\n\nvoid main() {\n  ivec2 F = ivec2(gl_FragCoord.xy);\n  float depth = texelFetch(Depth, F, 0).r;\n  color = vec4(1.);\n\n  if(depth == 1.) {\n    //color = vec4(texelFetch(T1, F, 0).rgb, 1.);\n    vec4 pos4 = invCamera * vec4(uv * 2. - 1., depth * 2. - 1., 1.);\n    vec3 pos = (pos4 / pos4.w).xyz;\n    pos = pos / length(pos);\n    //color.xyz = vec3(sin((pos.x + pos.y)*1e1)>0.9?1.:0.);\n    //color.xyz = pos / 100.;\n    float a = atan(pos.x, pos.y);\n    color.xyz = sin(pos.x * 5e2) > 0.95 || sin(pos.y * 5e2) > 0.95 || sin(pos.z * 5e2) > 0.95 ? pos*0.5 + 0.5 : vec3(0.);\n\n    //color = vec4(uv, depth, 1.);\n  } else {\n    color = texelFetch(T0, F, 0);\n\n    float diff = 0.;\n    for(int i = 0; i < 8; i++) {\n      int step = i / 4;\n      float edge = texelFetch(Depth, F + ivec2(i % 2, i % 4 / 2) * step, 0).r + texelFetch(Depth, F - ivec2(i % 2, i % 4 / 2) * step, 0).r - depth * 2.;\n      diff += abs(edge);\n    }\n\n    if(diff > .00007) {\n      //lut = lit>0.1?0.:1.;\n      color.rgb = normalize(color.rgb) * 0.3;\n    } else {\n      color.r = dither(color.r, F);\n      color.g = dither(color.g, F);\n      color.b = dither(color.b, F);\n      //lit = lit * 15. > float(b16[F.y % 4 * 4 + F.x % 4]) ? 1. : 0.;\n      //lut = lit;\n    }\n\n    if(depth > 0.99 && (depth - 0.99) * 2000. > float(b64[F.y % 8 * 8 + F.x % 8])) {\n      color = vec4(1.);\n    }\n\n    /*if(depth > 0.99){\n      color.rgb += (depth - 0.99) * 10.;\n    }*/\n\n  }\n\n  //color = vec4(texelFetch(T1, F, 0).rgb, 1.);\n\n  //c.rgb = texelFetch(T0, F, 0).rgb;\n\n  /*if(texelFetch(T1, F, 0).r == 1.)\n    c.rgb = vec3(0., 0., 1.);*/\n  color.a = 1.;\n}",vScreenQuad:"out vec2 uv;\n\nvoid main() {\n  int i = gl_VertexID;\n  ivec2 uvi = ivec2(i % 2, (i + 1) % 4 / 2);\n  gl_Position = vec4(uvi.x * 2 - 1, 1 - uvi.y * 2, 0, 1);\n  uv = vec2(uvi);\n  //gl_Position = vec4(i%2*2-1, 1-(i+1)%4/2*2, 0., 1.);\n}"};function vt(t){let n=document.getElementById("C");return ut=t,n.width=ut[0],n.height=ut[1],(U=n.getContext("webgl2")).enable(2929),ot=Q(st.vMain,st.fMain),it=G(ot),at=Q(st.vScreenQuad,st.fScreen),lt=G(at),ct=j([X,X,Y],ut),ft=function(t){const n=U.createFramebuffer();U.bindFramebuffer(L,n);for(let n=0;n<t.length;n++){let e=t[n].format[1],r=34041==e?33306:6402==e?36096:36064+n;U.framebufferTexture2D(L,r,z,t[n].texture,0)}return U.bindFramebuffer(L,null),n}(ct),[ot,n]}function ht(t,[n,e]){I.innerHTML=t.rot;let r=S(u(u(t.pos,c(t.dir,-5)),[0,0,0]),t.dir,ut),o=w(r),a=(t.dir,P(t.pos,t.dir,[0,0,1]));a=b(a,T([0,0,1],-t.smoothDrot[0]*Math.PI/4/100)),a=b(a,T([1,0,0],-t.smoothDrot[1]*Math.PI/4/200)),U.useProgram(ot),J(it,{camera:r,flyer:a,sun:f([0,1e3,0])}),U.bindFramebuffer(L,ft),U.clear(16640),U.drawBuffers([36064,36065]),U.bindBuffer(U.ELEMENT_ARRAY_BUFFER,n.faces),U.drawElements(4,e.faces.length,5125,0),U.useProgram(at),J(lt,{invCamera:o}),function(t,n){for(let e=0;e<t.length;e++)U.activeTexture(U.TEXTURE0+e),n[e]&&n[e](e),U.bindTexture(z,t[e].texture)}(ct,[lt.T0,lt.T1,lt.Depth]),U.bindFramebuffer(L,null),U.drawArrays(4,0,6),U.flush()}var mt,pt=Math.PI/180,dt=[90,0],gt=[0,0];a(Math.random());!function(){let t=Date.now(),n=rt(),[e,r]=vt([1600,900]);["keydown","keyup","mousedown","mouseup","mousemove"].forEach((t=>document.addEventListener(t,(t=>{switch(t.type){case"mousemove":n=gt,e=[t.movementX,t.movementY],gt=n.map(((t,n)=>t+e[n]));break;case"mousedown":mt.vel*=0==t.button?2:.5}var n,e}))));let o=mt={dir:[1,0,0],pos:[0,-300,0],vel:.05,time:0,drot:[0,0],smoothDrot:[0,0],rot:dt},[a,i]=et(n,e);function l(t){!function(t){gt=gt.map((n=>Math.sign(n)*Math.min(30,Math.abs(n)*t*60))),mt.drot[0]=mt.drot[0]-.1*gt[0],mt.drot[1]=Math.max(-89.999,Math.min(89.999,mt.drot[1]-.1*gt[1]));let n=Math.min(1,.01*t);var e,r,o;mt.smoothDrot=mt.smoothDrot.map(((t,e)=>t*(1-n)+mt.drot[e]*n)),mt.rot=(e=mt.rot,r=mt.smoothDrot,o=.006,e.map(((t,n)=>t+r[n]*o))),mt.rot[1]=Math.max(-89,Math.min(mt.rot[1],89)),mt.smoothDrot=((t,n)=>t.map((t=>t*n)))(mt.smoothDrot,1-.2*n);let[a,i]=mt.rot.map((t=>t*pt));mt.dir=f([Math.cos(i)*Math.cos(a),Math.cos(i)*Math.sin(a),Math.sin(i)]),gt[0],1-10*t,gt=[0,0],mt.vel*=1-0*t;let l=c(mt.dir,mt.vel*t);mt.pos=u(mt.pos,l)}(t),ht(o,[a,i])}console.log(`${Date.now()-t} ms ${i.faces.length} faces`);let s=!1;function v(){return document.pointerLockElement==r}function h(t){null==t&&(t=!v()),t?r.requestPointerLock():document.exitPointerLock()}r.onclick=t=>{if(h(!0),!s){let t=Date.now();const n=()=>{v()&&l(Date.now()-t),t=Date.now(),requestAnimationFrame(n)};n()}s=!0},document.onkeydown=t=>{switch(t.code){case"Space":h()}},l(0)}()})();